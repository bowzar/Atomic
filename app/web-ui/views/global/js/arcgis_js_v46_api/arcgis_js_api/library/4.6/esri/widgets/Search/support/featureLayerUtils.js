// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/Error ../../../core/lang ../../../core/promiseUtils ../../../geometry/support/scaleUtils ./geometryUtils dojo/date/locale".split(" "),function(Q,v,x,G,h,H,y,I){function A(a,b){var c=a.filter,f=a.searchExtent;b=b&&b.extent;a=a.withinViewEnabled&&b?b:void 0;return c&&c.geometry||f||a}function B(a){return a?a.load().then(h.resolve).otherwise(h.reject):h.resolve()}function C(a){return a&&!!a.get("capabilities.query.supportsPagination")}function D(a){var b="";a&&(a=
a.fields)&&a.some(function(a){if("string"===a.type)return b=a.name,!0});return b}function z(a,b){return a&&b?b.every(function(b){return!!a.getField(b)}):!1}function J(a){for(var b=0;b<a.length;b++)if(255<a.charCodeAt(b))return!0;return!1}function K(a,b,c){var f=null;(a=a.codedValues)&&a.some(function(a){var g=a.name,g=c?g:g.toLowerCase();if((c?b:b.toLowerCase())===g)return f=a.code.toString(),!0});return f}function t(a,b){return(b=b&&b.where)?"("+a+") AND ("+b+")":a}function E(a,b,c,f,r){var g="";
if(a){var d=L.test(b.url)&&J(a)?"N":"";c&&c.forEach(function(c){var e=b.getField(c);c=((c=b.getFieldDomain(c))&&"coded-value"===c.type?K(c,a,r):null)||a||null;if(null!==c){var k=e.type,e=e.name;"string"===k||"date"===k?r?e=t(e+" \x3d "+d+"'"+c+"'",f):(c=c.toUpperCase(),e=t("UPPER("+e+") LIKE "+d+"'%"+c+"%'",f)):"oid"===k||"small-integer"===k||"integer"===k||"single"===k||"double"===k?(c=parseFloat(c),e=isNaN(c)?null:t(e+" \x3d "+c,f)):e=t(e+" \x3d "+c,f);e&&(g+=g?" OR ("+e+")":"("+e+")")}})}return g}
function M(a,b){var c=null;(a=a.codedValues)&&a.length&&a.some(function(a){if(a.code===b)return c=a.name,!0});return c}function F(a,b,c,f){var r=a.layer,g=a.attributes;f=r.getFieldDomain(c);return b?G.substitute(g,b):c&&a.hasOwnProperty("attributes")&&g.hasOwnProperty(c)?(a=g[c],c=r.getField(c),f&&"coded-value"===f.type?M(f,a):c&&"date"===c.type?I.format(new Date(a)):a):""}function N(a,b,c,f){return a.features.map(function(a){var g=a.attributes[a.layer.objectIdField];return{text:F(a,b.suggestionTemplate,
f,b),key:g,sourceIndex:c}})}function O(a,b,c,f,h,g,d){return a.features.map(function(a){var e=a.clone();a=F(a,c.searchTemplate,h,c);var k=y.createExtentFromGeometry(e.geometry,b,g);return{extent:d?y.scaleExtent(k.clone(),b,d):k,feature:e,name:a,sourceIndex:f}})}Object.defineProperty(v,"__esModule",{value:!0});var L=/https?:\/\/services.*\.arcgis\.com/i,P=/(?:\{([^}]+)\})/g;v.getResults=function(a){var b=a.exactMatch,c=void 0===b?!1:b,f=a.location,r=a.maxResults,g=a.spatialReference,d=a.source,t=a.sourceIndex,
e=a.suggestResult,k=a.view,l=d.featureLayer,n=d.filter,m=d.zoomScale,q=k&&k.scale,w=A(d,k);return B(l).then(function(){var a=d.displayField||d.featureLayer.displayField||D(d.featureLayer);if(!l.getField(a))return h.reject(new x("searchfeaturelayerutils:invalid-field","displayField is invalid."));var b=d.outFields||[a];if(!(b&&1===b.length&&"*"===b[0]||z(l,b)))return h.reject(new x("searchfeaturelayerutils:invalid-field","outField is invalid."));var p=l.createQuery(),u=d.searchQueryParams;u&&p.set(u);
g&&(p.outSpatialReference=g,u=H.getMetersPerUnitForSR(g))&&(p.maxAllowableOffset=u);p.returnGeometry=!0;b&&(p.outFields=b);if(f)p.geometry=f;else if(e.key)p.objectIds=[parseInt(e.key,10)];else{b=d.searchFields||[a];if(!z(l,b))return h.reject(new x("searchfeaturelayerutils:invalid-field","search field is invalid."));C(l)&&(p.num=r);w&&(p.geometry=w);u=e.text.trim();if(!u)return h.resolve();var v=d.prefix,y=d.suffix,u=(""+(void 0===v?"":v)+u+(void 0===y?"":y)).replace(/\'/g,"''"),b=E(u,l,b,n,c);if(!b)return h.resolve();
p.where=b}return l.queryFeatures(p).then(function(b){return O(b,k,d,t,a,q,m)})})};v.getSuggestions=function(a){var b=a.source,c=a.spatialReference,f=a.suggestTerm,r=a.maxSuggestions,g=a.sourceIndex,d=b.featureLayer,v=b.filter,e=A(b,a.view);return B(d).then(function(){if(!C(d))return h.resolve();var a=b.displayField||b.featureLayer.displayField||D(b.featureLayer),l=b.searchFields||[a],n=[];b.suggestionTemplate?b.suggestionTemplate.replace(P,function(a,b){n.push(b);return a}):n.push(a);-1===n.indexOf(d.objectIdField)&&
n.push(d.objectIdField);var m=!!d.getField(a),q=n&&1===n.length&&"*"===n[0]||z(d,n),w=z(d,l);if(!m)return h.reject(new x("searchfeaturelayerutils:invalid-field","displayField is invalid."));if(!q)return h.reject(new x("searchfeaturelayerutils:invalid-field","outField is invalid."));if(!w)return h.reject(new x("searchfeaturelayerutils:invalid-field","search field is invalid."));m=d.createQuery();(q=b.suggestQueryParams)&&m.set(q);m.outSpatialReference=c;m.returnGeometry=!1;m.num=r;m.outFields=n;e&&
(m.geometry=e);q=f.trim();if(!q)return h.resolve();var w=b.prefix,t=b.suffix,q=(""+(void 0===w?"":w)+q+(void 0===t?"":t)).replace(/\'/g,"''"),l=E(q,d,l,v,!1);if(!l)return h.resolve();m.where=l;return d.queryFeatures(m).then(function(c){return N(c,b,g,a)})})}});