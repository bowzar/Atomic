// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../Color ../../../../core/screenUtils ../../../../symbols/callouts/calloutUtils ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./ElevationAligners ./Graphics3DSymbolCommonCode ./graphicUtils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/TextTexture ../../webgl-engine/materials/HUDMaterial".split(" "),function(N,O,w,B,x,E,y,F,G,h,z,H,I,J,C){var D=[1,1,1,1],K=[0,0,1],A={mode:"relative-to-ground",
offset:0},L=[0,0,0,1];return function(q){function c(){var a=null!==q&&q.apply(this,arguments)||this;a._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1};return a}w(c,q);c.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var a=z.validateSymbolLayerSize(this._getTextSize());if(a){this._logWarning(a);this.reject();return}}this._anchor="center";this.resolve()};c.prototype.destroy=function(){q.prototype.destroy.call(this);this.isFulfilled()||this.reject()};
c.prototype.createGraphics3DGraphic=function(a,b,c,r){var e="polyline"===a.geometry.type,h=this._getGeometry(a);if(!h)return this._logWarning("unsupported geometry type for text symbol: "+a.geometry.type),null;var k=this._context.layer.id+"_label_"+a.uid,d=b.text||this.symbol.text;if(!d||1>d.length)return null;b&&null!=b.needsOffsetAdjustment&&(this._elevationOptions.needsOffsetAdjustment=b.needsOffsetAdjustment);var m=this.getGraphicElevationContext(a,b.elevationOffset||0);return this._createAs3DShape(this.symbol,
h,d,m,k,a.uid,b,c,r,e)};c.prototype.getGraphicElevationContext=function(a,b){void 0===b&&(b=0);a=q.prototype.getGraphicElevationContext.call(this,a);a.addOffsetRenderUnits(b);return a};c.prototype._getGeometry=function(a){a=this._validateGeometry(a.geometry);return"polyline"===a.type?h.placePointOnPolyline(a):"polygon"===a.type?h.placePointOnPolygon(a):"extent"===a.type?a.center:"point"!==a.type?null:a};c.prototype.layerPropertyChanged=function(a,b,c){if("opacity"===a)this._logWarning("layer opacity change not yet implemented in Graphics3DTextSymbolLayer");
else if("elevationInfo"===a){this._updateElevationContext();if(b)for(var h in b){a=b[h];var e=c(a);e&&this.updateGraphicElevationContext(a.graphic,e)}return!0}return!1};c.prototype.updateGraphicElevationContext=function(a,b){a=this.getGraphicElevationContext(a,b.metadata.elevationOffset);b.elevationContext.set(a);b.needsElevationUpdates=h.needsElevationUpdates2D(a.mode)||"absolute-height"===a.mode};c.prototype._defaultElevationInfoNoZ=function(){return A};c.prototype._createAs3DShape=function(a,b,
c,r,e,q,k,d,m,f){var t=k.centerOffset||L,n=k.screenOffset||[0,0],u=k.debugDrawBorder||!1,w=k.translation||[0,0,0],v=k.anchor||this._anchor||"center";this._anchor=v;var p=a.material?B.toUnitRGBA(a.material.color):D,l=a.halo&&a.halo.color&&0<a.halo.size,y=l?B.toUnitRGBA(a.halo.color):D,l=l?x.pt2px(a.halo.size):0,z=this._getTextSize(a);a=new J(c,{size:z,color:p,font:{family:a.font&&a.font.family?a.font.family:"Arial",weight:a.font&&a.font.weight?a.font.weight:"normal",style:a.font&&a.font.style?a.font.style:
"normal"},halo:{size:l,color:y}},e);m=(p=m&&m.canHoldTextTexture(a))?m.addTextTexture(a):null;var g;d?g=k:E.isCalloutSupport(this.symbolContainer)&&this.symbolContainer.hasVisibleVerticalOffset()&&(g=this.symbolContainer);n={textureId:p?m.texture.getId():a.getId(),texCoordScale:p?[1,1]:a.getTexcoordScale(),occlusionTest:!0,screenOffset:n,anchorPos:v,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:k.centerOffsetUnits,debugDrawBorder:u,drawInSecondSlot:!0};g&&g.verticalOffset&&(g=g.verticalOffset,
u=g.minWorldLength,v=g.maxWorldLength,n.verticalOffset={screenLength:x.pt2px(g.screenLength),minWorldLength:u||0,maxWorldLength:null!=v?v:Infinity});this._context.screenSizePerspectiveEnabled&&(g=this._context.sharedResources,u=g.screenSizePerspectiveSettings,n.screenSizePerspective=g.screenSizePerspectiveSettingsLabels.overridePadding(l),n.screenSizePerspectiveAlignment=u);f&&(n.shaderPolygonOffset=1E-4);f=null;l=JSON.stringify(n);null!=d?(f=d.getMaterial(l),null==f?(f=new C(n,e),d.addMaterial(l,
f)):p&&f.setTextureDirty()):f=new C(n,e);f=[f];l=[a.getTextWidth(),a.getTextHeight()];t=I.createPointGeometry(K,w,void 0,l,t,m?m.uvMinMax:null);t=[new H(t,e)];e=h.createStageObjectForPoint.call(this,b,t,[f],null,null,r,e,this._context.layer.uid,q,!0);d=new F(this,e.object,t,null==d?f:null,p?null:[a],G.perObjectElevationAligner,r);d.alignedTerrainElevation=e.terrainElevation;d.needsElevationUpdates=h.needsElevationUpdates2D(r.mode)||"absolute-height"===r.mode;var A=p?a.getTextWidth():a.getWidth(),
M=p?a.getTextHeight():a.getHeight();d.getScreenSize=function(a){void 0===a&&(a=Array(2));a[0]=A;a[1]=M;return a};d.metadata={labelText:c,elevationOffset:k.elevationOffset||0};h.extendPointGraphicElevationContext(d,b,this._context.elevationProvider);return d};c.prototype._getTextSize=function(a){return x.pt2px((a||this.symbol).size)||12};return c}(y)});