// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports dojo/Deferred ../../../../core/promiseUtils ../../../3d/support/imageUtils ./SpriteMosaic ./Utils ./CIMSymbolHelper ./SDFHelper ./GlyphSource ./GlyphMosaic".split(" "),function(u,v,n,l,p,q,g,h,m,r,t){var k=[];return function(){function e(){this._rasterizeQueue=new Map;this._spriteMosaic=new q(1024,1024,250);this._glyphSource=new r("https://basemaps.arcgis.com/v1/arcgis/rest/services/World_Basemap/VectorTileServer/resources/fonts/{fontstack}/{range}.pbf");this._glyphMosaic=
new t(1024,1024,this._glyphSource)}Object.defineProperty(e.prototype,"sprites",{get:function(){return this._spriteMosaic},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"glyphs",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0});e.prototype.processItems=function(a){var c=this;if(a.done)return!1;for(;this._spriteMosaic.hasItemsToProcess();)this._spriteMosaic.processNextItem();this._rasterizeQueue.forEach(function(b,e){if(a.done)return!1;var d=c._rasterizeJSON(e);
b.resolve(d);k.push(e)});for(var b=0;b<k.length;b++)this._rasterizeQueue.delete(k[b]);k.length=0;return!0};e.prototype.rasterizeItem=function(a,c){void 0===c&&(c=null);return a?!a.type||"text"!==a.type&&"esriTS"!==a.type?this._rasterizeSpriteSymbol(a).then(function(a){return{spriteMosaicItem:a}}):this._rasterizeTextSymbol(a,c).then(function(a){return{glyphMosaicItems:a}}):l.resolve(null)};e.prototype.bindSpritePage=function(a,c,b,d){d||(d=9729);this._spriteMosaic.bind(a,d,c,b)};e.prototype.bindGlyphsPage=
function(a,c,b){this._glyphMosaic.bind(a,9729,c,b)};e.prototype._rasterizeTextSymbol=function(a,c){return this._glyphMosaic.getGlyphItems(a,c)};e.prototype._rasterizeSpriteSymbol=function(a){var c=this;return!g.isFillSymbol(a)&&!g.isLineSymbol(a)||"solid"!==a.style&&"esriSFSSolid"!==a.style&&"esriSLSSolid"!==a.style&&"none"!==a.style?this._spriteMosaic.has(a)?l.resolve(this._spriteMosaic.getSpriteItem(a)):a.url||a.imageData?p.requestImage(a.url?a.url:"data:"+a.contentType+";base64,"+a.imageData).then(function(b){return c._rasterizeResource(b).then(function(b){return c._addItemToMosaic(a,
b.size,b.anchor,b.image,!g.isMarkerSymbol(a),b.sdf)})}):this._rasterizeResource(a).then(function(b){return c._addItemToMosaic(a,b.size,b.anchor,b.image,!g.isMarkerSymbol(a),b.sdf)}):l.resolve(null)};e.prototype._rasterizeResource=function(a){var c=this;if(this._rasterizeQueue.has(a))return this._rasterizeQueue.get(a).promise;var b=new n(function(){c._rasterizeQueue.has(a)&&c._rasterizeQueue.delete(a)});if(a instanceof HTMLImageElement){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas"));
this._rasterizationCanvas.width=a.width;this._rasterizationCanvas.height=a.height;var d=this._rasterizationCanvas.getContext("2d");d.drawImage(a,0,0,a.width,a.height);for(var d=d.getImageData(0,0,a.width,a.height),d=new Uint8Array(d.data),e=void 0,f=0;f<d.length;f+=4)e=d[f+3]/255,d[f]*=e,d[f+1]*=e,d[f+2]*=e;b.resolve({size:[a.width,a.height],anchor:[0,0],image:new Uint32Array(d.buffer),sdf:!1})}else d=this._rasterizeJSON(a),b.resolve(d);return b.promise};e.prototype._addItemToMosaic=function(a,c,
b,d,e,f){return this._spriteMosaic.addSpriteItem(a,c,b,d,e,f)};e.prototype._rasterizeJSON=function(a){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas"));if("simple-fill"===a.type||"esriSFS"===a.type){var c=h.SymbolHelper.rasterizeSimpleFill(this._rasterizationCanvas,a.style);a=c[0];var b=c[1],c=c[2];return{size:[b,c],anchor:[0,0],image:new Uint32Array(a.buffer),sdf:!1}}if("simple-line"===a.type||"esriSLS"===a.type)return c=h.SymbolHelper.rasterizeSimpleLine(this._rasterizationCanvas,
a.style),a=c[0],b=c[1],c=c[2],{size:[b,c],anchor:[0,0],image:new Uint32Array(a.buffer),sdf:!0};"simple-marker"===a.type||"esriSMS"===a.type?(a=h.CIMSymbolHelper.fromSimpleMarker(a),b=!0):b=m.SDFHelper.checkSDF(a);if(b)return b=(new m.SDFHelper).buildSDF(a),a=b[0],{size:[b[1],b[2]],anchor:[0,0],image:new Uint32Array(a.buffer),sdf:!0};var d=h.CIMSymbolHelper.rasterize(this._rasterizationCanvas,a);a=d[0];b=d[1];c=d[2];return{size:[b,c],anchor:[d[3],d[4]],image:new Uint32Array(a.buffer),sdf:!1}};return e}()});