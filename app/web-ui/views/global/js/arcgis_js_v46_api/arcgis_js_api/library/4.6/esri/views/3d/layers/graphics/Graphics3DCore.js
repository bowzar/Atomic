// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/watchUtils ../../../../core/arrayUtils ../../../../core/Error ../../../../core/Logger ../../../../core/promiseUtils ../../support/projectionUtils ../../../../renderers/UniqueValueRenderer ../../../../renderers/support/rendererConversion ../../../../renderers/support/diffUtils ../../../../geometry/Point ../../../../geometry/Extent ../../webgl-engine/Stage ../../webgl-engine/lib/Util ../../webgl-engine/lib/Layer ../../webgl-engine/lib/FloatingBoxLocalOriginFactory ../../../../symbols/WebStyleSymbol ../../../../symbols/LabelSymbol3D ../../../../symbols/TextSymbol ../../../../symbols/support/symbolConversion ../../../../symbols/support/unitConversionUtils ../../lib/glMatrix ./featureExpressionInfoUtils ./Graphics3DGraphic ./Graphics3DWebStyleSymbol ./graphicUtils ./Graphics3DSymbolFactory ./Graphics3DOwner ./ElevationQuery ../../support/aaBoundingBox ../../support/mathUtils dojo/Deferred".split(" "),
function(A,da,H,I,x,J,B,K,L,t,v,M,N,O,P,y,Q,C,R,S,D,T,E,U,F,w,V,W,X,Y,Z,aa,ba,r,ca){function G(d){(d=d.elevationInfo&&d.elevationInfo.unit)&&!U.supportsUnit(d)&&q.warn("elevationInfo.unit","'"+d+"' is not a valid unit")}A=F.vec3d;var u=new O,z=A.create(),q=K.getLogger("esri.views.3d.layers.graphics.Graphics3DCore");return function(){function d(a){void 0===a&&(a=!0);this.elevationFeatureExpressionEnabled=a;this.graphics={};this.graphicsDrapedIds={};this.graphicsBySymbol={};this.graphicsKeys=[];this.symbols=
{};this.graphicsWithoutSymbol={};this.computedExtent=null;this.symbolCreationContext=new Z.Graphics3DSymbolCreationContext;this.hasDraped=!1;this.updatingGraphicIds=new Set;this.graphicTransformFunc=this.onComputedExtentChange=this.stage=this.labelStageLayer=this.stageLayer=this.tilingSchemeHandle=this.lastFastUpdate=null;this.eventHandles=[];this.sharedSymbolResourcesOwnerHandle=this.highlights=this.elevationQueryService=this.labeling=this.spatialIndex=this.scaleVisibility=this.elevation=this.layer=
this.layerView=this.viewSR=null;this.whenGraphics3DGraphicRequests={}}d.prototype.initialize=function(a,b,c,f,e,l,g,h,k,p){var m=this;this.layerView=a;this.layer=b;this.viewSR=a.view.spatialReference;this.elevation=c;this.scaleVisibility=f;this.spatialIndex=e;this.labeling=l;this.highlights=g;this.onComputedExtentChange=h;this.graphicTransformFunc=k;var n=this.layerView.view;this.elevationQueryService=new aa.ElevationQuery(this.viewSR,function(){return n.map.ground},{maximumAutoTileRequests:4});this.initializeStage(n,
this.layer.uid);this.symbolCreationContext.sharedResources=n.sharedSymbolResources;this.sharedSymbolResourcesOwnerHandle=n.sharedSymbolResources.addGraphicsOwner(this);this.symbolCreationContext.renderer=this.layer.renderer;this.symbolCreationContext.stage=this.stage;this.symbolCreationContext.streamDataSupplier=n.sharedSymbolResources.streamDataSupplier;this.symbolCreationContext.renderSpatialReference=n.renderSpatialReference;this.symbolCreationContext.renderCoordsHelper=n.renderCoordsHelper;this.symbolCreationContext.layer=
this.layer;this.symbolCreationContext.layerView=this.layerView;this.symbolCreationContext.layerOrder=0;this.symbolCreationContext.localOriginFactory=d.createLocalOriginFactory();this.symbolCreationContext.elevationProvider=n.elevationProvider;G(this.layer);b=w.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=w.createContext(b,this.viewSR,q);n.deconflictor.addGraphicsOwner(this);this.symbolCreationContext.screenSizePerspectiveEnabled=
n.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;this.tilingSchemeHandle=x.when(p,"tilingScheme",function(a){a.spatialReference.equals(m.symbolCreationContext.overlaySR)||(m.symbolCreationContext.overlaySR=p.spatialReference,m.recreateAllGraphics())});this.eventHandles.push(this.layerView.watch("suspended",function(){return m.suspendedChange()}));this.eventHandles.push(this.layerView.watch("layer.screenSizePerspectiveEnabled,view.screenSizePerspectiveEnabled",function(){m.symbolCreationContext.screenSizePerspectiveEnabled=
n.screenSizePerspectiveEnabled&&m.layer.screenSizePerspectiveEnabled;m.recreateAllGraphics()}));this.eventHandles.push(x.on(a,"loadedGraphics","change",function(a){return m.graphicsCollectionChanged(a)},function(){m.clearSymbolsAndGraphics();m.graphicsCollectionChanged({added:m.layerView.loadedGraphics.toArray(),removed:[]})}));this.validateRenderer(this.layer.renderer)};d.prototype.destroy=function(){var a=this;this.layerView.view.deconflictor.removeGraphicsOwner(this);this.clear();if(this.stage){var b=
[this.stageLayer.getId()];this.labelStageLayer&&b.push(this.labelStageLayer.getId());this.stage.removeFromViewContent(b);b.forEach(function(b){return a.stage.remove(y.ModelContentType.LAYER,b)});this.stage=this.labelStageLayer=this.stageLayer=null}this.tilingSchemeHandle&&(this.tilingSchemeHandle.remove(),this.tilingSchemeHandle=null);this.eventHandles.forEach(function(a){return a.remove()});this.layerView=this.labeling=this.scaleVisibility=this.viewSR=this.onComputedExtentChange=this.eventHandles=
null;for(var c in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[c].reject(new B("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null;this.sharedSymbolResourcesOwnerHandle&&(this.sharedSymbolResourcesOwnerHandle.remove(),this.sharedSymbolResourcesOwnerHandle=null)};d.prototype.clear=function(){var a=!1,b;for(b in this.graphics){var c=this.graphics[b],a=a||c.isDraped();c.destroy()}this.graphics={};this.graphicsKeys=null;for(var f in this.symbols)(b=
this.symbols[f])&&b.destroy();this.symbols={};this.graphicsBySymbol={};this.graphicsWithoutSymbol={};this.hasDraped=!1;a&&this.layerView._notifyDrapedDataChange()};d.prototype.initializeStage=function(a,b){this.stage=a._stage;this.stageLayer=new C(b,{state:this.layerView.suspended?"HIDDEN":"VISIBLE"},b);this.stage.add(y.ModelContentType.LAYER,this.stageLayer);a=[this.stageLayer.getId()];this.labeling&&(this.labelStageLayer=new C(b,{state:this.layerView.suspended?"HIDDEN":"IGNORED"},b+"_labels"),this.stage.add(y.ModelContentType.LAYER,
this.labelStageLayer),a.push(this.labelStageLayer.getId()));this.stage.addToViewContent(a)};d.prototype.setDrawingOrder=function(a){this.symbolCreationContext.layerOrder=a;var b={},c={},f;for(f in this.graphics)this.graphics[f].setDrawOrder(a,b,c);for(var e in c)(c=this.symbols[e])&&c.setDrawOrder(a,b);Q.objectEmpty(b)||(this.stage.getTextureGraphicsRenderer().updateRenderOrder(b),this.layerView._notifyDrapedDataChange())};d.prototype.suspendedChange=function(){!0===this.layerView.suspended?(this.stageLayer.setState("HIDDEN"),
this.labelStageLayer&&this.labelStageLayer.setState("HIDDEN"),this.hideAllGraphics()):!1===this.layerView.suspended&&(this.stageLayer.setState("VISIBLE"),this.labelStageLayer&&this.labelStageLayer.setState("IGNORED"),this.updateAllGraphicsVisibility())};d.prototype.getGraphics3DGraphics=function(){return this.graphics};d.prototype.getGraphics3DGraphicById=function(a){return this.graphics[a]};d.prototype.getGraphics3DGraphicsKeys=function(){null===this.graphicsKeys&&(this.graphicsKeys=Object.keys(this.graphics));
return this.graphicsKeys};d.prototype.labelsEnabled=function(){return!(!this.labeling||!this.labeling.layerLabelsEnabled())};d.prototype.getSymbolUpdateType=function(){var a=0,b=0,c=0,f;for(f in this.symbols){var e=this.symbols[f];e&&(e=e.getFastUpdateStatus(),a+=e.loading,c+=e.fast,b+=e.slow)}return 0<a?"unknown":0<=c&&0===b?"fast":0<=b&&0===c?"slow":"mixed"};d.prototype.numNodesUpdating=function(){return this.updatingGraphicIds.size};d.prototype.needsIdleUpdate=function(){return!!this.lastFastUpdate&&
500<performance.now()-this.lastFastUpdate};d.prototype.idleUpdate=function(a){a.done()||(this.lastFastUpdate&&(this.labeling&&this.labeling.updateLabelingInfo(),this.lastFastUpdate=null),this.layerView._evaluateUpdatingState())};d.prototype.whenGraphics3DGraphic=function(a){var b=this.graphics[a.uid];if(b)return L.resolve(b);b=this.whenGraphics3DGraphicRequests[a.uid];b||(b=new ca,this.whenGraphics3DGraphicRequests[a.uid]=b);return b.promise};d.prototype.boundsForGraphics3DGraphic=function(a){return I(this,
void 0,void 0,function(){var b,c,f,e,d,g,h,k,p;return H(this,function(l){switch(l.label){case 0:return b=this.layerView.view.spatialReference,c=this.layerView.view.renderSpatialReference,f=this.layerView.view.basemapTerrain.spatialReference,e=function(a,e,f){return t.bufferToBuffer(a,c,e,a,b,e,f)},d=function(a,c,e){return t.bufferToBuffer(a,f,c,a,b,c,e)},[4,a.getProjectedBoundingBox(e,d,this.elevationQueryService)];case 1:g=l.sent();if(!g)return[2,null];h=g.boundingBox;g.requiresDrapedElevation&&
(k=this.symbolCreationContext.elevationProvider)&&(ba.center(h,z),u.x=z[0],u.y=z[1],u.z=void 0,u.spatialReference=b,p=k.getElevation(u)||0,h[2]=Math.min(h[2],p),h[5]=Math.max(h[5],p));return[2,{boundingBox:h,screenSpaceObjects:g.screenSpaceObjects}]}})})};d.prototype.whenGraphicBounds=function(a){var b=this;return x.whenOnce(this.layerView,"loadedGraphics").then(function(){var c=b.layerView.layer&&b.layerView.layer.objectIdField,f=b.layerView.loadedGraphics.find(function(b){return b===a||c&&b.attributes&&
a.attributes&&b.attributes[c]===a.attributes[c]?!0:!1});if(f)return b.whenGraphics3DGraphic(f);throw new B("internal:graphic-not-part-of-view","Graphic is not part of this view");}).then(function(a){return b.boundsForGraphics3DGraphic(a)})};d.prototype.graphicsCollectionChanged=function(a){var b=this.graphicTransformFunc?this.graphicTransformFunc(a.added):a.added;this.add(b);this.remove(a.removed)};d.prototype.graphicUpdateHandler=function(a){var b=this.graphics[a.graphic.uid];if(b)switch(a.property){case "visible":b.setVisibilityFlag(0,
a.newValue)&&(b.isDraped()&&this.layerView._notifyDrapedDataChange(),this.labeling&&this.layerView.view.deconflictor.setDirty())}};d.prototype.beginGraphicUpdate=function(a){this.updatingGraphicIds.add(a.uid);"symbolsUpdating"in this.layerView&&!this.layerView.get("symbolsUpdating")&&this.layerView.set("symbolsUpdating",!0);this.layerView._evaluateUpdatingState()};d.prototype.endGraphicUpdate=function(a){a&&this.updatingGraphicIds.delete(a.uid);"symbolsUpdating"in this.layerView&&this.layerView.get("symbolsUpdating")&&
0===this.updatingGraphicIds.size&&(this.layerView.view.flushDisplayModifications(),this.layerView.set("symbolsUpdating",!1));this.layerView._evaluateUpdatingState()};d.prototype.expandComputedExtent=function(a){var b,c,f,e,l,g;if("point"===a.type)b=c=a.x,f=e=a.y,a.z&&(l=g=a.z);else if("polygon"===a.type||"polyline"===a.type||"multipoint"===a.type){g=a.extent;if(!g)return;b=g.xmin;c=g.xmax;f=g.ymin;e=g.ymax;l=g.zmin;g=g.zmax}var h=this.viewSR,k=d.tmpVec;!a.spatialReference.equals(h)&&t.xyzToVector(b,
f,0,a.spatialReference,k,h)&&(b=k[0],f=k[1],t.xyzToVector(c,e,0,a.spatialReference,k,h),c=k[0],e=k[1]);if(r.isFinite(b)&&r.isFinite(c)&&r.isFinite(f)&&r.isFinite(e)){(h=this.computedExtent)?(b<h.xmin&&(h.xmin=b),c>h.xmax&&(h.xmax=c),f<h.ymin&&(h.ymin=f),e>h.ymax&&(h.ymax=e)):this.computedExtent=h=new P(b,f,c,e,a.spatialReference);if(r.isFinite(l)&&!r.isFinite(g)){if(null==h.zmin||l<h.zmin)h.zmin=l;if(null==h.zmax||g>h.zmax)h.zmax=g}this.onComputedExtentChange&&this.onComputedExtentChange()}};d.prototype.updateHasDraped=
function(){this.hasDraped=!1;for(var a in this.graphicsDrapedIds)if(this.graphicsDrapedIds.hasOwnProperty(a)){this.hasDraped=!0;break}};d.prototype.elevationInfoChange=function(){G(this.layer);var a=w.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=w.createContext(a,this.viewSR,q);this.labeling&&this.labeling.elevationInfoChange();this.layer.renderer!==this.symbolCreationContext.renderer&&this.rendererChange(this.layer.renderer);
for(var b in this.graphicsBySymbol){var c=this.symbols[b],a=this.graphicsBySymbol[b];if(c&&c.layerPropertyChanged("elevationInfo",a)){for(var f in a){var e=a[f],c=e.graphic,e=e._labelGraphics;this.elevation&&this.elevation.markGraphicElevationDirty(c.uid);for(var d=0;d<e.length;d++){var g=e[d];g.graphics3DSymbolLayer.updateGraphicElevationContext(c,g)}}this.layerView._evaluateUpdatingState()}else this._recreateSymbol(b)}};d.prototype.clearSymbolsAndGraphics=function(){this.clear();this.elevation&&
this.elevation.clear();this.labeling&&this.labeling.clear()};d.prototype.recreateAllGraphics=function(){this.clearSymbolsAndGraphics();this.computedExtent=null;this.onComputedExtentChange&&this.onComputedExtentChange();this.layerView.loadedGraphics&&this.layerView.view.basemapTerrain.tilingScheme&&this.add(this.layerView.loadedGraphics.toArray())};d.prototype._recreateSymbol=function(a){var b=this.graphicsBySymbol[a],c=[],f=!1,e;for(e in b){var d=b[e];d.isDraped()&&(delete this.graphicsDrapedIds[e],
f=!0);c.push(d.graphic);d.destroy();delete this.graphics[e]}this.graphicsBySymbol[a]={};(b=this.symbols[a])&&b.destroy();delete this.symbols[a];this.updateHasDraped();f&&this.layerView._notifyDrapedDataChange();this.add(c)};d.prototype.add=function(a){if(this.layerView.view.basemapTerrain&&this.layerView.view.basemapTerrain.tilingScheme){for(var b=a.length,c=Array(b),f=Array(b),e=Array(b),d=!1,g=0;g<b;g++){var h=a[g],k=h.geometry;if(k)if(this.expandComputedExtent(k),k=this.layerView.getRenderingInfo?
this.layerView.getRenderingInfo(h):{symbol:h.symbol},this.graphicsWithoutSymbol[h.uid]=h,k&&k.symbol){if(f[g]=k.symbol,e[g]=k,k=this.getOrCreateGraphics3DSymbol(f[g],k.renderer))c[g]=k,this.beginGraphicUpdate(h)}else d||(d=!0,q.warn("Graphic in layer "+this.layer.id+" has no symbol and will not render"))}for(g=0;g<b;g++)this.waitForSymbol(c[g],f[g],a[g],e[g])}};d.prototype.waitForSymbol=function(a,b,c,f){var e=this;a&&a.then(function(){e.createGraphics3DGraphic(a,c,f);e.endGraphicUpdate(c);e.labeling&&
e.layerView.view.deconflictor.setDirty()},function(){e.endGraphicUpdate(c)})};d.prototype.remove=function(a){for(var b=!1,c=a.length,f=0;f<c;f++){var e=a[f].uid,d=this.graphics[e];if(d){d.isDraped()&&(delete this.graphicsDrapedIds[e],b=!0);var g=d.graphics3DSymbol.symbol.id;d.destroy();delete this.graphics[e];delete this.graphicsBySymbol[g][e];delete this.graphicsWithoutSymbol[e];this.graphicsKeys=null}}this.updateHasDraped();b&&this.layerView._notifyDrapedDataChange();this.layerView.view.deconflictor.setDirty()};
d.prototype.hasLabelingContext=function(a){if(a instanceof D||a instanceof T){var b=this.symbolCreationContext.layer;return b.labelingInfo?b.labelingInfo.some(function(b){return b.symbol===a}):!1}return!1};d.prototype.hasValidSymbolCreationContext=function(a){return a instanceof D&&!this.hasLabelingContext(a)?(q.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1):!0};d.prototype.createGraphics3DSymbol=function(a,b){if(!this.hasValidSymbolCreationContext(a))return null;
a=E.to3D(a,!0,!1,this.hasLabelingContext(a));if(a.symbol){var c=void 0;b&&b.backgroundFillSymbol&&(b=E.to3D(b.backgroundFillSymbol,!1,!0),b.symbol&&(c=b.symbol.symbolLayers));return Y.make(a.symbol,this.symbolCreationContext,c)}a.error&&q.error(a.error.message);return null};d.prototype.getOrCreateGraphics3DSymbol=function(a,b){var c=this,f=this.symbols[a.id];void 0===f&&(f=a instanceof S?new W(a,function(a){return c.createGraphics3DSymbol(a,b)}):this.createGraphics3DSymbol(a,b),this.symbols[a.id]=
f);return f};d.prototype.createGraphics3DGraphic=function(a,b,c){delete this.graphicsWithoutSymbol[b.uid];if(!this.symbols[a.symbol.id])this.add([b]);else if(!this.graphics[b.uid]){c=a.createGraphics3DGraphic(b,c);this.graphics[b.uid]=c;this.graphicsKeys=null;this.graphicsBySymbol[a.symbol.id]||(this.graphicsBySymbol[a.symbol.id]={});this.graphicsBySymbol[a.symbol.id][b.uid]=c;c.initialize(this.stageLayer,this.stage);c.isDraped()&&(this.hasDraped=this.graphicsDrapedIds[b.uid]=!0,this.layerView._notifyDrapedDataChange());
c.centroid=null;"point"!==b.geometry.type&&c instanceof V&&(c.centroid=X.computeCentroid(b.geometry,this.viewSR));a=this.scaleVisibility&&this.scaleVisibility.scaleRangeActive();this.spatialIndex&&this.spatialIndex.shouldAddToSpatialIndex(b,c,a)&&this.spatialIndex.addGraphicToSpatialIndex(b,c);this.labeling&&this.labeling.layerLabelsEnabled()&&this.labeling.createLabelsForGraphic(b,c);a&&this.scaleVisibility.updateGraphicScaleVisibility(b,c);c.setVisibilityFlag(0,b.visible&&!this.layerView.suspended);
if(a=this.whenGraphics3DGraphicRequests[b.uid])delete this.whenGraphics3DGraphicRequests[b.uid],a.resolve(c);this.highlights&&this.highlights.graphicCreated(c)}};d.prototype.rendererChange=function(a){var b=this.symbolCreationContext.renderer;if(a!==b){this.validateRenderer(a);var c=N.diff(b,a);this.updateUnchangedSymbolMappings(c,a,b);this.symbolCreationContext.renderer=a;c&&("complete"===c.type?this.recreateAllGraphics():"partial"===c.type&&(this.applyRendererDiff(c,a,b)?this.volatileGraphicsUpdated():
this.recreateAllGraphics()))}};d.prototype.diffHasSymbolChange=function(a){for(var b in a.diff)switch(b){case "visualVariables":break;case "defaultSymbol":break;case "uniqueValueInfos":break;case "authoringInfo":case "fieldDelimiter":delete a.diff[b];break;default:return!0}return!1};d.prototype.applySymbolSetDiff=function(a,b,c,f){f=!1;a=a||[];b=b||[];for(var e=[],d=0;d<b.length;d++){var g=b[d],h=this.graphicsBySymbol[g.id],k;for(k in h){var p=h[k],m=p.graphic;if(g!==c.defaultSymbol||c.getSymbol(m)!==
c.defaultSymbol)p.isDraped()&&(delete this.graphicsDrapedIds[k],f=!0),a.length||c.defaultSymbol?e.push(m):this.graphicsWithoutSymbol[k]=m,p.destroy(),this.highlights&&this.highlights.graphicDeleted(this.graphics[k]),delete h[k],delete this.graphics[k],this.graphicsKeys=null}if(void 0===h||0===Object.keys(h).length)delete this.graphicsBySymbol[g.id],(h=this.symbols[g.id])&&h.destroy(),delete this.symbols[g.id]}if(a.length||e.length){for(k in this.graphicsWithoutSymbol)e.push(this.graphicsWithoutSymbol[k]);
this.graphicsWithoutSymbol={};this.add(e)}this.updateHasDraped();f&&this.layerView._notifyDrapedDataChange();this.layerView.view.deconflictor.setDirty()};d.prototype.applyUniqueValueRendererDiff=function(a,b,c){var d=a.diff.defaultSymbol,e=a.diff.uniqueValueInfos;if(d||e){var l=e?e.added.map(function(a){return a.symbol}):[],g=e?e.removed.map(function(a){return a.symbol}):[];if(e)for(var h=0;h<e.changed.length;h++)l.push(e.changed[h].newValue.symbol),g.push(e.changed[h].oldValue.symbol);d?(c.defaultSymbol&&
g.push(c.defaultSymbol),b.defaultSymbol&&l.push(b.defaultSymbol)):c.defaultSymbol&&l.length&&g.push(b.defaultSymbol);this.applySymbolSetDiff(l,g,b,c);delete a.diff.defaultSymbol;delete a.diff.uniqueValueInfos;return!0}return!1};d.prototype.calculateUnchangedSymbolMapping=function(a,b,c){if(b instanceof v&&c instanceof v)if(!a){if(c&&c.defaultSymbol)return[{oldId:c.defaultSymbol.id,newId:b.defaultSymbol.id}]}else if("partial"===a.type){var d=a.diff;a=d.defaultSymbol;var d=d.uniqueValueInfos,e=void 0,
e=d?d.unchanged.map(function(a){return{oldId:a.oldValue.symbol.id,newId:a.newValue.symbol.id}}):c.uniqueValueInfos.map(function(a,c){return{oldId:a.symbol.id,newId:b.uniqueValueInfos[c].symbol.id}});!a&&c.defaultSymbol&&e.push({oldId:c.defaultSymbol.id,newId:b.defaultSymbol.id});return e}return[]};d.prototype.updateUnchangedSymbolMappings=function(a,b,c){var d=0;for(a=this.calculateUnchangedSymbolMapping(a,b,c);d<a.length;d++)if(c=a[d],b=c.oldId,c=c.newId,b&&b!==c){var e=this.graphicsBySymbol[b];
delete this.graphicsBySymbol[b];void 0!==e&&(this.graphicsBySymbol[c]=e);e=this.symbols[b];delete this.symbols[b];void 0!==e&&(this.symbols[c]=e,e.symbol.id=c)}};d.prototype.applyRendererDiff=function(a,b,c){var d=!1;if(this.diffHasSymbolChange(a))return!1;if(b instanceof v&&c instanceof v&&this.applyUniqueValueRendererDiff(a,b,c)&&0===Object.keys(a.diff).length)return!0;for(var e in this.graphicsBySymbol)if(c=this.symbols[e]){var l=this.graphicsBySymbol[e];if(!c.applyRendererDiff(a,b,l))return!1;
if(!d)for(var g in l)if(l[g].isDraped()){this.layerView._notifyDrapedDataChange();d=!0;break}}return!0};d.prototype.opacityChange=function(){var a=!1,b;for(b in this.graphicsBySymbol){var c=this.symbols[b];if(c){var d=this.graphicsBySymbol[b];c.layerPropertyChanged("opacity");if(!a)for(var e in d)if(d[e].isDraped()){this.layerView._notifyDrapedDataChange();a=!0;break}}}};d.prototype.setClippingExtent=function(a,b){var c=this.symbolCreationContext.clippingExtent,d=[];t.extentToBoundingRect(a,d,b)?
this.symbolCreationContext.clippingExtent=[d[0],d[1],-Infinity,d[2],d[3],Infinity]:this.symbolCreationContext.clippingExtent=null;return!J.equals(this.symbolCreationContext.clippingExtent,c)};d.prototype.forEachGraphics3DGraphic=function(a){var b=this;if(this.layerView.loadedGraphics){var c=!1,d=!1;this.layerView.loadedGraphics.forEach(function(e){var f=b.getGraphics3DGraphicById(e.uid);f&&a(f,e)&&(c=!0,d=d||f.isDraped())});c&&this.layerView.view.deconflictor.setDirty();d&&this.layerView._notifyDrapedDataChange()}};
d.prototype.updateAllGraphicsVisibility=function(){var a=this;this.forEachGraphics3DGraphic(function(b,c){var d=b.setVisibilityFlag(0,c.visible),e=!1;a.scaleVisibility&&(e=a.scaleVisibility.updateGraphicScaleVisibility(c,b));return d||e})};d.prototype.hideAllGraphics=function(){this.forEachGraphics3DGraphic(function(a){return a.setVisibilityFlag(0,!1)})};d.prototype.validateRenderer=function(a){(a=M.validateTo3D(a))&&q.warn("Renderer for layer '"+(this.layer.title?this.layer.title+", ":"")+", id:"+
this.layer.id+"' is not supported in a SceneView",a.message)};d.prototype.volatileGraphicsUpdated=function(){this.labeling&&(this.lastFastUpdate=performance.now());this.stageLayer.invalidateSpatialQueryAccelerator();this.stageLayer.shaderTransformationChanged();this.layerView._evaluateUpdatingState()};d.createLocalOriginFactory=function(){return new R(5E6,16)};d.prototype.snapshotInternals=function(){var a=this;return{graphics:Object.keys(this.graphics).sort(),symbols:Object.keys(this.symbols).sort(),
graphicsBySymbol:Object.keys(this.graphicsBySymbol).sort().map(function(b){return{symbolId:b,graphics:Object.keys(a.graphicsBySymbol[b]).sort()}}),graphicsWithoutSymbol:Object.keys(this.graphicsWithoutSymbol).sort(),graphicsDrapedIds:Object.keys(this.graphicsDrapedIds).sort()}};d.tmpVec=F.vec3d.create();return d}()});