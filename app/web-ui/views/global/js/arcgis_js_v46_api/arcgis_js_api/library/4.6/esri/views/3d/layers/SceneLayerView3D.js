// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../layers/IntegratedMeshLayer ../../../core/arrayUtils ../../../core/watchUtils ../../../core/promiseUtils ../../../core/Logger ../../../core/Collection ../../../core/Scheduler ../../../core/lang ../../../geometry/support/scaleUtils ../../../symbols/support/unitConversionUtils dojo/_base/lang dojo/has dojo/errors/CancelError ../../../Graphic ../../../symbols/Symbol3D ../../../tasks/support/Query ./LayerView3D ./i3s/I3SUtil ./i3s/I3SElevationProvider ./i3s/I3SGeometryUtil ./i3s/I3SProjectionUtil ./i3s/I3SQueryEngine ./i3s/Highlights ./i3s/IDBCache ./graphics/graphicUtils ./support/LayerViewUpdatingPercentage ../support/projectionUtils ../support/aaBoundingBox ../webgl-engine/Stage ../webgl-engine/lib/Layer ../webgl-engine/lib/Geometry ../webgl-engine/lib/PreinterleavedGeometryData ../webgl-engine/lib/Object3D ../webgl-engine/lib/Texture ../webgl-engine/materials/Material ./support/attributeUtils ../webgl-engine/lib/Util ../lib/glMatrix".split(" "),
function(R,Ba,Z,z,q,S,aa,B,E,ba,ca,da,ea,fa,T,ga,Ca,ha,H,ia,ja,ka,v,la,ma,N,na,oa,pa,U,qa,I,l,ra,sa,ta,M,ua,O,V,P,g,F){function va(r,c,a,b,d){var e=!1,f;c.encoding===v.DDS_ENCODING_STRING?f=O.DDS_ENCODING:e=!(g.isPowerOfTwo(r.width)&&g.isPowerOfTwo(r.height));a=((r=c.usedByEngineMats.some(function(a){return a.getParams().atlasRegions})||c.atlas)?b:a)&&!e;return{mipmap:a,wrapClamp:r||!c.wrap,disableAnisotropy:r&&a&&d,encoding:f,noUnpackFlip:!0}}function W(g){return g.data instanceof ArrayBuffer}function wa(g,
c){for(var a=1024,b=0;b<g.length;b++)a+=g[b].interleavedVertexData.byteLength;for(g=0;g<c.length;g++)b=c[g],b.data instanceof ArrayBuffer&&(a+=b.data.byteLength);return a}var t=ra.ModelContentType,x=ba.getLogger("esri.views.3d.layers.SceneLayerView3D"),X=[1,1,1,1],xa=[.8,.8,.8],ya=[.5,.5,.5];R=function(r){function c(){var a=null!==r&&r.apply(this,arguments)||this;a._queryEngine=null;a._highlights=new oa(a);a._elevationProvider=null;a._controllerCreated=!1;a._idbCache=new pa.IDBCache("esri-scenelayer-cache",
"geometries",4);a._cancelCount=0;a._hasColors=!1;a._hasTextures=!1;a._hasData=!1;a.alwaysLoadEverythingModeEnabled=!1;a._cacheKeySuffix=null;a._definitionExpressionErrors=0;a._maxDefinitionExpressionErrors=20;return a}Z(c,r);Object.defineProperty(c.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"rendererNeedsTextures",{get:function(){return v.rendererNeedsTextures(this.layer.renderer)},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"elevationOffset",{get:function(){var a=null!=this.layer?this.layer.elevationInfo:null;if(null!=a&&"absolute-height"===a.mode){var b=fa.getMetersPerVerticalUnitForSR(this.layer.spatialReference),d=T.getMetersPerUnit(a.unit);return(a.offset||0)*d/b}return 0},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&
!this._useCompressedTextures},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_useCompressedTextures",{get:function(){return this.view.has("s3tc")&&!0},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps&&this.view.has("standardDerivatives")},enumerable:!0,
configurable:!0});Object.defineProperty(c.prototype,"_atlasBiasCompensationEnabled",{get:function(){return!this.view.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0});c.prototype.initialize=function(){var a=this;v.checkSceneLayerValid(this.layer);v.checkSceneLayerCompatibleWithView(this.layer,this.view);this._initGraphicsController();
this.maxGpuMemory=1E3;this.geoMemoryEstimate=this.texMemoryEstimate=this.gpuMemoryEstimate=0;this._stage=this.view._stage;this._matId2Meta={};this._texId2Meta={};this._nodeId2Meta={};this._addThisLayerToStage();this._elevationProvider=new la({layerView:this,stageLayer:this._stageLayer});this.handles.add([B.init(this.view,"clippingArea",function(){return a._clippingAreaChanged()}),B.init(this.layer,"renderer",function(b){return a._rendererChange(b)}),B.init(this.layer,"objectIdFilter",function(){return a._filterChange()}),
B.init(this.layer,"elevationInfo",function(){return a._elevationInfoChanged()}),B.init(this,"_controller.parsedDefinitionExpression",function(){return a._filterChange()}),B.watch(this,"fullOpacity",function(b){return a._opacityChange(b)}),B.watch(this,["elevationOffset","rendererNeedsTextures"],function(){return a._reloadAll()}),B.watch(this,"uncompressedTextureDownsamplingEnabled",function(){return a._reloadAll()}),B.init(this,"suspended",function(b){return a.setVisibility(!b)})],"sceneLayerHandles");
this._idbCache.init();this._cacheKeySuffix=v.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference)};c.prototype.destroy=function(){this.handles.remove("sceneLayerHandles");this._removeThisLayerFromStage();this._stage=null;this._idbCache&&(this._idbCache.destroy(),this._idbCache=null);null!=this._controller&&(this._controller.destroy(),this._controller=null);this._highlights.destroy();this._nodeId2Meta=this._texId2Meta=this._matId2Meta=null;this.emit("visible-geometry-changed");
this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)};c.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)};c.prototype.isUpdating=function(){return this._controllerCreated?!(!this._controller||!this._controller.updating):!0};c.prototype.memEstimateTextureAdded=function(a){a=a.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate+=a;this.texMemoryEstimate+=
a};c.prototype.memEstimateTextureRemoved=function(a){a=a.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate-=a;this.texMemoryEstimate-=a};c.prototype.memEstimateGeometryAdded=function(a){a=a.estimateGpuMemoryUsage()/1E6;this.gpuMemoryEstimate+=a;this.geoMemoryEstimate+=a};c.prototype.memEstimateGeometryRemoved=function(a){a=a.estimateGpuMemoryUsage()/1E6;this.gpuMemoryEstimate-=a;this.geoMemoryEstimate-=a};c.prototype.isBundleAlreadyAddedToStage=function(a,b){return null!=this._nodeId2Meta[a.id]&&
null!=this._nodeId2Meta[a.id].engineObjectsPerBundle&&null!=this._nodeId2Meta[a.id].engineObjectsPerBundle[b]};c.prototype._initGraphicsController=function(){var a=this;this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:{addBundle:function(b,d,e){return a._addBundle(b,d,e)},isBundleAlreadyAddedToStage:function(b,d){return a.isBundleAlreadyAddedToStage(b,d)},isOverMemory:function(){return a._isOverMemory()},removeNodeData:function(b){return a._removeNodeDataFromStage(b.id)},
getAddedNodeIDs:function(){return a._getAddedNodeIDs()},areAllBundlesLoaded:function(b){return a._areAllBundlesLoaded(b)}},layerViewOptionalFunctions:{setPolygonOffset:function(b,d){return a._setPolygonOffset(b,d?1:0)},traversalOptions:{initDepthFirst:!1,neighborhood:!0,perLevelTraversal:!1,allowPartialOverlaps:!1},textureOptions:{useCompressedTextures:this._useCompressedTextures},getLoadedAttributes:function(b){return a._getLoadedAttributes(b)},setAttributeData:function(b,d,e){return a._setAttributeData(b,
d,e)},additionalCancelNodeLoadingHandler:function(){return a._cancel()},loadCachedBundle:function(b,d,e){return a._loadCachedBundle(b,d,e)},addCachedBundle:function(b,d,e,f){return a._addCachedBundle(b,d,e,f)}}}).then(function(b){a._controller=b;b.watch("rootNodeVisible",function(){a.notifyChange("suspended")})}).always(function(){a._controllerCreated=!0;a.notifyChange("updating")})};c.prototype.setMaxGpuMemory=function(a){this.maxGpuMemory=a};c.prototype.setVisibility=function(a){if(this._stage&&
this._stageLayer){var b=this._stageLayer.getId(),d=0<=this._stage.getViewContent().indexOf(b);!!a!==d&&(b=[b],a?(this._stage.addToViewContent(b),a=this._isIntegratedMesh()?"im":"scene",this.view.elevationProvider.register(a,this._elevationProvider),this.visibleGeometryChanged()):(this._stage.removeFromViewContent(b),this.visibleGeometryChanged(),this.view.elevationProvider.unregister(this._elevationProvider)))}};c.prototype.getStats=function(){var a={nodesInIndex:0,knownFeatures:0,activeMaterials:0,
"Total GPU Memory Estimate":this.gpuMemoryEstimate+"MB","Geometry Memory Estimate":this.geoMemoryEstimate+"MB","Texture Memory Estimate":this.texMemoryEstimate+"MB"};if(!this._controller)return a;a.nodesInIndex=Object.keys(this._controller.nodeIndex).length;a.activeMaterials=Object.keys(this._matId2Meta).length;return a};c.prototype._addThisLayerToStage=function(){for(var a=this._stage,b=new Uint8Array(256),d=0;d<b.length;d++)b[d]=255;this._whiteTexture=new O(b,"white",{width:8,height:8});a.add(t.TEXTURE,
this._whiteTexture);b=this.layer.id;this._stageLayer=b=new sa(b,{},b);a.add(t.LAYER,b)};c.prototype._removeThisLayerFromStage=function(){if(null!=this._stageLayer){var a=this._stage;a.remove(t.TEXTURE,this._whiteTexture.getId());this._removeAllNodeDataFromStage();g.assert(g.objectEmpty(this._nodeId2Meta));g.assert(g.objectEmpty(this._matId2Meta));g.assert(g.objectEmpty(this._texId2Meta));a.remove(t.LAYER,this._stageLayer.getId());this._matId2Meta={};this._texId2Meta={};this._nodeId2Meta={};this._stageLayer=
void 0;this.gpuMemoryEstimate=0}};c.prototype._getLoadedAttributes=function(a){if((a=this._nodeId2Meta[a.id])&&1===a.engineObjects.length)return a.engineObjects[0].getMetadata().loadedAttributes};c.prototype._setAttributeData=function(a,b,d){var e=this._nodeId2Meta[a.id];if(e&&1===e.engineObjects.length){var e=e.engineObjects[0],f=e.getMetadata();f.loadedAttributes=b;f.attributeData=d;this._setObjectSymbology(e);this._applyFilters(a);this.visibleGeometryChanged(e)}};c.prototype._isOverMemory=function(){if(this.gpuMemoryEstimate>
this.maxGpuMemory&&this.gpuMemoryEstimate!==this.warnGpuMemoryEstimate){this.warnGpuMemoryEstimate=this.gpuMemoryEstimate;var a=function(a){return a.toLocaleString(void 0,{maximumFractionDigits:1})+" Mb"};x.warn("GPU Memory Limit exceeded!\nLimit: "+a(this.maxGpuMemory)+" Current: "+a(this.gpuMemoryEstimate)+"\n(Textures: "+a(this.texMemoryEstimate)+" Geometry: "+a(this.geoMemoryEstimate)+")")}return this.gpuMemoryEstimate>this.maxGpuMemory};c.prototype._getAddedNodeIDs=function(){return Object.keys(this._nodeId2Meta)};
c.prototype._calcEngineMaterialTransparencyParams=function(a,b,d){var e=this.fullOpacity,f=1-g.clamp(g.fallbackIfUndefined(b.transparency,0),0,1);a=1>f||1>e||a&&ea.endsWith(a.channels,"a")||!0===b.useVertexColorAlpha||d;return{opacity:f,layerOpacity:e,transparent:a}};c.prototype._calcEngineMaterialDoubleSidedParams=function(a){return null!=a.doubleSided?a.doubleSided:!0};c.prototype._calcEngineMaterialCullFaceParams=function(a){return a.cullFace?a.cullFace:null!=a.doubleSided?a.doubleSided?"none":
"back":"none"};c.prototype._getMaterialParameters=function(a,b,d){var e;null!=a&&(e=(e=this._texId2Meta[b])&&e.engineTex?e.engineTex.getId():this._whiteTexture.getId());b=d.params;var f=g.fallbackIfUndefined(b.diffuse,xa);"standard"!==d.type&&x.warn("Unknown material type '"+d.type+"', must be 'standard'");void 0===b.reflectivity&&x.warn("Material parameter 'reflectivity' is missing.");d=this._isIntegratedMesh();e={ambient:f,diffuse:f,specular:g.fallbackIfUndefined(b.specular,ya),shininess:g.fallbackIfUndefined(b.shininess,
64),atlasRegions:b.vertexRegions,textureId:e,vertexColors:this._hasVertexColors(),symbolColors:this._hasSymbolColors(),flipV:!1,doubleSided:this._calcEngineMaterialDoubleSidedParams(b),cullFace:this._calcEngineMaterialCullFaceParams(b),writeStencil:d,receiveSSAO:!d,groundNormalShading:d};d||(a=this._calcEngineMaterialTransparencyParams(a,b),ga.mixin(e,a));return e};c.prototype._createEngineMaterial=function(a,b,d,e,f){var c=null!=a?this._getI3STexEncoding(a):null,k=this._getMaterialParameters(a,b,
d),k=new V(k,e);k.metadata={i3sMatId:e,i3sTexId:b,i3sTex:a,i3sMatParams:d.params};if(null!=a){(d=this._texId2Meta[b])?d.usedByEngineMats.push(k):(d={id:b,usedByEngineMats:[k],images:a.images,encoding:c,atlas:!0===a.atlas,wrap:"none"!==a.wrap[0]||"none"!==a.wrap[1]},this._texId2Meta[b]=d);a:{for(a=0;a<f.length;a++)if(c=f[a],c.i3sTexId===b){f=c.data;break a}f=null}null!=f&&null==d.engineTex&&(a=va(f,d,this._enableMipMaps,this._enableAtlasMipMaps,this._disableAtlasAnisotropy),d.engineTex=new O(f,d.id,
a),this._stage.add(t.TEXTURE,d.engineTex),this.memEstimateTextureAdded(d.engineTex));if(null!=d.engineTex)for(f=d.engineTex.getId(),a=0,d=d.usedByEngineMats;a<d.length;a++)d[a].setParameterValues({textureId:f})}this._matId2Meta[e]||(this._matId2Meta[e]={});this._matId2Meta[e][b]={engineMat:k,refCount:1};return k};c.prototype._getI3STexEncoding=function(a){var b=v.getAppropriateTextureEncoding(a.encoding,this._useCompressedTextures);return-1<b?a.encoding[b]:a.encoding};c.prototype._hasNonWhiteColors=
function(a){var b=a.data,d=a.size,e=a.strideIdx;for(a=a.offsetIdx;a<b.length;a+=e)for(var f=0;f<d;f++)if(255!==b[a+f])return!0;return!1};c.prototype._getVertexBufferLayout=function(a,b){var d=a.params.materialID,e=b.materialDefinitions[d];g.assert(void 0!==e,"geometry wants unknown material "+d);a=a.params.textureID||"none";var f;"none"!==a&&(null!=b.textureDefinitions&&null!=b.textureDefinitions[a]||x.warn("textureDefinitions missing in shared resource"),f=b.textureDefinitions[a]);b=this._getMaterialParameters(f,
a,e);return V.getVertexBufferLayout(b)};c.prototype._createEngineMat=function(a,b,d){var e=a.params.materialID,f=b.materialDefinitions[e];g.assert(void 0!==f,"geometry wants unknown material "+e);a=a.params.textureID||"none";var c;"none"!==a&&(null!=b.textureDefinitions&&null!=b.textureDefinitions[a]||x.warn("textureDefinitions missing in shared resource"),c=b.textureDefinitions[a]);this._matId2Meta[e]&&this._matId2Meta[e][a]?(d=this._matId2Meta[e][a],b=d.engineMat,d.refCount++):b=this._createEngineMaterial(c,
a,f,e,d);return b};c.prototype._areAllBundlesLoaded=function(a){if(null==this._nodeId2Meta[a.id]||null==this._nodeId2Meta[a.id].engineObjectsPerBundle)return!1;for(var b=0;b<a.featureData.length;b++)if(null==this._nodeId2Meta[a.id].engineObjectsPerBundle[b])return!1;return!0};c.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"};c.prototype._findGraphicNodeAndIndex=function(a){a=P.attributeLookup(a.attributes,this._getObjectIdField());for(var b=0,d=Object.keys(this._nodeId2Meta);b<
d.length;b++)for(var e=d[b],f=this._nodeId2Meta[e].engineObjects,c=0;c<f.length;c++){var k=f[c].getMetadata().featureIds.indexOf(a);if(-1!==k)return{node:this._controller.nodeIndex[e],nodeId:e,bundleNr:c,index:k}}return null};c.prototype._getGraphicIndices=function(a,b,d){a=this._nodeId2Meta[a.id].engineObjects;if(!a||!a[b])return[];b=a[b].getMetadata();a=[];for(var e=this._getObjectIdField(),f=0;f<d.length;f++){var c=P.attributeLookup(d[f].attributes,e),c=b.featureIds.indexOf(c);-1!==c&&a.push(c)}return a};
c.prototype.whenGraphicBounds=function(a){a=this._findGraphicNodeAndIndex(a);if(null!=a&&(a=this._boundingBoxCornerPoints(a.index,this._nodeId2Meta[a.nodeId].engineObjects[a.bundleNr],new Float64Array(24)),I.bufferToBuffer(a,this.view.renderSpatialReference,0,a,this.view.spatialReference,0,8))){var b=l.create(l.NEGATIVE_INFINITY);l.expandBuffer(b,a,0,8);return E.resolve({boundingBox:b,screenSpaceObjects:[]})}return E.reject()};c.prototype.whenGraphicAttributes=function(a,b){var d=this;return v.whenGraphicAttributes(this.layer,
[a],this._getObjectIdField(),b,function(){var b=d._findGraphicNodeAndIndex(a);return{node:b.node,indices:[b.index]}},{ignoreUnavailableFields:!0,populateObjectId:!0}).then(function(a){return a[0]})};c.prototype.getGraphicsFromStageObject=function(a,b){if(this.layer instanceof S)return E.reject();var d=a.getMetadata();a=a.getComponentFromTriangleNr(0,b);return null!=a&&null!=d.featureIds&&a<d.featureIds.length?(d=this._createGraphic(a,d),E.resolve(d)):E.reject()};c.prototype._getCacheKey=function(a){return a.baseUrl+
this._cacheKeySuffix};c.prototype._cachingEnabled=function(){return!this._controller.disableCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix};c.prototype._cancel=function(){this._cancelCount=this._cancelCount+1|0};c.prototype._handleCancelled=function(a){if(0<(this._cancelCount-a|0))throw new ha;};c.prototype._loadCachedBundle=function(a,b,d){var e=this,f=this._cancelCount;return this._cachingEnabled()?this._idbCache.get(this._getCacheKey(a)).then(function(b){if(null==b)return null;e._handleCancelled(f);
if(b.nodeVersion!==a.version)return e._idbCache.remove(e._getCacheKey(a)),null;var c=function(a){if(null==a.data)return!0;var d=e._getI3STexEncoding(b.sharedResource.textureDefinitions[a.i3sTexId]);return a.encoding!==d};return e.rendererNeedsTextures&&b.textureData.some(c)?d(b.allGeometryData,b.sharedResource).then(function(d){b.textureData=d;d.every(W)&&e._idbCache.put(e._getCacheKey(a),b).otherwise(function(){return x.warn("Failed to update node with textures in IndexedDB cache: "+a.id)});e._handleCancelled(f);
return b}):b}):E.resolve(null)};c.prototype._addBundle=function(a,b,d){var e=this;return this._transformBundle(a,b,d).then(function(f){if(e._cachingEnabled()){var c=f.allGeometryData,k=f.transformedGeometries,A=f.sharedResource,h=f.byteSize,g=f.textureData.map(function(a){return W(a)?a:{i3sTexId:a.i3sTexId,encoding:a.encoding,data:null}});e._idbCache.put(e._getCacheKey(a),{allGeometryData:c,transformedGeometries:k,textureData:g,sharedResource:A,nodeVersion:a.version,byteSize:h}).otherwise(function(){return x.warn("Failed to store node in IndexedDB cache: "+
a.id)})}return e._addCachedBundle(a,b,f,d.attributeDataInfo)})};c.prototype._transformBundle=function(a,b,d){b=d.allGeometryData;var e=d.geometryBuffer,f=d.textureData,c=d.sharedResource,k=this._hasColors,A=[];for(d=0;d<b.length;d++)for(var h=b[d],y=h.componentOffsets,u=function(b){var d=m._getVertexBufferLayout(b,c);b=ma.interleaveGeometryBuffer(b,e,d,[{name:g.VertexAttrConstants.NORMAL,byteValue:0},{name:g.VertexAttrConstants.COLOR,byteValue:255},{name:g.VertexAttrConstants.SYMBOLCOLOR,byteValue:0}]);
var f=new M(new Float32Array(b),d,y||M.DefaultOffsets),p=m._controller.crsIndex,h=m._controller.crsVertex,u=m.view.renderSpatialReference,C=F.vec4d.set(a.mbs,za);C[2]+=m.elevationOffset;h=N.reprojectPoints(N.ReprojectionTypes.PER_VERTEX,f.getAttribute(g.VertexAttrConstants.POSITION),C,p,h,u);if(!m._isIntegratedMesh()&&m._controller.isMeshPyramid){var t={normals:f.getAttribute(g.VertexAttrConstants.NORMAL),positions:f.getAttribute(g.VertexAttrConstants.POSITION),normalInd:f.getIndices(g.VertexAttrConstants.NORMAL),
positionInd:f.getIndices(g.VertexAttrConstants.POSITION)};v.processNormals(t,m.layer.normalReferenceFrame||"none",function(a,b){return N.reprojectNormalsPerVertex(a,C,p,b,u)})}(f=f.getAttribute(g.VertexAttrConstants.COLOR))&&(k=k||m._hasNonWhiteColors(f));A.push({layout:d,interleavedVertexData:b,corMatrices:h,hasNonWhiteColors:k})},m=this,C=0,h=h.geometries;C<h.length;C++)u(h[C]);return E.resolve({allGeometryData:b,transformedGeometries:A,textureData:f,sharedResource:c,nodeVersion:a.version,byteSize:wa(A,
f)})};c.prototype._addCachedBundle=function(a,b,d,e){if(this._isOverMemory())return E.reject();var f=d.allGeometryData,c=d.transformedGeometries,k=d.textureData,A=d.sharedResource;if(!this.rendererNeedsTextures)for(d=0;d<k.length;d++)k[d].data=null;d=this._stage;var h={};h[t.OBJECT]={};h[t.GEOMETRY]={};h[t.MATERIAL]={};h[t.TEXTURE]={};var g=this._stageLayer,u=g.getId();if(null!=this._nodeId2Meta[a.id]&&null!=this._nodeId2Meta[a.id].engineObjectsPerBundle&&this._nodeId2Meta[a.id].engineObjectsPerBundle[b])return this._applyFilters(a),
E.resolve();null==this._nodeId2Meta[a.id]&&(this._nodeId2Meta[a.id]={engineObjects:[],engineObjectsPerBundle:[]});this._nodeId2Meta[a.id].engineObjectsPerBundle[b]=[];for(var m=0,C=this._hasColors,Q=0;Q<f.length;Q++){for(var w=f[Q],n=w.componentOffsets,J=w.featureIds,v=a.id+"|"+J[0],q=[],x=[],z=[],l=void 0,B=0,w=w.geometries;B<w.length;B++){var r=w[B],D=this._createEngineMat(r,A,k),l=c[m++],C=C||l.hasNonWhiteColors,K=new M(new Float32Array(l.interleavedVertexData),l.layout,n||M.DefaultOffsets),l=
l.corMatrices,H=F.mat4d.create(l.localTrafo);null!=r.transformation&&F.mat4d.multiply(H,r.transformation,H);r=q.length;K=new ta(K,v+(0<r?"_"+r:""));q.push(K);x.push(H);z.push([D]);this.memEstimateGeometryAdded(K.getData());h[t.MATERIAL][D.getId()]=D;h[t.GEOMETRY][K.getId()]=K}n=new ua({idHint:a.id,name:v,geometries:q,materials:z,transformations:x,castShadow:!0,metadata:{i3sNode:a.id,ceLayer:u,featureIds:J,attributeData:e?e.attributeData:null,loadedAttributes:e?e.loadedAttributes:null,layerUid:this.layer.uid}});
J=F.mat4d.create();F.mat4d.identity(J);F.mat4d.multiply(J,l.globalTrafo,J);n.setObjectTransformation(J);this._nodeId2Meta[a.id].engineObjectsPerBundle[b].push(n);this._nodeId2Meta[a.id].engineObjects.push(n);h[t.OBJECT][n.getId()]=n;this._setObjectSymbology(n);this._applyFilters(a);this._highlights.objectCreated(n);this.visibleGeometryChanged(n)}d.beginMod();b=h[t.OBJECT];for(var L in b)b.hasOwnProperty(L)&&g.addObject(b[L]);for(var G in h)if(h.hasOwnProperty(G)){L=h[G];for(var I in L)L.hasOwnProperty(I)&&
null==d.get(G,I)&&d.add(G,L[I])}d.endMod();!this._hasTextures&&null!=a.textureData&&0<a.textureData.length&&(this._hasTextures=!0);this._hasColors=C;this._hasData=!0;this.notifyChange("hasTexturesOrVertexColors");return E.resolve()};c.prototype._clippingAreaChanged=function(){var a=this,b=[];I.extentToBoundingBox(this.view.clippingArea,b,this.view.renderSpatialReference)?this._clippingArea=b:this._clippingArea=null;this._updateFilters();if(this._controller){var d=this._controller.nodeIndex;d&&Object.keys(this._nodeId2Meta).forEach(function(b){return a._applyFilters(d[b])});
this._controller.updateClippingArea(this.view.clippingArea)}};c.prototype._filterChange=function(){this._updateFilters();if(this._controller){var a=this._controller.nodeIndex;if(a)for(var b=0,d=Object.keys(this._nodeId2Meta);b<d.length;b++)this._applyFilters(a[d[b]])}};c.prototype._updateFilters=function(){var a=this,b=[];if(this.layer.objectIdFilter){var d=new Float64Array(this.layer.objectIdFilter.ids),e="include"===this.layer.objectIdFilter.method;d.sort();b.push(function(b,f){return a._objectIdFilter(d,
e,f)})}if(this._controller&&this._controller.parsedDefinitionExpression&&this._controller.definitionExpressionFields){this._definitionExpressionErrors=0;var f=this._controller.parsedDefinitionExpression,c=this._controller.definitionExpressionFields;b.push(function(b,d){return a._sqlFilter(b,f,c,d)})}this._clippingArea&&b.push(function(b,d){return a._boundingboxFilter(b,a._clippingArea,d)});this._filters=b};c.prototype._sqlFilter=function(a,b,d,e){var f={},c=new H(null,null,f);c.layer=this.layer;var k=
this.layer.objectIdField,g=0,h=0,y=function(a){var p=a.getMetadata();a=p.featureIds;for(var A=p.attributeData,p=d.every(function(a){return null!=A[a]||a===k}),n=0;n<a.length&&g<e.length;n++)if(e[g]===a[n]){var m=!0;if(p){f[k]=a[n];for(var m=0,y=d;m<y.length;m++){var l=y[m];l!==k&&(f[l]=v.getCachedAttributeValue(A[l],n))}m=u._evaluateClause(b,c)}m&&(e[h]=e[g],h++);g++}},u=this,m=0;for(a=this._nodeId2Meta[a.id].engineObjects;m<a.length;m++)y(a[m]);e.length=h};c.prototype._evaluateClause=function(a,
b){try{return a.testFeature(b)}catch(d){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&x.error("Error while evaluating definitionExpression: "+d),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&x.error("Further errors are ignored"),!1}};c.prototype._objectIdFilter=function(a,b,d){for(var e=0,f=0;e<d.length;)0<=aa.binaryIndexOf(a,d[e])===b&&(d[f]=d[e],f++),e++;d.length=f};c.prototype._boundingboxFilter=function(a,
b,d){var e=[0,0,0,0];I.mbsToMbs(a.mbs,this._controller.crsIndex,e,this.view.renderSpatialReference);e=null!=b?v.intersectBoundingBoxWithMbs(b,e):2;if(2!==e)if(0===e)d.length=0;else{var f=e=0,c=0;for(a=this._nodeId2Meta[a.id].engineObjects;c<a.length;c++){var k=a[c],g=k.getMetadata().featureIds,h=k.getObjectTransformation(),y=k.getGeometryRecords()[0].getShaderTransformation();F.mat4d.multiply(h,y);if(0===h[1]&&0===h[2]&&0===h[3]&&0===h[4]&&0===h[6]&&0===h[7]&&0===h[8]&&0===h[9]&&0===h[11]&&1===h[15]){y=
Y;y[0]=(b[0]-h[12])/h[0];y[1]=(b[1]-h[13])/h[5];y[2]=(b[2]-h[14])/h[10];y[3]=(b[3]-h[12])/h[0];y[4]=(b[4]-h[13])/h[5];y[5]=(b[5]-h[14])/h[10];for(var k=k.getGeometryRecords()[0].geometry,h=k.getComponentCount(),u=0;u<h&&e<d.length;u++)if(d[e]===g[u]){var m=k.getComponentAABB(u,Aa);l.intersects(y,m)&&(d[f]=d[e],f++);e++}}}d.length=f}};c.prototype._applyFilters=function(a){if(this._nodeId2Meta[a.id]&&null!=this._nodeId2Meta[a.id].engineObjects){for(var b=this._nodeId2Meta[a.id].engineObjects,d=0;d<
b.length;d++){var e=b[d];e.unhideAllComponents()}if(0!==this._filters.length){for(var d=[],c=0;c<b.length;c++)e=b[c],d=d.concat(e.getMetadata().featureIds);e=d.length;for(c=0;c<this._filters.length;c++)this._filters[c](a,d);if(d.length!==e)for(c=a=0;c<b.length;c++)for(var e=b[c],p=e.getGeometryRecords()[0],k=e.getMetadata().featureIds,g=0;g<k.length;g++){var h=k[g];a>=d.length||d[a]!==h?e.setComponentVisibility(p,g,!1):a++}}}};c.prototype._removeAllNodeDataFromStage=function(){for(var a=0,b=Object.keys(this._nodeId2Meta);a<
b.length;a++)this._removeNodeDataFromStage(b[a])};c.prototype._removeNodeDataFromStage=function(a){if(null!=this._nodeId2Meta[a]&&null!=this._nodeId2Meta[a].engineObjects){for(var b=this._stage,d=this._stageLayer,e=this._nodeId2Meta[a].engineObjects,c=0;c<e.length;++c){var p=e[c];this._highlights.objectDeleted(p);this.visibleGeometryChanged(p);d.removeObject(p);for(var k=p.getGeometryRecords(),A=0;A<k.length;A++){var h=k[A];this.memEstimateGeometryRemoved(h.geometry.getData());b.remove(t.GEOMETRY,
h.geometry.getId());for(var l=0;l<h.materials.length;l++){var u=h.materials[l],m=u.getId(),v=u.metadata.i3sMatId,q=u.metadata.i3sTexId||"none",w=this._matId2Meta[v][q];g.assert(0<w.refCount);w.refCount--;0===w.refCount&&this._removeMaterial(m,q,v,u,b)}}b.remove(t.OBJECT,p.getId())}delete this._nodeId2Meta[a]}};c.prototype._removeMaterial=function(a,b,d,e,c){c.remove(t.MATERIAL,a);if("none"!==b){a=this._texId2Meta[b];var f=a.usedByEngineMats;e=f.indexOf(e);g.assert(-1<e);f[e]=f[f.length-1];f.pop();
1>f.length&&((e=a.engineTex)&&e!==this._whiteTexture&&(this.memEstimateTextureRemoved(e),c.remove(t.TEXTURE,a.engineTex.getId())),a.engineTex=void 0,delete this._texId2Meta[b])}delete this._matId2Meta[d][b];g.objectEmpty(this._matId2Meta[d])&&delete this._matId2Meta[d]};c.prototype._setPolygonOffset=function(a,b){if(null!=this._nodeId2Meta[a.id]&&null!=this._nodeId2Meta[a.id].engineObjectsPerBundle){b={polygonOffset:b};for(var d=0;d<this._nodeId2Meta[a.id].engineObjectsPerBundle.length;d++)for(var e=
this._nodeId2Meta[a.id].engineObjectsPerBundle[d],c=0;c<e.length;c++)for(var p=e[c].getGeometryRecords(),k=0;k<p.length;k++)for(var g=p[k].materials,h=0;h<g.length;h++)g[h].setParameterValues(b)}};c.prototype._rendererChange=function(a){(this._currentRenderer=a)&&(a.colorInfo||a.sizeInfo)&&x.warn("renderer.colorInfo and renderer.sizeInfo are not supported for Scene Services. Use visualVariables instead.");if(a){var b=0;for(a=a.getSymbols();b<a.length;b++){var d=a[b];"mesh-3d"!==d.type&&x.error("Symbols of type '"+
d.type+"' are not supported for 3D Object Scene Services.")}}};c.prototype._getRenderingInfo=function(a){var b=this._currentRenderer,d=b&&b.getSymbol(a);if(!(d instanceof ia&&this._hasSymbolColors()))return null;var d={symbol:d},e,c;if(b&&b.visualVariables)for(a=b.getVisualVariableValues(a),b=0;b<a.length;b++){var g=a[b],k=g.variable.type;"color"===k?e=g.value:"opacity"===k&&(c=g.value)}e&&(d.color=[e.r/255,e.g/255,e.b/255]);null!=c?d.opacity=c:e&&null!=e.a&&(d.opacity=e.a);return d};c.prototype._getSymbolFillMaterial=
function(a,b){var d=0;for(a=a.symbolLayers.items;d<a.length;d++){var e=a[d];if("fill"===e.type){d=e.material;a=null!=d?d.color:null;null!=a?(G[0]=a.r/255,G[1]=a.g/255,G[2]=a.b/255,G[3]=a.a,b.color=G):b.color=null;b.colorMixMode=null!=d?d.colorMixMode:null;return}}b.color=null;b.colorMixMode=null};c.prototype._hasSymbolColors=function(){if(this._isIntegratedMesh()||!this.layer.store.defaultGeometrySchema)return!1;var a=this.layer.store.defaultGeometrySchema.featureAttributes;return a&&a.faceRange&&
a.id};c.prototype._isIntegratedMesh=function(){return this.layer instanceof S};c.prototype._hasVertexColors=function(){return null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color)};c.prototype._setObjectSymbology=function(a){if(this._hasSymbolColors()){for(var b=a.getMetadata(),d=b.featureIds?b.featureIds.length:1,e=new H(null,null,{}),c=e.attributes,p=this.layer.objectIdField,k=this._currentRenderer&&this._currentRenderer.requiredFields,
l=a.geometryRecords[0].geometry,h=l.data.getAttribute(g.VertexAttrConstants.SYMBOLCOLOR),q=!1,u=new Uint8Array(4),m={color:null,colorMixMode:null},t=null,r=0;r<d;r++){null!=p&&null!=b.featureIds&&(c[p]=b.featureIds[r]);if(null!=k&&null!=b.attributeData)for(var w=0,n=k;w<n.length;w++){var x=n[w];null!=b.attributeData[x]&&(c[x]=v.getCachedAttributeValue(b.attributeData[x],r))}(n=this._getRenderingInfo(e))?(n.symbol!==t&&(t=n.symbol,this._getSymbolFillMaterial(n.symbol,m)),w=n.color,n=n.opacity,w=null==
w||null==n?U.overrideColor(w,n,m.color,m.color&&m.color[3],X):U.overrideColor(w,n,null,null,X),1>w[3]&&(q=!0),v.encodeSymbolColor(w,m.colorMixMode,u)):v.encodeSymbolColor(null,null,u);this._setComponentColor(l,r,h,u)}a.geometryColorAttrsUpdated(0);a=a.getGeometryRecords();for(b=0;b<a.length;b++)for(d=a[b],e=0;e<d.materials.length;e++)c=d.materials[e],p=c.getParams().transparent,k=c.getParams().opacity,c.metadata.symbolIsTransparent=q,l=this._calcEngineMaterialTransparencyParams(c.metadata.i3sTex,
c.metadata.i3sMatParams,c.metadata.symbolIsTransparent),p===l.transparent&&k===l.opacity||c.setParameterValues({transparent:l.transparent,opacity:l.opacity})}};c.prototype._setComponentColor=function(a,b,d,e){var c=d.data,p=d.offsetIdx,k=d.strideIdx;g.assert(4===d.size);d=p+a.data.componentOffsets[b+1]*k;for(a=p+a.data.componentOffsets[b]*k;a<d;a+=k)c[a]=e[0],c[a+1]=e[1],c[a+2]=e[2],c[a+3]=e[3]};c.prototype._elevationInfoChanged=function(){var a=this.layer.elevationInfo&&this.layer.elevationInfo.unit;
a&&!T.supportsUnit(a)&&x.warn("elevationInfo.unit","'"+a+"' is not a valid unit")};c.prototype._reloadAll=function(){this._removeAllNodeDataFromStage();null!=this._controller&&this._controller.restartNodeLoading()};c.prototype._opacityChange=function(a){for(var b in this._matId2Meta)for(var d in this._matId2Meta[b]){a=this._matId2Meta[b][d].engineMat;var c=a.getParams(),f=this._calcEngineMaterialTransparencyParams(a.metadata.i3sTex,a.metadata.i3sMatParams,a.metadata.symbolIsTransparent);c.transparent===
f.transparent&&c.layerOpacity===f.layerOpacity||a.setParameterValues(f)}};c.prototype.queryExtent=function(a){return this._ensureQueryEngine().queryExtent(a)};c.prototype.queryFeatureCount=function(a){return this._ensureQueryEngine().queryFeatureCount(a)};c.prototype.queryFeatures=function(a){return this._ensureQueryEngine().queryFeatures(a)};c.prototype.queryObjectIds=function(a){return this._ensureQueryEngine().queryObjectIds(a)};c.prototype._ensureQueryEngine=function(){this._queryEngine||(this._queryEngine=
this._createQueryEngine());return this._queryEngine};c.prototype._createQueryEngine=function(){var a=this,b={id:0,index:0,object:null,bbCorners:new Float64Array(24)};return new na({forAll:function(d,c){a._forAllFeatures(function(c,e,k){b.id=c;b.index=e;b.object=k;a._boundingBoxCornerPoints(b.index,b.object,b.bbCorners);d(b)},c)},createGraphic:function(b){return a._createGraphic(b.index,b.object.getMetadata())},requestFields:function(b,c,f){return v.whenGraphicAttributes(a.layer,c,a._getObjectIdField(),
f,function(){var d=a._getGraphicIndices(b.node,b.bundleNr,c);return{node:b.node,indices:d}},{ignoreUnavailableFields:!1})},createExtentBuilder:function(){return a._createExtentBuilder()}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})};c.prototype._createExtentBuilder=function(){var a=this.view.renderSpatialReference,b=this.view.spatialReference,d=l.create(l.NEGATIVE_INFINITY),c=new Float64Array(24);return{add:function(e){I.bufferToBuffer(e.bbCorners,a,0,c,b,0,8)&&l.expandBuffer(d,
c,0,8)},getExtent:function(){return l.toExtent(d,b)}}};c.prototype._forAllFeatures=function(a,b,d){for(var c=0,f=Object.keys(this._nodeId2Meta);c<f.length;c++)for(var g=f[c],k=this._nodeId2Meta[g].engineObjects,l=0;l<k.length;l++)this._forAllFeaturesOfObject(k[l],a,d),b&&b({node:this._controller.nodeIndex[g],bundleNr:l})};c.prototype._forAllFeaturesOfObject=function(a,b,d){for(var c=a.getMetadata().featureIds,f=a.getGeometryRecords()[0],g=0;g<c.length;g++)(d||a.getComponentVisibility(f,g))&&b(c[g],
g,a,f)};c.prototype._createGraphic=function(a,b){var d={};null!=b.featureIds&&(d[this._getObjectIdField()]=b.featureIds[a]);if(null!=b.attributeData)for(var c=0,f=Object.keys(b.attributeData);c<f.length;c++){var g=f[c];d[g]=v.getCachedAttributeValue(b.attributeData[g],a)}a=new H(null,null,d);a.layer=this.layer;return a};c.prototype._boundingBoxCornerPoints=function(a,b,d){a=b.geometries[0].getComponentAABB(a,Y);for(var c=0;8>c;++c)D[0]=c&1?a[0]:a[3],D[1]=c&2?a[1]:a[4],D[2]=c&4?a[2]:a[5],F.mat4d.multiplyVec3(b.objectTransformation,
D),d[3*c]=D[0],d[3*c+1]=D[1],d[3*c+2]=D[2];return d};c.prototype.highlight=function(a,b){var d=this,c=this._highlights;if(a instanceof ja){b=c.acquireSet(b);var f=b.set,g=b.handle;this.queryObjectIds(a).then(function(a){return c.setFeatureIds(f,a)});return g}if("number"===typeof a||a instanceof H)return this.highlight([a],b);a instanceof ca&&(a=a.toArray());if(Array.isArray(a)&&0<a.length){if(a[0]instanceof H)return a=a.map(function(a){return P.attributeLookup(a.attributes,d._getObjectIdField())}),
g=c.acquireSet(b),b=g.set,g=g.handle,c.setFeatureIds(b,a),g;if("number"===typeof a[0])return g=c.acquireSet(b),b=g.set,g=g.handle,c.setFeatureIds(b,a),g}return{remove:function(){}}};c.prototype.visibleGeometryChanged=function(a){var b=this;a?this._elevationProvider.objectChanged(a):this._elevationProvider.layerChanged();null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=da.schedule(function(){b.emit("visible-geometry-changed");b._visibleGeometryChangedSchedulerHandle=
null}))};z([q.property()],c.prototype,"layer",void 0);z([q.property()],c.prototype,"_controller",void 0);z([q.property({dependsOn:["_controller.updating"]})],c.prototype,"updating",void 0);z([q.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],c.prototype,"updatingPercentageValue",void 0);z([q.property({readOnly:!0})],c.prototype,"hasTexturesOrVertexColors",null);z([q.property({readOnly:!0,dependsOn:["layer.renderer"]})],c.prototype,"rendererNeedsTextures",null);z([q.property({readOnly:!0,
dependsOn:["layer.elevationInfo"]})],c.prototype,"elevationOffset",null);z([q.property()],c.prototype,"alwaysLoadEverythingModeEnabled",void 0);z([q.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","_useCompressedTextures"]})],c.prototype,"uncompressedTextureDownsamplingEnabled",null);z([q.property({dependsOn:["layer.version"]})],c.prototype,"_useCompressedTextures",null);return c=z([q.subclass("esri.views.3d.layers.SceneLayerView3D")],c)}(q.declared(ka,
qa));var D=F.vec3d.create(),Y=l.create(),Aa=l.create(),za=F.vec4d.create(),G=[0,0,0,0];return R});