// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../Graphic ../../../../core/promiseUtils ../../../../core/Error ./LayerAdapter ./FeatureLayerAdapter ../../../../tasks/support/FeatureSet ../../../../core/accessorSupport/decorators ../utils ../../../../layers/support/fieldUtils".split(" "),function(A,B,u,v,m,d,k,w,x,n,p,q,r){return function(t){function c(a){var b=t.call(this)||this;b._layer=a.layer;return b}u(c,t);c.prototype._hasCachedStatistics=
function(a){return this._layer.hasCachedStatistics(a)};c.prototype._generateFeatureSetForCachedHistogram=function(a,b,c,f){void 0===b&&(b=a.minimum);void 0===c&&(c=a.maximum);for(var l=[],h=0;h<f;h++)l[h]=0;for(var e=a.counts.length,y=a.minimum,z=a.maximum,h=0;h<e;h++){var g=(h+.5)/e,g=((1-g)*y+g*z-b)/(c-b)*f;0<=g&&g<=f&&(l[g===f?f-1:Math.floor(g)]+=a.counts[h])}var d=[];l.forEach(function(a,b){var l=new m({attributes:{}});l.attributes.EXPR_1=b+1;l.attributes.countOFExpr=a;d.push(l)});a=new n;a.features=
d;return a};c.prototype._getCachedStatistics=function(a,b){var c=this._layer;return a.valueExpression||a.sqlExpression||a.sqlWhere||a.minValue||a.maxValue?d.reject(new k("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression', 'sqlExpression', 'sqlWhere', 'minValue' or 'maxValue' is specified")):c.queryCachedStatistics(b&&b.name).then(function(a){var b=a.stats;a=b.min;var c=b.max,e=b.avg,f=b.stddev,d=b.sum,g=b.variance,b=b.count;if(0!==a||0!==
c)e=0===e?null:e,d=0===d?null:d,f=0===f?null:f,g=0===g?null:g,b=0===b?null:b;null==b&&null!=d&&null!=e&&(b=Math.round(d/e));return{avg:e,count:b,max:c,min:a,stddev:f,sum:d,variance:g}})};c.prototype._getCachedStatisticsForUniqueValues=function(a,b){var c=this,f=this._layer,l=b&&b.name;return a.valueExpression||a.sqlExpression||a.sqlWhere?d.reject(new k("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression', 'sqlExpression' or 'sqlWhere' is specified")):
f.queryCachedStatistics(l).then(function(h){var e=h.stats;h=h.labels&&h.labels.labels;var d={},k=[];if(e.mostFrequentValues){var g="countOF"+l;e.mostFrequentValues.forEach(function(a){var c=new m({attributes:{}});c.attributes[l]=r.isNumericField(b,f)||r.isDateField(b)?Number(a.value):a.value;c.attributes[g]=a.count;k.push(c)});h&&h.forEach(function(a){d[a.value]=a.label})}e=new n;e.features=k;return q.getUniqueValuesFromFeatureSet(e,c,a.field,d)})};c.prototype._getCachedStatisticsForHistogram=function(a,
b){var c=this,f=this._layer;return a.valueExpression||a.sqlExpression||a.sqlWhere||a.normalizationType?d.reject(new k("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression' or 'sqlExpression' or 'sqlWhere' or 'normalizationType' is specified")):f.queryCachedStatistics(b&&b.name).then(function(b){b=b.stats;var d=a.minValue,e=a.maxValue,d=null!=d?d:b.min,e=null!=e?e:b.max,f=a.numBins||10;b=c._generateFeatureSetForCachedHistogram(b.histogram,d,
e,f);return q.getHistogramFromFeatureSet(b,d,e,f)})};c.prototype.getField=function(a){void 0===a&&(a="");return this._layer.getField(a)};c.prototype.getFieldUsageInfo=function(a){var b=this.getField(a);if(!b)return null;a=this._layer.getFieldUsageInfo(a);return{supportsLabelingInfo:a.supportsLabelingInfo,supportsPopupTemplate:a.supportsPopupTemplate,supportsRenderer:a.supportsRenderer,supportsLayerQuery:a.supportsLayerQuery,supportsStatistics:a.supportsLayerQuery||this._hasCachedStatistics(b.name)}};
c.prototype.getFieldDomain=function(a,b){return this._featureLayerAdapter?this._featureLayerAdapter.getFieldDomain(a,b):null};c.prototype.summaryStatistics=function(a){var b=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.summaryStatistics(a):this._hasCachedStatistics(b&&b.name)?this._getCachedStatistics(a,b):d.reject(new k("scene-layer-adapter:not-supported","Layer does not support statistics query"))};c.prototype.uniqueValues=function(a){var b=this.getField(a.field);
return this._featureLayerAdapter?this._featureLayerAdapter.uniqueValues(a):this._hasCachedStatistics(b&&b.name)?this._getCachedStatisticsForUniqueValues(a,b):d.reject(new k("scene-layer-adapter:not-supported","Layer does not support statistics query"))};c.prototype.histogram=function(a){var b=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.histogram(a):this._hasCachedStatistics(b&&b.name)?this._getCachedStatisticsForHistogram(a,b):d.reject(new k("scene-layer-adapter:not-supported",
"Layer does not support statistics query"))};c.prototype.queryFeatureCount=function(a){return this._featureLayerAdapter?this._featureLayerAdapter.queryFeatureCount(a):d.reject(new k("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support count query"))};c.prototype.generateRenderer=function(a){return this._featureLayerAdapter?this._featureLayerAdapter.generateRenderer(a):d.reject(new k("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support generateRenderer operation"))};
c.prototype.getAllFeatures=function(a){return this._featureLayerAdapter?this._featureLayerAdapter.getAllFeatures(a):d.reject(new k("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer is not supported"))};c.prototype.load=function(){var a=this,b=this._layer,c=b.load().then(function(){var c=b.associatedLayer;a.geometryType=b.geometryType;if(c)return a._featureLayerAdapter=new x({layer:c}),a._featureLayerAdapter.load().then(function(){a.objectIdField=a._featureLayerAdapter.objectIdField;
a.supportsSQLExpression=a._featureLayerAdapter.supportsSQLExpression});a.objectIdField=b.objectIdField;a.supportsSQLExpression=!1});this.addResolvingPromise(c);return this.when()};return c=v([p.subclass()],c)}(p.declared(w))});