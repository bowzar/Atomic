// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../core/ObjectPool ../../../core/HandleRegistry ./LayerView2D ../engine/Bitmap ../engine/BitmapSource ../engine/BitmapContainer ../engine/Canvas2DContainer ../engine/Tiled ../../../geometry/support/webMercatorUtils ../tiling/TileStrategy ../tiling/TileKey ../tiling/TileInfoView ../tiling/TileQueue ../../layers/RefreshableLayerView".split(" "),function(D,
E,h,k,g,l,m,n,p,q,r,t,u,v,w,x,y,z,A){var B=function(d){function a(b){b=d.call(this,b)||this;b.key=new x(0,0,0,0);return b}h(a,d);a.prototype.acquire=function(b){};a.prototype.release=function(){this.key.set(0,0,0,0)};a.pool=new l(a,!0);return a}(u(p)),C=[102113,102100,3857,3785,900913];return function(d){function a(){var b=null!==d&&d.apply(this,arguments)||this;b._handles=new m;b._tileStrategy=null;b._tileInfoView=null;b._fetchQueue=null;b._tileRequests=new Map;b.container=new t;b.layer=null;return b}
h(a,d);a.prototype.hitTest=function(b,c){return null};a.prototype.update=function(b){this._fetchQueue.pause();this._fetchQueue.state=b.state;this._tileStrategy.update(b);this._fetchQueue.resume();this.notifyChange("updating")};a.prototype.attach=function(){var b=this,c=this.layer.activeLayer,e;c.tileMatrixSetId?e=c.tileMatrixSet:(e=this._getTileMatrixSetBySpatialReference(c),c.tileMatrixSetId=e.id);var a=e.tileInfo.spatialReference,f=c.fullExtent&&c.fullExtent.clone();a.isWebMercator?f=v.geographicToWebMercator(f):
a.isWGS84||(f=e.fullExtent);this._tileContainer=new r;this.container.addChild(this._tileContainer);this._tileInfoView=new y(e.tileInfo,f);this._fetchQueue=new z({tileInfoView:this._tileInfoView,process:function(c){return b.fetchTile(c)}});this._tileStrategy=new w({cachePolicy:"keep",acquireTile:function(c){return b.acquireTile(c)},releaseTile:function(c){return b.releaseTile(c)},tileInfoView:this._tileInfoView});this._handles.add(c.watch("styleId",function(c){b._refresh()}));this._handles.add(this.layer.watch("activeLayer",
function(c){if(!c.tileMatrixSetId){var a=b._getTileMatrixSetBySpatialReference(b.layer.activeLayer);c.tileMatrixSetId=a.id}b._refresh()}))};a.prototype.detach=function(){this._handles.removeAll();this._tileStrategy.destroy();this._fetchQueue.clear();this.container.removeChild(this._tileContainer);this._fetchQueue=this._tileStrategy=this._tileInfoView=this._tileContainer=null};a.prototype.moveStart=function(){this.requestUpdate()};a.prototype.viewChange=function(){this.requestUpdate()};a.prototype.moveEnd=
function(){this.requestUpdate()};a.prototype.doRefresh=function(){this.updateRequested||this.suspended||this._refresh()};a.prototype.isUpdating=function(){var b=!0;this._tileRequests.forEach(function(c){b=b&&c.isFulfilled()});return!b};a.prototype.getTileBounds=function(b,c){return this._tileStrategy.tileInfoView.getTileBounds(b,c)};a.prototype.getTileCoords=function(b,c){return this._tileStrategy.tileInfoView.getTileCoords(b,c)};a.prototype.getTileResolution=function(b){return this._tileStrategy.tileInfoView.getTileResolution(b)};
a.prototype.acquireTile=function(b){var c=this,a=B.pool.acquire();a.key.set(b);this._tileInfoView.getTileCoords(a.coords,a.key);a.resolution=this._tileInfoView.getTileResolution(a.key);b=this._tileInfoView.tileInfo.size;a.width=b[0];a.height=b[1];b=this._fetchQueue.push(a.key).then(function(b){a.source=b;a.once("attach",function(){return c.requestUpdate()});c._tileContainer.addChild(a)});this._tileRequests.set(a,b);this.requestUpdate();return a};a.prototype.releaseTile=function(b){var a=this._tileRequests.get(b);
a.isFulfilled()||a.cancel();this._tileRequests.delete(b);this._tileContainer.removeChild(b);this.requestUpdate()};a.prototype.fetchTile=function(b){var a=this;return this.layer.fetchTile(b.level,b.row,b.col).then(function(c){c=q.pool.acquire(c);c.coords=a.getTileCoords(c.coords,b);c.resolution=a.getTileResolution(b);return c})};a.prototype._refresh=function(){var b=this;this._fetchQueue.reset();this._tileStrategy.tiles.forEach(function(a){if(a.source){a.source=null;var c=b._fetchQueue.push(a.key).then(function(c){a.source=
c;a.requestRender();b.notifyChange("updating")});b._tileRequests.set(a,c)}});this.notifyChange("updating")};a.prototype._getTileMatrixSetBySpatialReference=function(b){var a=this.view.spatialReference,e=a.wkid,d=b.tileMatrixSets.find(function(a){return a.tileInfo.spatialReference.wkid===e});!d&&a.isWebMercator&&(d=b.tileMatrixSets.find(function(a){return-1<C.indexOf(a.tileInfo.spatialReference.wkid)}));return d};k([g.property({dependsOn:["updateRequested","attached"]})],a.prototype,"updating",void 0);
return a=k([g.subclass("esri.views.2d.layers.WMTSLayerView2D")],a)}(g.declared(n,A))});