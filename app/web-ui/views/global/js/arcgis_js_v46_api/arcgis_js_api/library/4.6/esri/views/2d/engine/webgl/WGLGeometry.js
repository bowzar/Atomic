// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../webgl/BufferObject","./FreeList","./enums"],function(m,n,l,g,k){return function(){function c(){this._bufferSpec={};this._ibFreeList=this._vbFreeList=null;this.vertexBufferMap={};this.vertexBufferMapCPU={};this.vao=this.indexBufferCPU=this.indexBuffer=null;this.usage=35044}Object.defineProperty(c.prototype,"attached",{get:function(){return null!==this.indexBuffer},enumerable:!0,configurable:!0});c.prototype.attach=function(a){for(var b in this._bufferSpec)this.vertexBufferMap[b]=
l.createVertex(a.context,this.usage,this.vertexBufferMapCPU[b].buffer);this.indexBufferCPU&&(this.indexBuffer=l.createIndex(a.context,this.usage,this.indexBufferCPU));return!0};c.prototype.initializeEmpty=function(a,b,d,f){void 0===f&&(f=35044);this.clear();this.usage=f;d&&(this.indexBufferCPU=new Uint32Array(d));var h;for(f=0;f<a.length;f++){var e=a[f];h=0!==e.divisor?Math.ceil(b/e.divisor):b;h*=e.strideInBytes;this._bufferSpec[e.name]=e;this.vertexBufferMapCPU[e.name]=new Uint32Array(h/4)}this._vbFreeList=
g.create(b);d&&(this._ibFreeList=g.create(d))};c.prototype.initializeWithRecords=function(a,b,d){void 0===d&&(d=35044);b.sort(function(a,b){return a.sortKey-b.sortKey});for(var f=0,h=0,e=0;e<b.length;e++){var c=b[e],f=f+c.meshData.vertexCount;c.meshData.indexData&&(h+=c.meshData.indexData.length);c.indexFrom=void 0;c.indexCount=0;c.vertexFrom=void 0;c.vertexCount=0}this.initializeEmpty(a,Math.floor(1.5*f),Math.floor(1.5*h),d);this.update(b)};c.prototype.initializeWithBuffers=function(a,b,d){void 0===
d&&(d=35044);this.clear();this.usage=d;this.indexBufferCPU=b.indexBuffer;d=this.indexBufferCPU.length;for(var f=void 0,c=0;c<a.length;c++){var e=a[c];this._bufferSpec[e.name]=e;this.vertexBufferMapCPU[e.name]=b.vertexBuffer[e.name].data;e=b.vertexBuffer[e.name].data.buffer.byteLength/e.strideInBytes;void 0!==f&&f!==e?console.error("Buffers with different vertex counts."):f=e}this._vbFreeList=g.create(f);this._vbFreeList.allocate(f);this._ibFreeList=g.create(d);this._ibFreeList.allocate(d)};c.prototype.clear=
function(){this.indexBuffer&&(this.indexBuffer.dispose(),this.indexBuffer=null);this.indexBufferCPU=null;for(var a in this.vertexBufferMap)this.vertexBufferMap[a].dispose(),delete this.vertexBufferMap[a];this.vertexBufferMap={};this.vertexBufferMapCPU={};this.vao&&(this.vao.dispose(),this.vao=null);this._bufferSpec={};this._ibFreeList=this._vbFreeList=null};c.prototype.update=function(a){for(var b=0;b<a.length;b++){var d=this._updateRecord(a[b]);if(d!==k.WGLGeometryTransactionStatus.SUCCEEDED)return d}return k.WGLGeometryTransactionStatus.SUCCEEDED};
c.prototype._updateRecord=function(a){var b;void 0===a.vertexFrom||a.vertexCount!==a.meshData.vertexCount?(void 0!==a.vertexFrom&&this._vbFreeList.free(a.vertexFrom,a.vertexCount),b=0<a.meshData.vertexCount?this._vbFreeList.allocate(a.meshData.vertexCount):-1):b=a.vertexFrom;-1!==b?(a.vertexFrom=b,a.vertexCount=a.meshData.vertexCount):(a.vertexFrom=void 0,a.vertexCount=0);var d=a.meshData.indexData?a.meshData.indexData.length:0;void 0===a.indexFrom||a.indexCount!==d?(void 0!==a.indexFrom&&this._ibFreeList.free(a.indexFrom,
a.indexCount),b=0<d?this._ibFreeList.allocate(d):-1):b=a.indexFrom;-1!==b?(a.indexFrom=b,a.indexCount=d):(a.indexFrom=void 0,a.indexCount=0);if(void 0!==a.vertexFrom&&void 0!==a.indexFrom){var f;f=d=b=b=void 0;for(var c in a.meshData.vertexData){b=this._bufferSpec[c].divisor;f=0!==b?a.vertexFrom/b:a.vertexFrom;b=this.vertexBufferMapCPU[c];var d=a.meshData.vertexData[c],e=d.length;f=f*this._bufferSpec[c].strideInBytes/4;for(var g=0;g<e;g++)b[f+g]=d[g]}c=a.vertexFrom;d=(b=a.meshData.indexData)?b.length:
0;for(e=0;e<d;++e)this.indexBufferCPU[a.indexFrom+e]=c+b[e];return k.WGLGeometryTransactionStatus.SUCCEEDED}return k.WGLGeometryTransactionStatus.FAILED_OUT_OF_MEMORY};c.prototype.remove=function(a){for(var b=0;b<a.length;b++)this._removeRecord(a[b])};c.prototype._removeRecord=function(a){this._vbFreeList.free(a.vertexFrom,a.vertexCount);a.vertexFrom=void 0;a.vertexCount=0;this._ibFreeList.free(a.indexFrom,a.indexCount);a.indexFrom=void 0;a.indexCount=0};c.prototype.invalidateIndexBuffer=function(){var a=
this.indexBuffer;a&&a.setData(this.indexBufferCPU)};c.prototype.invalidateVertexBuffers=function(a){if(!a){a=[];for(var b in this.vertexBufferMap)a.push(b)}for(var d=0;d<a.length;d++){b=a[d];var c=this.vertexBufferMap[b];c&&c.setData(this.vertexBufferMapCPU[b].buffer)}};return c}()});