// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./Graphics3DDrapedGraphicLayer ./ElevationAligners ./Graphics3DSymbolCommonCode ./lineUtils ../../../../core/screenUtils ../../../../geometry/Polygon ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/RenderGeometry ./graphicUtils".split(" "),function(P,Q,E,F,G,H,I,m,w,A,J,B,C,K,L,M,N){var D=B.vec3d,x=B.mat4d;
return function(r){function f(){return null!==r&&r.apply(this,arguments)||this}E(f,r);f.prototype._prepareResources=function(){var a=this.symbol,b=this._isPropertyDriven("size")||this._isPropertyDriven("color")||this._isPropertyDriven("opacity"),a={idHint:this._getStageIdHint(),width:this._getWidth(a),color:this._getMaterialOpacityAndColor()};if(!this._isPropertyDriven("size")){var c=N.validateSymbolLayerSize(a.width);if(c){this._logWarning(c);this.reject();return}}if(b||1.5<=a.width)this._isPropertyDriven("size")&&
(a.width=0),this._material=w.createRibbonMaterial(a);else if(0<a.width)this._material=w.createNativeMaterial(a);else{this.reject();return}this._context.stage.add(C.ModelContentType.MATERIAL,this._material);this.resolve()};f.prototype._getWidth=function(a){return null!=a.size?A.pt2px(a.size):1};f.prototype.destroy=function(){r.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(C.ModelContentType.MATERIAL,this._material.getId()),this._material=
null)};f.prototype.createGraphics3DGraphic=function(a,b){var c=this._validateGeometry(a.geometry);if("polyline"!==c.type&&"polygon"!==c.type&&"extent"!==c.type)return this._logWarning("unsupported geometry type for line symbol: "+c.type),null;var c="polygon"===c.type||"extent"===c.type?"rings":"paths",d="graphic"+a.uid,f=this._getVertexOpacityAndColor(b,Float32Array,255),h=0;b.size&&this._isPropertyDriven("size")&&(h=m.getSingleSizeDriver(b.size),h=A.pt2px(h));b=this.getGraphicElevationContext(a);
return"on-the-ground"===b.mode?this._createAsOverlay(a,c,f,h,b,d):this._createAs3DShape(a,c,f,h,b,d,a.uid)};f.prototype.layerPropertyChanged=function(a,b,c){if("opacity"===a)return b=this._material.getColor(),this._material.setColor([b[0],b[1],b[2],this._getMaterialOpacity()]),!0;if("elevationInfo"===a){a=this._elevationContext.mode;this._updateElevationContext();var d=this._elevationContext.mode;if(null==a||null==d)return!1;if("on-the-ground"===a&&"on-the-ground"===d)return!0;if(a!==d&&("on-the-ground"===
a||"on-the-ground"===d))return!1;a=m.needsElevationUpdates2D(d);for(var f in b){var h=b[f];(d=c(h))&&!d.isDraped()&&(h=h.graphic,d.needsElevationUpdates=a,d.elevationContext.set(this.getGraphicElevationContext(h)))}return!0}return!1};f.prototype._getOutlineGeometry=function(a,b){return b};f.prototype._getGeometry=function(a){a=this._validateGeometry(a.geometry);"extent"===a.type&&(a=J.fromExtent(a));return a};f.prototype._createAs3DShape=function(a,b,c,f,z,h,O){var g=this._getGeometry(a),d=g.hasZ,
e=g[b],q=this._getOutlineGeometry(g,e);a=[];var k=[],n=[],p=D.create(),r=Array(6),g=m.getGeometryVertexData3D(q,d,g.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,z);this._logGeometryCreationWarnings(g,e,b,"LineSymbol3DLayer");if(0<q.length){for(var e=g.geometryData.outlines,q=g.eleVertexData,d=g.vertexData,y=0;y<e.length;++y){var u=e[y];if(!(1>=u.count)){var l=u.index,v=u.count;if(this._context.clippingExtent&&(m.computeBoundingBox(q,
l,v,r),m.boundingBoxClipped(r,this._context.clippingExtent)))continue;m.chooseOrigin(d,l,v,p);m.subtractCoordinates(d,l,v,p);u=new Float64Array(q.buffer,3*l*q.BYTES_PER_ELEMENT,3*v);l=new Float64Array(d.buffer,3*l*d.BYTES_PER_ELEMENT,3*v);l=w.createPolylineGeometry(l,u,"rings"===b,c,f);l=new L(l,h+"path"+y);l.singleUse=!0;a.push(l);k.push([this._material]);l=x.identity();x.translate(l,p,l);n.push(l)}}if(0<a.length)return b=new K({geometries:a,materials:k,transformations:n,castShadow:!1,metadata:{layerUid:this._context.layer.uid,
graphicId:O},idHint:h}),b=new G(this,b,a,null,null,I.perVertexElevationAligner,z),b.alignedTerrainElevation=g.terrainElevation,b.needsElevationUpdates=m.needsElevationUpdates2D(z.mode),b}return null};f.prototype._createAsOverlay=function(a,b,f,d,r,h){var c=this._getGeometry(a);this._material.setRenderPriority(this._symbolLayerOrder);var g=c[b],t=this._getOutlineGeometry(c,g);a=[];var e=Array(6),q=D.create(),c=m.getGeometryVertexDataDraped(t,c.spatialReference,this._context.overlaySR);this._logGeometryCreationWarnings(c,
g,b,"LineSymbol3DLayer");if(0<t.length){g=c.vertexData;t=c.geometryData.outlines;for(c=0;c<t.length;++c){var k=t[c],n=k.index,k=k.count;m.computeBoundingBox(g,n,k,e);if(!m.boundingBoxClipped(e,this._context.clippingExtent)){m.chooseOrigin(g,n,k,q);m.subtractCoordinates(g,n,k,q);m.setZ(g,n,k,this._getDrapedZ());k=new Float64Array(g.buffer,3*n*g.BYTES_PER_ELEMENT,3*k);n=x.identity();x.translate(n,q,n);var k=w.createPolylineGeometry(k,null,"rings"===b,f,d),p=new M(k);p.material=this._material;p.center=
[.5*(e[0]+e[3]),.5*(e[1]+e[4]),0];p.bsRadius=.5*Math.sqrt((e[3]-e[0])*(e[3]-e[0])+(e[4]-e[1])*(e[4]-e[1]));p.transformation=n;p.name=h;p.uniqueName=h+"#"+k.id;a.push(p)}}return new H(this,a,null,null,e,r)}return null};return f}(F)});