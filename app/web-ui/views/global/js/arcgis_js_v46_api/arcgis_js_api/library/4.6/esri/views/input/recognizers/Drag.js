// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../core/tsSupport/extendsHelper","../InputHandler","./support"],function(e,h,k,l,m){Object.defineProperty(h,"__esModule",{value:!0});e=function(e){function b(){var a=e.call(this,!1)||this;a._startStateModifiers=new Set;a._activePointers=[];a._activePointerMap=new Map;a._isDragging=!1;a._drag=a.registerOutgoing("drag");a.registerIncoming("pointer-drag",a._handlePointerDrag.bind(a));a.registerIncoming("pointer-down",a._handlePointerDown.bind(a));a.registerIncoming("pointer-up",
a._handlePointerUpAndPointerLost.bind(a));a.registerIncoming("pointer-capture-lost",a._handlePointerUpAndPointerLost.bind(a));return a}k(b,e);b.prototype._createPayload=function(a,d){return{action:a,pointers:this._activePointers.map(function(a){return a.data}),startState:this._startState,previousState:this._previousState,currentState:d}};b.prototype._fitCircleLSQ=function(){var a=this._activePointers.map(function(a){return a.data.currentEvent});return m.fitCircleLSQ(a)};b.prototype._createDragState=
function(a){for(var d=this._fitCircleLSQ(),g=0,c=0,b=this._activePointers;c<b.length;c++){for(var e=b[c],f=this._pointerAngle(e,d),f=f-e.lastAngle;f>Math.PI;)f-=2*Math.PI;for(;f<-Math.PI;)f+=2*Math.PI;f=e.lastAngle+f;e.lastAngle=f;g+=f-e.initialAngle}g/=this._activePointers.length;return{angle:g,radius:d.radius,center:d.center,timestamp:a}};b.prototype._updateMultiPointer=function(a,d){var b=a.startEvent.native.pointerId,c=this._activePointerMap.get(b),e=!c;e?(c={data:null,initialAngle:0,lastAngle:0},
this._activePointers.push(c),this._activePointerMap.set(b,c),c.data={startEvent:a.startEvent,previousEvent:a.previousEvent,currentEvent:a.currentEvent},a=this._fitCircleLSQ(),c.initialAngle=this._pointerAngle(c,a),c.lastAngle=c.initialAngle):c.data={startEvent:c.data.startEvent,previousEvent:a.previousEvent,currentEvent:a.currentEvent};e&&this._isDragging&&this._updateInitialAngles(d);return c};b.prototype._pointerAngle=function(a,d){a=a.data.currentEvent;return Math.atan2(a.y-d.center.y,a.x-d.center.x)};
b.prototype._updateInitialAngles=function(a){a=this._createDragState(a);for(var d=0,b=this._activePointers;d<b.length;d++){var c=b[d];c.initialAngle=this._pointerAngle(c,a)}};b.prototype._emitStart=function(a){this._updateInitialAngles(a.timestamp);var d=this._createDragState(a.timestamp);this._previousState=this._startState=d;this._startStateModifiers=a.modifiers;this._isDragging=!0;for(var b=0,c=this._activePointers;b<c.length;b++){var e=c[b];e.data={previousEvent:e.data.currentEvent,startEvent:e.data.currentEvent,
currentEvent:e.data.currentEvent}}this._drag.emit(this._createPayload("start",d),a.timestamp)};b.prototype._emitUpdate=function(a){a=this._createDragState(a.timestamp);this._drag.emit(this._createPayload("update",a),void 0,this._startStateModifiers);this._previousState=a};b.prototype._emitEnd=function(a){a=this._createDragState(a);this._drag.emit(this._createPayload("end",a),void 0,this._startStateModifiers);this._startState=this._previousState=null;this._isDragging=!1};b.prototype._handlePointerDown=
function(a){var b=a.data;this._isDragging&&this._emitEnd(a.timestamp);this._updateMultiPointer({startEvent:b,previousEvent:b,currentEvent:b},a.timestamp)};b.prototype._removeMultiPointer=function(a,b){var d=a.native.pointerId,c=this._activePointerMap.get(d);c&&(this._isDragging&&(this._updateMultiPointer({startEvent:c.data.startEvent,previousEvent:c.data.currentEvent,currentEvent:a},b),this._emitEnd(b)),this._activePointerMap.delete(d),a=this._activePointers.indexOf(c),this._activePointers.splice(a,
1),this._isDragging&&this._updateInitialAngles(b))};b.prototype._handlePointerUpAndPointerLost=function(a){this._removeMultiPointer(a.data,a.timestamp)};b.prototype._handlePointerDrag=function(a){var b=a.data;switch(b.action){case "start":this._isDragging||this._emitStart(a);break;case "update":this._isDragging||this._emitStart(a),this._updateMultiPointer(b,a.timestamp),this._emitUpdate(a)}};return b}(l.InputHandler);h.Drag=e});