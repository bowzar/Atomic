// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../../../lib/glMatrix ../../../input/util ../../../webgl-engine/lib/Camera ../InteractiveController ./MomentumController ../../utils/navigationUtils ../../utils/navigationUtils ../../../camera/constraintUtils".split(" "),function(k,n,q,e,p,r,t,u,f,m,g){Object.defineProperty(n,"__esModule",{value:!0});k=function(k){function c(b,d){var a=k.call(this)||this;a.view=b;a.pickingHelper=d;a.smoothRotation=new p.ExponentialFalloff(.05);a.rotationAxis=
e.vec3d.create();a.panningCenterScene=e.vec3d.create();a.panningPlane={normal:e.vec3d.create(),d:0};a.smoothScaling=new p.ExponentialFalloff(.05);a.zoomCenterScreen=e.vec2d.create();a.beginScenePoints={points:[],center:e.vec3d.create()};a.adjustedSphere={center:e.vec3d.create(),radius:0};a.panMode=m.PanMode.Horizontal;a.tmp2d=e.vec2d.create();a.tmp3d=e.vec3d.create();a.tmpInteractionDirection=e.vec3d.create();a.beginScreenPoint=e.vec2d.create();a.screenPickPoint=e.vec2d.create();a.currentPoints=[];
a.currentCenter=e.vec3d.create();a.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new r,interactionDirection:null};a.momentumController=new u.MomentumController(b);return a}q(c,k);c.prototype.begin=function(b,d,a){if(this.active){this.beginRadius=d.radius;f.navPointToScreenPoint(this.currentCamera,d.center,this.screenPickPoint);e.vec2d.set(this.screenPickPoint,this.beginScreenPoint);a=f.pickPointAndInitSphere(this.pickingHelper,this.beginCamera,this.screenPickPoint,
!0);this.scenePickPoint=a.scenePickPoint;this.sphere=a.sphere;this.panMode=f.decidePanMode(this.beginCamera,this.sphere,this.scenePickPoint);if(this.panMode===m.PanMode.Horizontal)this.computeSpherePoints(b,"startEvent",this.sphere,this.beginCamera,this.beginScenePoints.points),f.centroidOnSphere(this.sphere.radius,this.beginScenePoints.points,this.beginScenePoints.center);else{e.vec3d.set(this.beginCamera.viewForward,this.panningPlane.normal);e.vec3d.normalize(this.panningPlane.normal);e.vec3d.negate(this.panningPlane.normal);
f.setPlane(this.scenePickPoint,this.panningPlane.normal,this.panningPlane);b=e.vec3d.create();e.vec3d.set3(this.screenPickPoint[0],this.currentCamera.height,0,b);a=e.vec3d.create();var l=e.vec3d.length(this.beginCamera.eye);this.adjustedSphere.radius=l<this.sphere.radius?l-100:this.sphere.radius;f.sphereOrSilhouettePointFromScreenPoint(this.adjustedSphere,this.beginCamera,b,a);this.beginCamera.projectPoint(a,b);this.screenPickPoint[1]=Math.min(this.screenPickPoint[1],.9*b[1]);this.pickingHelper.pickPointInScreen(this.screenPickPoint,
this.scenePickPoint)&&f.setPlane(this.scenePickPoint,this.panningPlane.normal,this.panningPlane);f.navPointToScreenPoint(this.currentCamera,d.center,this.tmp2d);f.intersectPlaneFromScreenPoint(this.panningPlane,this.beginCamera,this.tmp2d,this.panningCenterScene)}this.constraintOptions.interactionStartCamera.copyFrom(this.beginCamera)}};c.prototype.update=function(b,d,a){if(this.active){this.currentCamera.copyFrom(this.beginCamera);var e=1<b.length;this.panMode===m.PanMode.Horizontal?(e&&this.zoomSpherical(d,
a),this.panningSpherical(b,d,a),e&&this.rotateSpherical(b,d,a)):(e&&this.zoomPlanar(b,d,a),this.panningPlanar(b,d,a),e&&this.rotatePlanar(b,d,a));this.currentCamera.markViewDirty()}};c.prototype.end=function(){this.panMode===m.PanMode.Horizontal?this.momentumController.setParameters(this.sphere.radius,this.panMode,this.zoomCenterScreen,this.beginScenePoints.center):this.momentumController.setParameters(this.sphere.radius,this.panMode,this.zoomCenterScreen,this.panningCenterScene);this.finishController();
return this.momentumController.initiate()?this.momentumController:null};c.prototype.computeSpherePoints=function(b,d,a,l,h){h.length=b.length;for(var g=this.tmp2d,c=0;c<h.length;c++)f.navPointToScreenPoint(l,b[c][d],g),void 0===h[c]&&(h[c]=e.vec3d.create()),f.sphereOrSilhouettePointFromScreenPoint(a,l,g,h[c]);return h};c.prototype.zoomSpherical=function(b,d){var a=this.currentCamera.height,c=this.beginRadius/b.radius;this.smoothScaling.gain=.001875*Math.min(Math.max(b.radius,40),120);this.smoothScaling.update(c);
f.applyZoomOnSphere(this.sphere,this.currentCamera,this.smoothScaling.value);e.vec2d.set2(b.center.x,a-b.center.y,this.zoomCenterScreen);this.momentumController.addScaleValue(d,this.smoothScaling.value);this.constraintOptions.interactionType=1;this.constraintOptions.interactionFactor=g.pixelDistanceToInteractionFactor(b.radius-this.beginRadius);g.applyAll(this.view,this.currentCamera,this.constraintOptions)};c.prototype.panningSpherical=function(b,d,a){this.currentPoints;this.computeSpherePoints(b,
"currentEvent",this.sphere,this.currentCamera,this.currentPoints);f.centroidOnSphere(this.sphere.radius,this.currentPoints,this.currentCenter);f.navPointToScreenPoint(this.currentCamera,d.center,this.tmp2d);f.applyPanSpherical(this.sphere,this.currentCamera,this.beginScenePoints.center,this.currentCenter,{estimator:this.momentumController,time:a,endScreenPoint:this.tmp2d});this.constraintOptions.interactionType=4;this.constraintOptions.interactionFactor=g.pixelDistanceToInteractionFactor(this.screenPickPoint,
this.tmp2d);g.applyAll(this.view,this.currentCamera,this.constraintOptions)};c.prototype.rotateSpherical=function(b,d,a){var c=b.length;e.vec3d.normalize(this.beginScenePoints.center,this.rotationAxis);this.computeSpherePoints(b,"currentEvent",this.sphere,this.currentCamera,this.currentPoints);for(var h=b=0;h<c;h++)b+=f.rotationFromPointsAroundAxis(this.currentPoints[h],this.beginScenePoints.points[h],this.rotationAxis);h=this.smoothRotation.value;c=f.normalizeRotationDelta(b/c-h);b=h+c;this.smoothRotation.gain=
.00125*Math.min(Math.max(d.radius,40),120);this.smoothRotation.update(b);c=this.smoothRotation.value;this.momentumController.addRotationValue(a,c);f.applyRotation(this.currentCamera,this.sphere.center,this.rotationAxis,c);this.constraintOptions.interactionType=2;this.constraintOptions.interactionFactor=g.pixelDistanceToInteractionFactor(d.radius*b);g.applyAll(this.view,this.currentCamera,this.constraintOptions)};c.prototype.panningPlanar=function(b,d,a){f.navPointToScreenPoint(this.currentCamera,
d.center,this.tmp2d);f.intersectPlaneFromScreenPoint(this.panningPlane,this.currentCamera,this.tmp2d,this.tmp3d)&&(f.applyPanPlanar(this.currentCamera,this.panningCenterScene,this.tmp3d,{estimator:this.momentumController,time:a,endScreenPoint:this.tmp2d}),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=g.pixelDistanceToInteractionFactor(this.beginScreenPoint,this.tmp2d),this.constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,
this.tmpInteractionDirection),g.applyAll(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null)};c.prototype.zoomPlanar=function(b,d,a){b=this.beginRadius/d.radius;this.smoothScaling.gain=.001875*Math.min(Math.max(d.radius,40),120);this.smoothScaling.update(b);this.momentumController.addScaleValue(a,this.smoothScaling.value);this.momentumController.setParametersVertical(this.panningCenterScene);f.applyZoomToPoint(this.currentCamera,this.panningCenterScene,
this.smoothScaling.value,this.view.state.constraints.minimumPoiDistance);this.constraintOptions.interactionType=1;this.constraintOptions.interactionFactor=g.pixelDistanceToInteractionFactor(d.radius-this.beginRadius);g.applyAll(this.view,this.currentCamera,this.constraintOptions)};c.prototype.rotatePlanar=function(b,d,a){e.vec3d.set(this.panningCenterScene,this.rotationAxis);var c=d.angle;b=this.smoothRotation.value;c=f.normalizeRotationDelta(c-b);this.smoothRotation.gain=.00125*Math.min(Math.max(d.radius,
40),120);this.smoothRotation.update(b+c);b=this.smoothRotation.value;this.momentumController.addRotationValue(a,b);f.applyRotation(this.currentCamera,this.sphere.center,this.rotationAxis,b);this.constraintOptions.interactionType=2;this.constraintOptions.interactionFactor=g.pixelDistanceToInteractionFactor(d.radius*b);g.applyAll(this.view,this.currentCamera,this.constraintOptions)};return c}(t.InteractiveController);n.PinchAndPanController=k});