// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ./IntervalUtilities ./ModelDirtyTypesTs ./Float32ArrayList ./InstanceBufferData ../lighting/SceneLighting ./LinearDepthTextureHelper ./NormalTextureHelper ./HighlightTextureHelper ./RenderPass ./RenderSlot ./RenderContext ./ExternalRendererContainer ./StencilRenderingHelper ./Util ./gl-matrix ./ComponentUtils ../../../webgl/Texture ../../../webgl/VertexArrayObject ../../../webgl/BufferObject ../../../webgl/Util ./FxaaRenderPass ./SmaaRenderPass ../../../webgl/enums ./DefaultVertexAttributeLocations ../../../webgl/Profiling ../materials/HUDMaterial".split(" "),
function(Z,ua,aa,va,ba,ga,ha,ia,ja,ka,E,u,la,ma,na,K,ca,da,ea,O,S,H,oa,pa,wa,T,qa,ra){function U(e){return da.generateVisibleIndexRanges(e.instanceParameters.componentVisibilities,e.componentOffsets)}function W(e,a,b){var d=e.origin.vec3;V(L,-d[0],-d[1],-d[2]);F.multiply(L,e.transformation,a);F.inverse(a,b);F.transpose(b)}function I(e,a,b){for(var d in e){var c=e[d];a(d,c);for(var f in c.origin2data)b(f,c.origin2data[f])}}function M(e){return!1===e.preinterleaved?sa(e.indices).length:e.indexCount}
var G=K.assert,X=K.objectEmpty,sa=K.getFirstObjectValue,V=K.setMatrixTranslation3;Z=ca.vec2d;var F=ca.mat4d,fa=K.VertexAttrConstants,P=F.identity();K=function(){function e(a,b,d,c,f){this._lighting=new ha.SceneLighting;this._mat2DataMerged={};this._mat2DataInstanced={};this._mat2DataPreinterleaved={};this._renderOrder=[];this._externalRenderers=new ma;this._renderContext=new la;this._isRendering=!1;this._highlights=[];this._pixelRatio=1;this._threshold=1535;this._needsRender=!0;this._fallbackDepthStencilTexture=
null;this._stats=new ta;this.ssaoEnabled=!1;this.renderOptions={antialiasing:"smaa",earlyOcclusionPixelDraw:!1};this._programRep=a;this._materialRep=b;this._orderedRendering=f;this._rctx=c;this._fxaaPass=new oa(c);this._smaaPass=new pa(c);this._renderContext.lightingData=this._lighting.getOld();c.setDepthTestEnabled(!0);c.setFaceCullingEnabled(!0);c.setBlendingEnabled(!1);c.setBlendFunctionSeparate(770,771,1,771);this._bindParameters={view:null,proj:null,viewInvTransp:null,nearFar:null,lightingData:null,
viewport:null,framebufferTex:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null,instanceParameters:null,depthFBO:null,normalFBO:null,extensions:{angleInstancedArrays:c.extensions.angleInstancedArrays}};this._linearDepthTextureHelper=new ia(c);this._normalTextureHelper=new ja(c);this._highlightTextureHelper=new ka(c);this._stencilRenderingHelper=new na(c);this._initializeFramebufferTexture()}e.prototype._initializeFramebufferTexture=function(){var a=this._rctx.gl,a=this._rctx.contextAttributes.alpha?
a.RGBA:a.RGB,b=new ea(this._rctx,{target:3553,pixelFormat:a,dataType:5121,samplingMode:9728,wrapMode:33071,width:4,height:4});this._framebuffer={format:a,texture:b}};e.prototype.dispose=function(){var a=this,b=function(b){a._releaseMaterials(b)},d=function(a,b){if(b.type===z.Preinterleaved)for(var c in b.instances)b.instances[c].vao.dispose(!0);else b.vao.dispose(!0)};I(this._mat2DataMerged,b,d);I(this._mat2DataInstanced,b,d);I(this._mat2DataPreinterleaved,b,d);this._mat2DataPreinterleaved=this._mat2DataInstanced=
this._mat2DataMerged=null;this._framebuffer.texture.dispose();this._framebuffer.texture=null;this._linearDepthTextureHelper.getEnableState()&&this._linearDepthTextureHelper.disable();this._normalTextureHelper.getEnableState()&&this._normalTextureHelper.disable();this._highlightTextureHelper.getEnableState()&&this._highlightTextureHelper.setEnableState(!1);this._stencilRenderingHelper.getEnableState()&&this._stencilRenderingHelper.setEnableState(!1);this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),
this._fallbackDepthStencilTexture=null)};e.prototype.setLighting=function(a){this._lighting.set(a)};e.prototype.setPixelRatio=function(a){this._pixelRatio=a;this._needsRender=!0};e.prototype.getPixelRatio=function(){return this._pixelRatio};e.prototype.addExternalRenderer=function(a,b){this._externalRenderers.addRenderer(a,b);return!0};e.prototype.removeExternalRenderer=function(a){this._externalRenderers.removeRenderer(a);return!0};e.prototype.getExternalRenderers=function(){return this._externalRenderers};
e.prototype.resetNeedsRender=function(){this._needsRender=!1;this._externalRenderers.resetNeedsRender()};e.prototype.needsRender=function(){return this._needsRender||this._externalRenderers.needsRender()};e.prototype.getCombinedStats=function(){var a=this;this._stats.VBOallocatedSize=0;this._stats.VBOoptimalSize=0;this._stats.VBOusedSize=0;var b=function(){},d=function(b,d){if(d.type===z.Preinterleaved)for(var c in d.instances)b=d.instances[c].buffer,a._stats.VBOallocatedSize+=b.length,a._stats.VBOusedSize+=
b.length,a._stats.VBOoptimalSize+=b.length;else a._stats.VBOallocatedSize+=d.buffer.getArray().length,a._stats.VBOusedSize+=d.buffer.getSize(),a._stats.VBOoptimalSize+=d.optimalCount};I(this._mat2DataMerged,b,d);I(this._mat2DataInstanced,b,d);I(this._mat2DataPreinterleaved,b,d);this._stats.VBOallocatedSize*=.00390625;this._stats.VBOusedSize*=.00390625;this._stats.VBOoptimalSize*=.00390625;return this._stats};e.prototype._addHighlight=function(a){var b=this._getInstance(a);if(null===b)console.error("No instance found for RenderGeometry {name: '"+
a.name+"', uniqueName: '"+a.uniqueName+"'}");else if(this._highlights.push(b),this._orderedRendering&&this._sortHighlightsByRenderOrder(),this._needsRender=!0,this.onHasHighlightsChanged)this.onHasHighlightsChanged(this.hasHighlights)};e.prototype._removeHighlight=function(a){var b=this._highlights.length;this._highlights=this._highlights.filter(function(b){return b.uniqueName!==a.uniqueName});if(b!==this._highlights.length){if(this.onHasHighlightsChanged)this.onHasHighlightsChanged(this.hasHighlights);
this._needsRender=!0}};Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return 0<this._highlights.length},enumerable:!0,configurable:!0});e.prototype._renderHUDVisibility=function(a){var b=this,d=ra.shouldRenderVisibilityDuringRenderPass(a.pass),c=a.offscreenRenderingHelper&&a.offscreenRenderingHelper.getEnableState();d&&c&&a.offscreenRenderingHelper.renderHUDVisibility(function(){b._renderInternalSlot(u.OCCLUSION_PIXELS,a)})};e.prototype.renderGeometrySlots=function(a){this._externalRenderers.render(u.INTERNAL_MATERIAL,
a);this._renderInternalSlot(u.STENCIL_MATERIAL,a);this._externalRenderers.render(u.OPAQUE_TERRAIN,a);this._renderInternalSlot(u.OPAQUE_MATERIAL,a);this._externalRenderers.render(u.OPAQUE_EXTERNAL,a);a.ssaoHelper&&a.ssaoHelper.bindAll(this._programRep);this._renderInternalSlot(u.TRANSPARENT_MATERIAL,a);this.renderOptions.earlyOcclusionPixelDraw&&(this._renderHUDVisibility(a),this._renderInternalSlot(u.LINE_CALLOUTS,this._renderContext));this._externalRenderers.render(u.TRANSPARENT_EXTERNAL,a);a.ssaoHelper&&
a.ssaoHelper.bindAll(this._programRep);this._externalRenderers.render(u.TRANSPARENT_TERRAIN,a)};e.prototype._renderHighlights=function(a,b,d){var c=!!d&&d.getEnableState()&&(this.hasHighlights||this._externalRenderers.needsHighlight());this._highlightTextureHelper.setEnableState(c);if(c){c=null;d.profilingCallback&&(c=qa.startMeasurement(this._renderContext.rctx));this._highlightTextureHelper.setupFBOs(a);this._highlightTextureHelper.prepareHighlightPass();this.renderGeometryPass(E.MATERIAL_HIGHLIGHT,
a,null,null);this._rctx.clear(this._rctx.gl.DEPTH_BUFFER_BIT);this._renderInternalSlot(u.LINE_CALLOUTS_HUD_DEPTH,this._renderContext);this._renderInternalSlot(u.HUDMATERIAL1,this._renderContext);this._renderInternalSlot(u.HUDMATERIAL2,this._renderContext);this._highlightTextureHelper.finish(b);var f=this._highlightTextureHelper.getHighlightFBO();d.render(a,b,f);null!==c&&d.profilingCallback&&c.stop(function(a){d.profilingCallback&&d.profilingCallback(a)})}};e.prototype._needsRenderOccluded=function(a){for(var b in this._mat2DataInstanced){var d=
this._mat2DataInstanced[b][0];if(d&&d.isRenderOccluded()&&d.beginSlot(a)&&d.isVisible())return!0}return!1};e.prototype._renderOccluded=function(a,b,d){if(b&&d&&d.getEnableState()){var c=this._needsRenderOccluded(u.OPAQUE_MATERIAL)||this._needsRenderOccluded(u.TRANSPARENT_MATERIAL);c!==b.getEnableState()&&b.setEnableState(c);c&&(c=this._renderContext,b.setupFBOs(a),b.prepareColorPass(),c.pass=E.MATERIAL,c.renderOccludedOnly=!0,this._renderInternalSlot(u.OPAQUE_MATERIAL,c),this._renderInternalSlot(u.TRANSPARENT_MATERIAL,
c),c.renderOccludedOnly=!1,b.finish(d.getFramebuffer()),b.apply())}};e.prototype._renderUnordered=function(a,b,d,c){var f=this._rctx;this._isRendering=!0;this._stats.reset();this._updateGlobalUniforms(a.projectionMatrix);this._renderContext.pass=E.MATERIAL;this._renderContext.camera=a;this._renderContext.shadowMap=b;this._renderContext.ssaoHelper=c.ssao;this._renderContext.offscreenRenderingHelper=c.offscreenRendering;this._renderContext.stencilRenderingHelper=this._stencilRenderingHelper;this._renderContext.depth=
this._linearDepthTextureHelper.getDepthFBO();this._renderContext.normals=this._normalTextureHelper.getNormalFBO();this._renderContext.highlight=this._highlightTextureHelper.getHighlightFBO();this._renderContext.options=this.renderOptions;this._renderContext.rctx=this._rctx;this._renderContext.lightingData=this._lighting.getOld();c.offscreenRendering.setEnableState(!0);c.offscreenRendering.initializeFrame(a);this._externalRenderers.render(u.BACKGROUND,this._renderContext);this.renderGeometrySlots(this._renderContext);
this._externalRenderers.render(u.POSTPROCESSING_ATMOSPHERE,this._renderContext);this._externalRenderers.render(u.POSTPROCESSING_EXTERNAL,this._renderContext);this.renderOptions.earlyOcclusionPixelDraw||(this._renderHUDVisibility(this._renderContext),this._renderInternalSlot(u.LINE_CALLOUTS,this._renderContext));this._renderOccluded(a,c.renderOccluded,c.offscreenRendering);b=this.renderOptions.antialiasing;"smaa"===b&&this._smaaPass.ensureEnabled()?(this._fxaaPass.disable(),this._smaaPass.render({colorTexture:c.offscreenRendering.getColorTexture()},
null)):"fxaa"===b&&this._fxaaPass.enable()?(this._smaaPass.disable(),this._fxaaPass.render({colorTexture:c.offscreenRendering.getColorTexture()},null)):(b=a.viewport,b=F.ortho(b[0],b[2],b[1],b[3],-1,1),c.offscreenRendering.drawQuad(b),this._fxaaPass.disable(),this._smaaPass.disable());f.bindFramebuffer(null);this._renderContext.framebufferTex=c.offscreenRendering.getColorTexture();this._renderInternalSlot(u.LINE_CALLOUTS_HUD_DEPTH,this._renderContext);this._renderInternalSlot(u.HUDMATERIAL1,this._renderContext);
this._renderInternalSlot(u.HUDMATERIAL2,this._renderContext);this._renderHighlights(a,d,c.highlight);this._isRendering=!1};e.prototype._renderGeometryPassOrderedHighlight=function(a){this._renderInternalHighlights(this._highlights)};e.prototype._renderGeometryPassOrderedMaterial=function(a){for(var b=null,d=0;d<this._renderOrder.length;d++){var c=this._renderOrder[d][1];if(c.instanced){var f=c.instanced||c.merged,m=f[a.pass];m&&m.isVisible()&&(this._renderInternalInstanced(f,m,this._bindParameters,
Infinity),b=null)}c.merged&&(f=c.merged,(m=f[a.pass])&&m.isVisible()&&(c=m.getProgram(),c!==b&&(c.setUniformMatrix4fv("model",P),c.hasUniform("modelNormal")&&c.setUniformMatrix4fv("modelNormal",P)),b=c,this._renderInternalMerged(f,m,this._bindParameters,Infinity)))}};e.prototype._renderGeometryPassOrdered=function(a){var b=a.camera;this._bindParameters.view=b.viewMatrix;this._bindParameters.proj=b.projectionMatrix;this._bindParameters.viewInvTransp=b.viewInverseTransposeMatrix;N[0]=b.near;N[1]=b.far;
this._bindParameters.nearFar=N;this._bindParameters.lightingData=this._lighting.getOld();this._bindParameters.viewport=b.fullViewport;this._bindParameters.framebufferTex=this._framebuffer.texture;this._bindParameters.pixelRatio=this._pixelRatio;this._bindParameters.instanceParameters=void 0;this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO();this._bindParameters.normalFBO=this._normalTextureHelper.getNormalFBO();a.isHighlightPass?this._renderGeometryPassOrderedHighlight(a):
this._renderGeometryPassOrderedMaterial(a)};e.prototype._renderOrdered=function(a,b){this._stats.reset();this.renderGeometryPass(a,b)};e.prototype.render=function(a,b,d){this._orderedRendering?this._renderOrdered(E.MATERIAL,a):this._renderUnordered(a,d.shadowMap,b,d)};e.prototype.renderAuxiliaryBuffers=function(a,b,d){var c=d.ssao;d=d.shadowMap;var f=this.ssaoEnabled||this._externalRenderers.needsLinearDepth();this._linearDepthTextureHelper.setEnableState(f);f&&(this._linearDepthTextureHelper.setupFBOs(a),
this._linearDepthTextureHelper.prepareDepthPass(),this.renderGeometryPass(E.MATERIAL_DEPTH,a,d,c),this._linearDepthTextureHelper.finish(b));this._normalTextureHelper.setEnableState(this.ssaoEnabled);this.ssaoEnabled&&(this._normalTextureHelper.setupFBOs(a),this._normalTextureHelper.prepareNormalPass(),this.renderGeometryPass(E.MATERIAL_NORMAL,a,d,c),this._normalTextureHelper.finish(b));this.ssaoEnabled&&c.computeSSAO(a,b,this._linearDepthTextureHelper.getDepthFBO(),this._normalTextureHelper.getNormalFBO());
c.bindAll(this._programRep)};e.prototype.renderGeometryPass=function(a,b,d,c){this._isRendering=!0;this._updateGlobalUniforms(b.projectionMatrix);this._renderContext.pass=a;this._renderContext.camera=b;this._renderContext.shadowMap=d;this._renderContext.ssaoHelper=c;this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO();this._renderContext.normals=this._normalTextureHelper.getNormalFBO();this._renderContext.rctx=this._rctx;this._orderedRendering?this._renderGeometryPassOrdered(this._renderContext):
this._renderGeometryPassUnordered(this._renderContext);this._isRendering=!1};e.prototype._renderGeometryPassUnordered=function(a){this.renderGeometrySlots(a)};e.prototype._renderInternalHighlights=function(a,b){void 0===b&&(b=null);for(var d=0;d<a.length;++d){var c=a[d],f=c.matData[E.MATERIAL_HIGHLIGHT];f&&(null===b||f.beginSlot(b))&&f.isVisible()&&this._renderInternalHighlight(c,this._bindParameters,E.MATERIAL_HIGHLIGHT)}};e.prototype._renderInternalSlotOccluded=function(a,b){for(var d in this._mat2DataInstanced){var c=
this._mat2DataInstanced[d],f=c[b.pass];f&&f.isRenderOccluded()&&f.beginSlot(a)&&f.isVisible()&&this._renderInternalInstanced(c,f,this._bindParameters,a)}};e.prototype._renderInternalSlotMaterial=function(a,b){for(var d in this._mat2DataInstanced){var c=this._mat2DataInstanced[d],f=c[b.pass];f&&f.beginSlot(a)&&f.isVisible()&&this._renderInternalInstanced(c,f,this._bindParameters,a)}for(var c=this._programRep.getProgramsUsingUniform("model"),f=this._programRep.getProgramsUsingUniform("modelNormal"),
m=0;m<c.length;m++){var h=c[m];h.setUniformMatrix4fv("model",P);-1<f.indexOf(h)&&h.setUniformMatrix4fv("modelNormal",P)}for(d in this._mat2DataMerged)c=this._mat2DataMerged[d],(f=c[b.pass])&&f.beginSlot(a)&&f.isVisible()&&this._renderInternalMerged(c,f,this._bindParameters,a);for(d in this._mat2DataPreinterleaved)c=this._mat2DataPreinterleaved[d],(f=c[b.pass])&&f.beginSlot(a)&&f.isVisible()&&this._renderInternalPreinterleaved(c,f,this._bindParameters,a);a===u.STENCIL_MATERIAL&&this._stencilRenderingHelper.finish()};
e.prototype._renderInternalSlotHighlights=function(a,b){this._renderInternalHighlights(this._highlights,a)};e.prototype._renderInternalSlot=function(a,b){this._bindParameters.view=b.camera.viewMatrix;this._bindParameters.proj=b.camera.projectionMatrix;this._bindParameters.viewInvTransp=b.camera.viewInverseTransposeMatrix;this._bindParameters.cameraAboveGround=b.camera.aboveGround;this._bindParameters.fovY=b.camera.fovY;this._bindParameters.poiDistance=b.camera.distance;N[0]=b.camera.near;N[1]=b.camera.far;
var d=this._renderContext.offscreenRenderingHelper;this._bindParameters.nearFar=N;this._bindParameters.lightingData=this._lighting.getOld();this._bindParameters.viewport=b.camera.fullViewport;this._bindParameters.framebufferTex=d?d.getColorTexture():null;this._bindParameters.shadowMap=b.shadowMap;this._bindParameters.shadowMappingEnabled=!!b.shadowMap&&b.shadowMap.getEnableState();this._bindParameters.ssaoEnabled=!!b.ssaoHelper&&b.ssaoHelper.getEnableState();this._bindParameters.pixelRatio=this._pixelRatio;
this._bindParameters.instanceParameters=void 0;this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO();this._bindParameters.hudVisibilityTexture=d?d.getHUDVisibilityTexture():null;b.isHighlightPass?this._renderInternalSlotHighlights(a,b):b.renderOccludedOnly?this._renderInternalSlotOccluded(a,b):this._renderInternalSlotMaterial(a,b)};e.prototype._renderInternalInstanced=function(a,b,d,c){var f=this._rctx,m=f.gl,h=!1,e=b.getDrawMode(f),g=this._bindParameters.extensions.angleInstancedArrays,
l;for(l in a.origin2data){var n=a.origin2data[l];d.origin=n.origin;c===u.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());var k=!1;if(b.instanced)for(var q in n.perGeometryDataInfo){var x=n.perGeometryDataInfo[q];h||(b.bind(f,d),h=!0);f.bindVAO(x.vao);var r=b.getProgram();H.assertCompatibleVertexAttributeLocations(x.vao,r);k||(b.bindView(f,d),k=!0);var r=x.to-x.from,t=x.refCount;e===m.TRIANGLES&&(this._stats.trianglesRendered+=
t*r/3);g.drawArraysInstancedANGLE(e,x.from,r,t);this._stats.drawCallsAngleInstanced++;this._stats.instancesDrawnAngle+=t}else{var x=n.instances,z;for(z in x)r=x[z],t=r.displayedIndexRange,t&&0===t.length||(h||(b.bind(f,d),h=!0),k||(f.bindVAO(n.vao),b.bindView(f,d),k=!0),b.bindInstance(f,r),this._stats.drawCallsInstanced++,e===m.TRIANGLES&&(this._stats.trianglesRendered+=(r.to-r.from)/3),t?this._drawArraysFaceRange(t,r.from,e):f.drawArrays(e,r.from,r.to-r.from))}}f.bindVAO(null);h&&b.release(f,d)};
e.prototype._renderInternalHighlight=function(a,b,d){var c=this._rctx,f=c.gl;d=a.matData[d];var m=d.getDrawMode(c),e=a.instance,p=e.highlightedIndexRange,g=this._renderContext.offscreenRenderingHelper,g=(g?g.getDepthTexture():null)||this._getFallbackDepthTexture(),l=d.getProgram(),n=this._bindParameters.extensions.angleInstancedArrays;b.origin=a.originData.origin;if(d.instanced&&a.type===z.Instanced)for(a=a.instancedVAO,d.bind(c,b),c.bindVAO(a),H.assertCompatibleVertexAttributeLocations(a,l),d.bindView(c,
b),a=0;a<p.length;a++){var k=p[a],q=k.range?k.range[0]+e.from:e.from,k=k.range?k.range[1]-k.range[0]+1:e.to-e.from;c.bindTexture(g,5);l.setUniform1i("depthTex",5);l.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]);n.drawArraysInstancedANGLE(m,q,k,1);m===f.TRIANGLES&&(this._stats.trianglesRendered+=1*k/3);this._stats.drawCallsHighlight++}else if(a.type===z.Instanced&&d.instanced)console.error("_renderInternalHighlight: incompatible instance type");
else{d.bind(c,b);d.bindView(c,b);switch(a.type){case z.Merged:n=a.originData;c.bindVAO(n.vao);l.setUniformMatrix4fv("model",P);break;case z.Instanced:n=a.originData;c.bindVAO(n.vao);d.bindInstance(c,e);break;case z.Preinterleaved:n=a.originData,a=n.instances[a.uniqueName].vao,c.bindVAO(a),d.bindInstance(c,e)}for(a=0;a<p.length;a++)k=p[a],q=k.range?k.range[0]+e.from:e.from,k=k.range?k.range[1]-k.range[0]+1:e.to-e.from,c.bindTexture(g,5),d.getProgram().setUniform1i("depthTex",5),l.setUniform4f("highlightViewportPixelSz",
0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]),c.drawArrays(m,q,k),m===f.TRIANGLES&&(this._stats.trianglesRendered+=k/3),this._stats.drawCallsHighlight++}c.bindVAO(null);d.release(c,b)};e.prototype._drawArraysFaceRange=function(a,b,d){for(var c=this._rctx,f=0;f<a.length;f++){var e=a[f];c.drawArrays(d,e[0]+b,e[1]-e[0]+1)}this._stats.drawCallsFragmented+=a.length-1};e.prototype._renderInternalMerged=function(a,b,d,c){var f=this._rctx,e=f.gl,h=!1,p;for(p in a.origin2data){var g=
a.origin2data[p];d.origin=g.origin;c===u.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());if(!g.displayedIndexRange||0!==g.displayedIndexRange.length){h||(b.bind(f,d),h=!0);var l=b.getProgram();f.bindVAO(g.vao);H.assertCompatibleVertexAttributeLocations(g.vao,l);b.bindView(f,d);this._stats.drawCallsMerged++;l=b.getDrawMode(f);l===e.TRIANGLES&&(this._stats.trianglesRendered+=g.vao.vertexBuffers.geometry.size/3);g.displayedIndexRange?
this._drawArraysFaceRange(g.displayedIndexRange,0,l):f.drawArrays(l,0,H.vertexCount(g.vao,"geometry"))}}h&&b.release(f,d)};e.prototype._renderInternalPreinterleaved=function(a,b,d,c){var f=this._rctx,e=f.gl,h=!1,p=b.getDrawMode(f),g;for(g in a.origin2data){var l=a.origin2data[g];d.origin=l.origin;var n=!1;c===u.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());for(var k in l.instances){var q=l.instances[k],x=q.instance,q=q.vao,
r=x.displayedIndexRange;if(!r||0!==r.length){h||(b.bind(f,d),h=!0);var t=b.getProgram();H.assertCompatibleVertexAttributeLocations(q,t);f.bindVAO(q);n||(b.bindView(f,d),n=!0);b.bindInstance(f,x);this._stats.drawCallsPreinterleaved++;p===e.TRIANGLES&&(this._stats.trianglesRendered+=(x.to-x.from)/3);r?this._drawArraysFaceRange(r,x.from,p):f.drawArrays(p,x.from,x.to-x.from)}}}f.bindVAO(null);h&&b.release(f,d)};e.prototype._updateGlobalUniforms=function(a){for(var b=this._programRep.getProgramsUsingUniform("proj"),
d=0;d<b.length;d++)b[d].setUniformMatrix4fv("proj",a);if(this._lighting){b=this._programRep.getProgramsUsingUniform("lightingMainDirection");for(d=0;d<b.length;d++)this._lighting.setUniforms(b[d]);b=this._programRep.getProgramsUsingUniform("lightDirection");for(d=0;d<b.length;d++)this._lighting.setUniforms(b[d])}};e.prototype.print=function(){var a=Object.keys(this._mat2DataMerged).length,b=Object.keys(this._mat2DataInstanced).length,d=Object.keys(this._mat2DataPreinterleaved).length;console.log("number of materials (merged/instanced/preinterleaved): "+
a+"/"+b+"/"+d);var c=0;I(this._mat2DataMerged,function(){},function(a,b){c+=Object.keys(b.instances).length});var f=0;I(this._mat2DataInstanced,function(){},function(a,b){f+=Object.keys(b.instances).length});var e=0;I(this._mat2DataPreinterleaved,function(){},function(a,b){e+=Object.keys(b.instances).length});console.log("number of instances (merged/instanced/preinterleaved): "+c+"/"+f+"/"+e)};e.prototype.isEmpty=function(){for(var a in this._mat2DataInstanced){var b=this._mat2DataInstanced[a],d;
for(d in b.origin2data)if(!X(b.origin2data[d].instances))return!1}for(a in this._mat2DataMerged)for(d in b=this._mat2DataMerged[a],b.origin2data)if(!X(b.origin2data[d].instances))return!1;for(a in this._mat2DataPreinterleaved)for(d in b=this._mat2DataPreinterleaved[a],b.origin2data)if(!X(b.origin2data[d].instances))return!1;return!0};e.prototype.modify=function(a,b,d,c){this._isRendering&&console.warn("Renderer.modify called while rendering");var f=[],e=[],h=[];this._classifyRenderGeometry(a,f,e,
h);a=[];var p=[],g=[];this._classifyRenderGeometry(b,a,p,g);var l={};d&&this._performUpdates(d,l);d=[];this._modifyMerged(f,a,d,l);this._modifyInstanced(e,p,d);this._modifyPreinterleaved(h,g,d);this._updateMergedFaceranges(l);this._releaseMaterials(d);f=this._highlights.length;if(b&&0<b.length&&0<f&&(this._highlights=this._highlights.filter(function(a){return!b.some(function(b){return b.uniqueName===a.uniqueName})}),f!==this._highlights.length&&this.onHasHighlightsChanged))this.onHasHighlightsChanged(this.hasHighlights);
this._updateHighlightVAOs();this._modifyMaterials(c);this._needsRender=!0};e.prototype._classifyRenderGeometry=function(a,b,d,c){for(var f=0;f<a.length;f++){var e=a[f];if(1<=M(e.data))switch(this._getType(e)){case z.Merged:b.push(e);break;case z.Instanced:d.push(e);break;case z.Preinterleaved:c.push(e)}}};e.prototype._performUpdates=function(a,b){for(var d=0;d<a.length;d++){var c=a[d],f=c.updateType,c=c.renderGeometry,e=this._getType(c)===z.Merged;if(1<=M(c.data)){f&2&&this._updateFaceranges(c,b);
if(f&32){var h=this._getInstance(c);h&&this._updateHighlightFaceranges(c,h.instance)}f&4||e&&f&16?this._updateVertexAttributes(c,!e):!e&&f&16?this._updateInstanceTransformation(c):f&8&&this._updateColorAttributes(c)}}};e.prototype._updateFaceranges=function(a,b){var d=a.material.getId(),c=a.origin.id,f=this._getType(a),e;if(f===z.Preinterleaved){var h=this._getOriginData(f,d,c);e=h.instances[a.uniqueName].instance}else h=this._getOriginData(f,d,c),(e=h.instances[a.uniqueName])&&f===z.Merged&&(b[this._modifiedMergedFacerangesKey(d,
c)]=h);e&&(e.displayedIndexRange=U(a),this._updateHighlightFaceranges(a,e))};e.prototype._updateHighlightFaceranges=function(a,b){if(b){var d=b.highlightedIndexRange,c;c=da.generateHighlightedIndexRanges(a.instanceParameters.componentVisibilities,a.instanceParameters.componentHighlights,a.componentOffsets);(b.highlightedIndexRange=c)&&!d?this._addHighlight(a):!c&&d&&this._removeHighlight(a)}};e.prototype._updateMergedFaceranges=function(a){for(var b in a){var d=a[b];d.displayedIndexRange=[];var c=
d.instances,f=!0,e;for(e in c){var h=c[e];h.displayedIndexRange?(d.displayedIndexRange.push.apply(d.displayedIndexRange,aa.offsetIntervals(h.displayedIndexRange,h.from)),f=!1):d.displayedIndexRange.push([h.from,h.to-1])}d.displayedIndexRange=f?null:aa.mergeIntervals(d.displayedIndexRange)}};e.prototype._updateVertexAttributes=function(a,b){var d=a.material,c=d.getId(),f=a.origin.id,e=H.getStride(d.getVertexBufferLayout())/4,h=this._getType(a);if(h===z.Preinterleaved)h=this._getOriginData(h,c,f),b=
h.instances[a.uniqueName],c=b.instance,f=b.buffer,h=b.vao;else{var h=this._getOriginData(h,c,f),c=h.instances[a.uniqueName],f=h.buffer.getArray(),h=h.vao,p=void 0,g=void 0;b||(W(a,Q,R),p=Q,g=R);d.fillInterleaved(a.data,p,g,a.instanceParameters,f,c.from*e)}G(c.from+d.getOutputAmount(M(a.data))/e===c.to,"material VBO layout has changed");h.vertexBuffers.geometry.setSubData(f,c.from*e*4,c.from*e*4,c.to*e*4)};e.prototype._updateInstanceTransformation=function(a){var b=this._getType(a),d=a.material.getId(),
c=a.origin.id;b===z.Preinterleaved?(b=this._getOriginData(b,d,c),c=b.instances[a.uniqueName].instance,W(a,c.transformation,c.transformationNormal)):(b=this._getOriginData(b,d,c),c=b.instances[a.uniqueName],b=b.perGeometryDataInfo[a.data.id],d=b.instanceBufferData,W(a,c.transformation,c.transformationNormal),d&&(a=d.getSlot(a.idx),d.fill(a,0,c.transformation),d.fill(a,16,c.transformationNormal),a=4*d.getOffset(a),c=H.getStride(b.vao.layout.instance),b.vao.vertexBuffers.instance.setSubData(d.getArray(),
a,a,a+c)))};e.prototype._updateColorAttributes=function(a){var b=a.material,d=b.getId(),c=a.origin.id,e=H.getStride(b.getVertexBufferLayout())/4,m=this._getType(a);if(m===z.Preinterleaved)var m=this._getOriginData(m,d,c),h=m.instances[a.uniqueName],d=h.instance,c=h.buffer,m=h.vao;else{var m=this._getOriginData(m,d,c),d=m.instances[a.uniqueName],c=m.buffer.getArray(),m=m.vao,p=(h={},h[fa.COLOR]=!0,h[fa.SYMBOLCOLOR]=!0,h);b.fillInterleaved(a.data,void 0,void 0,a.instanceParameters,c,d.from*e,p)}G(d.from+
b.getOutputAmount(M(a.data))/e===d.to,"material VBO layout has changed");m.vertexBuffers.geometry.setSubData(c,d.from*e*4,d.from*e*4,d.to*e*4)};e.prototype._modifyMerged=function(a,b,d,c){var e=this._rctx,m=z.Merged;a=this._compMat2delta(a,b,m);b=this._mat2DataMerged;for(var h in a){var p=a[h],g;for(g in p){var l=p[g],n=l.optimalCount,k=l.material,q=k.getVertexBufferLayout(),x=H.getStride(q)/4,r=b[h];if(null==r){G(0<n);var t=k.getRenderPriority(),r=this._initializeMatData(k);b[h]=r;this._orderedRendering&&
this._insertIntoRenderOrder(r,t,"merged")}t=r.origin2data[g];null==t&&(G(0<n),t={type:m,instances:{},vao:new O(e,T.Default3D,{geometry:q},{geometry:S.createVertex(e,35044)}),buffer:new ba(n),optimalCount:0,origin:l.origin},r.origin2data[g]=t);if(0<n){var q=t.buffer.getSize(),u=t.buffer.getArray(),r=n<l.sparseCount/2,B=t.buffer.resize(r?n:l.sparseCount),y=l.toRemove;if(r||B){for(var q=0,A=t.buffer.getArray(),r=0;r<y.length;++r)B=t.instances[y[r].uniqueName],t.optimalCount-=(B.to-B.from)*x,delete t.instances[y[r].uniqueName];
var r={},C;for(C in t.instances)B=t.instances[C],G(null==r[B.from]),r[B.from]=B;for(var v in r){var B=r[v],w=B.from*x,D=B.to*x;A.set(u.subarray(w,D),q);B.from=q/x;q+=D-w;B.to=q/x}G(q===t.optimalCount)}else for(r=0;r<y.length;++r)B=y[r].uniqueName,G(void 0!==t.instances[B]),w=t.instances[B].from*x,D=t.instances[B].to*x,t.buffer.erase(w,D),delete t.instances[B],t.optimalCount-=D-w;V(L,-l.origin[0],-l.origin[1],-l.origin[2]);u=l.toAdd;l=!1;for(r=0;r<u.length;++r)y=u[r],w=y.data,F.multiply(L,y.transformation,
Q),F.inverse(Q,R),F.transpose(R),B=q,k.fillInterleaved(w,Q,R,y.instanceParameters,t.buffer.getArray(),q),w=k.getOutputAmount(M(w)),A=B+w,G(null==t.instances[y.uniqueName]),D=U(y),B=new Y(y.name,B/x,A/x,D,void 0,void 0,y.idx),t.instances[y.uniqueName]=B,this._updateHighlightFaceranges(y,B),D&&(l=!0),t.optimalCount+=w,q+=w;G(t.optimalCount===n);n=new Float32Array(t.buffer.getArray().buffer,0,t.buffer.getSize());t.vao.vertexBuffers.geometry.setData(n);if(l||t.displayedIndexRange)c[this._modifiedMergedFacerangesKey(h,
g)]=t}else G(0===n),t.vao.dispose(!0),t.vao=null,delete r.origin2data[g],0===Object.keys(r.origin2data).length&&(d.push(h),delete b[h],this._orderedRendering&&this._removeFromRenderOrder(r,"merged"))}}};e.prototype._modifyInstanced=function(a,b,d){var c=this._rctx,e=z.Instanced;a=this._compMat2delta(a,b,e);b=this._mat2DataInstanced;for(var m in a){var h=a[m],p;for(p in h){var g=h[p];if(0===g.optimalCount)g=b[m],g.origin2data[p].vao.dispose(!0),delete g.origin2data[p],0===Object.keys(g.origin2data).length&&
(d.push(m),delete b[m],this._orderedRendering&&this._removeFromRenderOrder(g,"instanced"));else{var l=g.material,n=b[m];if(null==n){var k=l.getRenderPriority(),n=this._initializeMatData(l);b[m]=n;this._orderedRendering&&this._insertIntoRenderOrder(n,k,"instanced")}var q=l.getVertexBufferLayout(),x=n[E.MATERIAL].instanced?l.getInstanceBufferLayout():void 0,r=x&&H.findAttribute(x,"instanceColor"),t=x&&H.findAttribute(x,"instanceFeatureAttribute"),u=H.getStride(q)/4,k=n.origin2data[p];null==k&&(k={type:e,
instances:{},vao:new O(c,T.Default3D,{geometry:q},{geometry:S.createVertex(c,35044)}),buffer:new ba(g.optimalCount),optimalCount:0,perGeometryDataInfo:{},origin:g.origin},n.origin2data[p]=k);var n=k.buffer.getSize(),B=k.buffer.getArray(),y=g.optimalCount<g.sparseCount/2,A=k.buffer.resize(y?g.optimalCount:g.sparseCount),C;for(C in g.perGeometryDelta){var v=k.perGeometryDataInfo[C];if(v&&v.instanceBufferData){var w=g.perGeometryDelta[C].removeCount;0<w&&v.instanceBufferData.prepareFree(w)}}var D=g.toRemove;
if(y||A){for(y=0;y<D.length;++y){A=D[y];delete k.instances[A.uniqueName];C=A.data.id;var J=v=k.perGeometryDataInfo[C];0===--J.refCount&&null==g.dataId2refCount[C]?(k.optimalCount-=(J.to-J.from)*u,delete k.perGeometryDataInfo[C]):v.instanceBufferData&&v.instanceBufferData.free(A.idx)}var n=0,y=k.buffer.getArray(),A={},I;for(I in k.perGeometryDataInfo)J=k.perGeometryDataInfo[I],G(null==A[J.from]),A[J.from]=J;for(var K in A)J=A[K],w=J.from*u,v=J.to*u,y.set(B.subarray(w,v),n),J.from=n/u,n+=v-w,J.to=n/
u;for(var N in k.instances)w=k.instances[N],w.from=k.perGeometryDataInfo[w.dataId].from,w.to=k.perGeometryDataInfo[w.dataId].to}else for(y=0;y<D.length;++y)A=D[y],delete k.instances[A.uniqueName],C=A.data.id,v=k.perGeometryDataInfo[C],0===--v.refCount&&null==g.dataId2refCount[C]?(w=v.from*u,v=v.to*u,k.buffer.erase(w,v),k.optimalCount-=v-w,delete k.perGeometryDataInfo[C]):v.instanceBufferData&&v.instanceBufferData.free(A.idx);V(L,-g.origin[0],-g.origin[1],-g.origin[2]);for(C in g.perGeometryDelta)(v=
k.perGeometryDataInfo[C])&&v.instanceBufferData&&(y=g.perGeometryDelta[C].addCount,0<y&&v.instanceBufferData.prepareAllocate(y));B=g.toAdd;for(y=0;y<B.length;++y)if(A=B[y],w=A.data,C=w.id,v=k.perGeometryDataInfo[C],null==v?(l.fillInterleaved(w,void 0,void 0,void 0,k.buffer.getArray(),n),D=l.getOutputAmount(M(w)),w=n/u,n+=D,v=n/u,k.optimalCount+=D,v={refCount:1,from:w,to:v,vao:null,instanceBufferData:null},x&&(w=H.getStride(x)/4,v.vao=new O(c,T.Default3D,{geometry:q,instance:x},{geometry:k.vao.vertexBuffers.geometry,
instance:S.createVertex(c,35044)}),v.instanceBufferData=new ga(w,g.perGeometryDelta[C].addCount)),k.perGeometryDataInfo[C]=v):++v.refCount,G(v.from*u<=k.buffer.getSize()&&v.to*u<=k.buffer.getSize()),w=F.create(),F.multiply(L,A.transformation,w),D=U(A),w=new Y(A.name,v.from,v.to,D,w,A.instanceParameters,A.idx,C),k.instances[A.uniqueName]=w,this._updateHighlightFaceranges(A,w),v=v.instanceBufferData)D=v.allocate(A.idx),v.fill(D,0,w.transformation),v.fill(D,16,w.transformationNormal),r&&v.fill(D,r.offset/
4,A.instanceParameters.color),t&&v.fill(D,t.offset/4,A.instanceParameters.featureAttribute);G(k.optimalCount===g.optimalCount);l=new Float32Array(k.buffer.getArray().buffer,0,k.buffer.getSize());k.vao.vertexBuffers.geometry.setData(l);for(C in k.perGeometryDataInfo)if(q=k.perGeometryDataInfo[C],q.vao&&(l=q.vao.vertexBuffers.instance))x=g.perGeometryDelta[C],0<x.addCount+x.removeCount&&(q=q.instanceBufferData.compact(),l.setData(q))}}}};e.prototype._modifyPreinterleaved=function(a,b,d){for(var c=this._rctx,
e=z.Preinterleaved,m=this._mat2DataPreinterleaved,h=0;h<a.length;h++){var p=a[h],g=p.material,l=g.getId(),n=p.origin.id,k=p.origin.vec3,q=m[l];null==q&&(q=this._initializeMatData(g),m[l]=q);l=q.origin2data[n];null==l&&(l={type:e,origin:k,count:0,instances:{}},q.origin2data[n]=l);V(L,-k[0],-k[1],-k[2]);q=F.create();F.multiply(L,p.transformation,q);k=U(p);n=p.data;n.preinterleaved?(q=new Y(p.name,0,n.indexCount,k,q,p.instanceParameters,p.idx,n.id),g=g.getVertexBufferLayout(),g=new O(c,T.Default3D,{geometry:g},
{geometry:S.createVertex(c,35044)}),g.vertexBuffers.geometry.setData(n.vertexData),l.count+=1,l.instances[p.uniqueName]={instance:q,vao:g,buffer:n.vertexData},this._updateHighlightFaceranges(p,q)):G(!1,"Non-interleaved render geometry processed as pre-interleaved")}for(a=0;a<b.length;a++)p=b[a],k=p.origin,g=p.material,l=g.getId(),n=k.id,p=p.uniqueName,q=m[l],c=q.origin2data[n],c.instances[p].vao.dispose(),delete c.instances[p],--c.count,0===c.count&&delete q.origin2data[n],0===Object.keys(q.origin2data).length&&
(d.push(l),delete m[l])};e.prototype._compMat2delta=function(a,b,d){var c={};this._updateMat2delta(a,!0,d,c);this._updateMat2delta(b,!1,d,c);return c};e.prototype._updateMat2delta=function(a,b,d,c){d=d===z.Instanced;for(var e=0;e<a.length;e++){var m=a[e],h=m.origin,p=m.material,g=p.getId(),l=d?this._mat2DataInstanced[g]:this._mat2DataMerged[g],l=l&&l.origin2data[h.id],n=c[g];null==n&&(n={},c[g]=n);g=n[h.id];if(null==g){g={optimalCount:null==l?0:l.optimalCount,sparseCount:null==l?0:l.buffer.getSize(),
material:p,toAdd:[],toRemove:[],perGeometryDelta:null,origin:h.vec3};if(d){var k={};if(void 0!==l)for(var q in l.perGeometryDataInfo)k[q]=l.perGeometryDataInfo[q].refCount;g.dataId2refCount=k;g.perGeometryDelta={}}n[h.id]=g}h=p.getOutputAmount(M(m.data));d?(p=m.data.id,l=g.perGeometryDelta[p],l||(l={addCount:0,removeCount:0},g.perGeometryDelta[p]=l),b?(l.addCount++,null==g.dataId2refCount[p]&&(g.dataId2refCount[p]=0),1===++g.dataId2refCount[p]&&(g.optimalCount+=h,g.sparseCount+=h),g.toAdd.push(m)):
(l.removeCount++,0===--g.dataId2refCount[p]&&(delete g.dataId2refCount[p],g.optimalCount-=h),g.toRemove.push(m))):b?(g.optimalCount+=h,g.sparseCount+=h,g.toAdd.push(m)):(g.optimalCount-=h,g.toRemove.push(m))}};e.prototype._getType=function(a){if(a.data.preinterleaved)return z.Preinterleaved;var b=!1,d=M(a.data),b=(b=(b=(b=b||!1===a.material.canBeMerged)||a.material.instanced)||a.material.isBackdrop)||!0===a.material.isRenderOccluded();a.singleUse||(b=b||d>this._threshold);return b?z.Instanced:z.Merged};
e.prototype._getTargetMat2Data=function(a){switch(a){case z.Merged:return this._mat2DataMerged;case z.Instanced:return this._mat2DataInstanced;case z.Preinterleaved:return this._mat2DataPreinterleaved}};e.prototype._getOriginData=function(a,b,d){return this._getTargetMat2Data(a)[b].origin2data[d]};e.prototype._modifiedMergedFacerangesKey=function(a,b){return a+"_"+b};e.prototype._insertIntoRenderOrder=function(a,b,d){for(var c=a[E.MATERIAL].getMaterialId(),e=this._renderOrder.length,m=0;m<e&&this._renderOrder[m][0]>=
b;){var h=this._renderOrder[m][1];if(h.id===c){G(!h[d],"matData for type already exists");h[d]=a;return}m++}c={id:c,instanced:null,merged:null};c[d]=a;this._renderOrder.splice(m,0,[b,c])};e.prototype._removeFromRenderOrder=function(a,b){var d=a[E.MATERIAL].getMaterialId();for(a=0;this._renderOrder[a][1].id!==d;)a++;d=this._renderOrder[a][1];d[b]=null;d.instanced||d.merged||this._renderOrder.splice(a,1)};e.prototype._sortHighlightsByRenderOrder=function(){this._highlights.sort(function(a,b){a=a.matData[E.MATERIAL].getRenderPriority();
b=b.matData[E.MATERIAL].getRenderPriority();return a>b?-1:b>a?1:0})};e.prototype._updateRenderOrder=function(a,b){for(var d=b.length,c=0;c<d&&b[c][1].id!==a;)c++;if(c<d){a=b[c][1];a=(a.merged||a.instanced)[E.MATERIAL].getRenderPriority();var e=b[c][0];if(a!==b[c][0])for(b[c][0]=a,e=a>e?-1:1,c+=e;-1<c&&c<d&&e*b[c][0]>e*a;){var m=b[c];b[c]=b[c-e];b[c-e]=m;c+=e}}};e.prototype._modifyMaterials=function(a){for(var b in a)this._materialRep.updateMaterialParameters(b)};e.prototype.modifyRenderOrder=function(a){if(this._orderedRendering){for(var b in a)this._updateRenderOrder(b,
this._renderOrder);this._sortHighlightsByRenderOrder();this._needsRender=!0}};e.prototype._initializeMatData=function(a){var b={origin2data:{}};b[E.MATERIAL]=this._materialRep.aquire(a);b[E.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(a);b[E.MATERIAL_NORMAL]=this._materialRep.aquireNormal(a);b[E.MATERIAL_DEPTH]=this._materialRep.aquireDepth(a);b[E.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(a);return b};e.prototype._releaseMaterials=function(a){if(Array.isArray(a))for(var b=
0;b<a.length;b++)this._materialRep.release(a[b]),this._materialRep.releaseDepthShadowMap(a[b]),this._materialRep.releaseNormal(a[b]),this._materialRep.releaseDepth(a[b]),this._materialRep.releaseHighlight(a[b]);else this._materialRep.release(a),this._materialRep.releaseDepthShadowMap(a),this._materialRep.releaseNormal(a),this._materialRep.releaseDepth(a),this._materialRep.releaseHighlight(a)};e.prototype._getInstance=function(a){var b=a.uniqueName,d=a.material.getId(),c=this._getType(a),d=this._getTargetMat2Data(c)[d];
if(!d)return null;a=d.origin2data[a.origin.id];if(!a)return null;var e;return(e=a.type===z.Preinterleaved?a.instances[b].instance:a.instances[b])?{type:c,uniqueName:b,instance:e,matData:d,originData:a,instancedVAO:null,instancedVAOBaseInstance:null}:null};e.prototype._createBaseInstanceVAO=function(a){var b=this._rctx,d=a.instance,c=a.originData;if(a.type===z.Instanced&&c.perGeometryDataInfo){var c=c.perGeometryDataInfo[d.dataId],e=c.instanceBufferData;e&&(c=c.vao,d=e.getSlot(d.idx),a.instancedVAOBaseInstance!==
d&&(e=H.setBaseInstanceOffset(c.layout,d),a.instancedVAO=new O(b,c.locations,e,c.vertexBuffers,c.indexBuffer),a.instancedVAOBaseInstance=d))}};e.prototype._updateHighlightVAOs=function(){for(var a=0;a<this._highlights.length;++a)this._createBaseInstanceVAO(this._highlights[a])};e.prototype._getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=new ea(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,
255,255,255])));return this._fallbackDepthStencilTexture};return e}();var ta=function(){function e(){this.reset()}e.prototype.reset=function(){this.VBOusedSize=this.VBOoptimalSize=this.VBOallocatedSize=this.instancesDrawnAngle=this.drawCallsHighlight=this.drawCallsFragmented=this.drawCallsPreinterleaved=this.drawCallsMerged=this.drawCallsAngleInstanced=this.drawCallsInstanced=this.trianglesRendered=0};return e}(),Y=function(){return function(e,a,b,d,c,f,m,h){this.name=e;this.from=a;this.to=b;this.displayedIndexRange=
d;this.transformation=c;this.instanceParameters=f;this.idx=m;this.dataId=h;null!=c&&(this.transformationNormal=F.create(),F.set(c,this.transformationNormal),F.inverse(this.transformationNormal,this.transformationNormal),F.transpose(this.transformationNormal,this.transformationNormal))}}(),z;(function(e){e[e.Merged=0]="Merged";e[e.Instanced=1]="Instanced";e[e.Preinterleaved=2]="Preinterleaved"})(z||(z={}));var N=Z.create(),L=F.identity(),Q=F.create(),R=F.create();return K});