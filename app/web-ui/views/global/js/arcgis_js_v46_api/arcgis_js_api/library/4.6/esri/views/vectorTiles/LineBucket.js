// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/extendsHelper ../../core/tsSupport/decorateHelper ./Bucket ../2d/engine/webgl/LineTess ./style/StyleLayer".split(" "),function(u,v,q,w,r,l,t){var n=new l.Tessellator({distanceAlongCorrection:!0});return function(p){function e(b,a,c,d){a=p.call(this,b,a)||this;a.extrudeVectorsDoubleBuffer=[l.allocExtrudeVectors(),l.allocExtrudeVectors()];a.firstExtrudeVectors=l.allocExtrudeVectors();a.recycledTriangleBridge=l.allocTriangles(20);a.recycledTrianglePie=l.allocTriangles(20);
if(b.hasDataDrivenLine!==c.isDataDriven())throw Error("incompatible line buffer");a._lineVertexBuffer=c;a._lineIndexBuffer=d;return a}q(e,p);Object.defineProperty(e.prototype,"lineIndexStart",{get:function(){return this._lineIndexStart},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"lineIndexCount",{get:function(){return this._lineIndexCount},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"connectorStart",{get:function(){return 0},enumerable:!0,configurable:!0});
Object.defineProperty(e.prototype,"connectorCount",{get:function(){return 0},enumerable:!0,configurable:!0});e.prototype.assignBufferInfo=function(b){b._lineIndexStart=this._lineIndexStart;b._lineIndexCount=this._lineIndexCount};e.prototype.processFeatures=function(b,a){this._lineIndexStart=this._lineIndexBuffer.index;this._lineIndexCount=0;a=this.layer;var c=this.zoom,d=a.hasDataDrivenLine;b&&b.setExtent(this.layerExtent);for(var h=a.getPaintValue("line-pattern",c),f=0,k=this._features;f<k.length;f++){var g=
k[f],l=new t.LineLayout(a,c,g),m=void 0;if(d&&(m={color:h?[1,1,1,1]:a.getPaintValue("line-color",c,g),opacity:a.getPaintValue("line-opacity",c,g),size:Math.max(Math.min(a.getPaintValue("line-width",c,g),256),0)},0>=m.size||0>=m.opacity||0>=m.color[3]))continue;g=g.getGeometry(b);this._processFeature(l,g,m)}};e.prototype._processFeature=function(b,a,c){if(a)for(var d=a.length,h=0;h<d;h++)this._processGeometry(a[h],b,c)};e.prototype._processGeometry=function(b,a,c){if(!(2>b.length)){for(var d=b[0],
h=b[b.length-1],f=h.x-d.x,h=h.y-d.y,d=1E-6>f*f+h*h,k=b[0],g=1;g<b.length;)f=b[g].x-k.x,h=b[g].y-k.y,1E-6>f*f+h*h?b.splice(g,1):(k=b[g],++g);if(!(2>b.length)){this.vertices=b;this.verticesLen=b.length;this.isClosed=d;this.cap=a.cap;this.join=a.join;this.almostParallelRads=.05;this.veryShallowRads=.1;this.miterSafeRads=l.MITER_SAFE_RADS;this.miterLimitMag=Math.min(a.miterLimit,l.SYSTEM_MAG_LIMIT);this.roundLimitRads=Math.min(a.roundLimit,.5);this.newRoundJoinsSafeRads=2.3;a=this._lineIndexBuffer.index;
for(var f=0,e=void 0,h=this.verticesLen,k=0;k<h;++k){var g=b[k],m=b[(k+h-1)%h],n=d&&this._isClipEdge(m,g),m=e===this.extrudeVectorsDoubleBuffer[k%2]?this.extrudeVectorsDoubleBuffer[(k+1)%2]:this.extrudeVectorsDoubleBuffer[k%2];k<h-1||!d||this.hasPattern?(this._computeExtrudeVectors(m,k),this._writeGPUVertices(g.x,g.y,f,m,c),!m.capCenter||d&&k===h-1||this._writeGPUPieElements(m,n),d&&0===k&&!this.hasPattern&&l.copyExtrudeVectors(this.firstExtrudeVectors,m)):l.copyExtrudeVectors(m,this.firstExtrudeVectors);
e&&this._writeGPUBridgeElements(e,m,n);k<h-1&&(e=b[k+1],g=l.length([e.x-g.x,e.y-g.y]),f+=g);e=m}this._lineIndexCount+=3*(this._lineIndexBuffer.index-a)}}};e.prototype._computeExtrudeVectors=function(b,a){var c=this.vertices,d=this.verticesLen,h=this.isClosed,f=c[a],k=[void 0,void 0],g=[void 0,void 0];if(0<a&&a<d-1){var e=c[(a+d-1)%d],m=c[(a+1)%d];l.normalize(k,[f.x-e.x,f.y-e.y]);l.normalize(g,[m.x-f.x,m.y-f.y])}else if(0===a)m=c[(a+1)%d],l.normalize(g,[m.x-f.x,m.y-f.y]),h?(c=c[d-2],l.normalize(k,
[f.x-c.x,f.y-c.y])):k=g;else if(a===d-1)e=c[(a+d-1)%d],l.normalize(k,[f.x-e.x,f.y-e.y]),h?(c=c[1],l.normalize(g,[c.x-f.x,c.y-f.y])):g=k;else{console.error("Vertex index 'i' out of range.");return}h||0!==a?h||a!==d-1?this._computeJoinExtrudeVectors(b,k,g):this._computeCapExtrudeVectors(b,k,g,l.CapPosition.END):this._computeCapExtrudeVectors(b,k,g,l.CapPosition.START)};e.prototype._computeCapExtrudeVectors=function(b,a,c,d){0===this.cap?n.buttCap(b,a,c):1===this.cap?n.roundCap(b,a,c,d,l.getNumberOfSlices(Math.PI),
d===l.CapPosition.START?-1:1):2===this.cap?n.squareCap(b,a,c,d):n.buttCap(b,a,c)};e.prototype._computeJoinExtrudeVectors=function(b,a,c){var d=l.getRads(a,c);if(d>Math.PI-this.almostParallelRads)n.rectJoin(b,a,c);else if(0===this.join&&d>=this.veryShallowRads)n.bevelJoin(b,a,c,1);else if(1===this.join&&d>=this.veryShallowRads){var h=l.getNumberOfSlices(d);d<this.newRoundJoinsSafeRads?2>h||d<this.roundLimitRads?n.bevelJoin(b,a,c,1):n.roundJoin(b,a,c,h):n.unitRoundJoin(b,a,c,h)}else d<this.almostParallelRads?
n.fastMiterJoin(b,a,c):d<this.miterSafeRads?n.miterJoin(b,a,c):n.bevelJoin(b,a,c,this.miterLimitMag)};e.prototype._writeGPUVertices=function(b,a,c,d,h){for(var f=0;f<d.vectors.count;++f){var e=d.vectors.items[f].vector[0],g=d.vectors.items[f].vector[1],l=d.vectors.items[f].texCoords[0],m=d.vectors.items[f].texCoords[1];d.vectors.items[f].base=this._lineVertexBuffer.index;this._lineVertexBuffer.add(b,a,e,g,l,m,c,h)}};e.prototype._writeGPUBridgeElements=function(b,a,c){n.bridge(this.recycledTriangleBridge,
b,a);if(!c)for(b=0;b<this.recycledTriangleBridge.count;++b)a=this.recycledTriangleBridge.items[b],this._lineIndexBuffer.add(a.v1.base,a.v2.base,a.v3.base)};e.prototype._writeGPUPieElements=function(b,a){n.pie(this.recycledTrianglePie,b);if(!a)for(b=0;b<this.recycledTrianglePie.count;++b)a=this.recycledTrianglePie.items[b],this._lineIndexBuffer.add(a.v1.base,a.v2.base,a.v3.base)};e.prototype._isClipEdge=function(b,a){return b.x===a.x?-64>=b.x||4160<=b.x:b.y===a.y?-64>=b.y||4160<=b.y:!1};return e}(r)});