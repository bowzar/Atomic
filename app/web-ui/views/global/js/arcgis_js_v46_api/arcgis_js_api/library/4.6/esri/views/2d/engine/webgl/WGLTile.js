// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/ObjectPool ../../../../core/libs/gl-matrix/vec2 ../../../../core/libs/gl-matrix/mat4 ../../tiling/TileKey ../DisplayObject ./WGLDisplayRecord ./WGLGeometry ./enums ./Utils ./WGLDisplayList".split(" "),function(A,B,v,w,x,y,p,z,q,m,d,k,l){return function(u){function c(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];b=u.call(this)||this;b.displayList=null;b.hlDisplayList=null;b.displayObjectRegistry=new Map;
b.iconDisplayRecords=null;b.textDisplayRecords=null;b.lineDisplayRecords=null;b.fillDisplayRecords=null;b.iconGeometry=null;b.textGeometry=null;b.lineGeometry=null;b.fillGeometry=null;b.coords=[0,0];b.bounds=[0,0,0,0];b.tileTransform={transform:Float32Array[16],displayCoord:Float32Array[2]};b._hasVisualVariables=!1;0<a.length&&(f=b.acquire).call.apply(f,[b].concat(a));b.tileTransform.transform=y.create();b.tileTransform.displayCoord=x.create();return b;var f}v(c,u);c.prototype.acquire=function(a,
b,f,c,g){this.key=p.pool.acquire(a);this.coords[0]=b[0];this.coords[1]=b[3];this.bounds=b;this.coordRange=f;this.width=c;this.height=g};c.prototype.release=function(){this.clear();p.pool.release(this.key);this.key=null};Object.defineProperty(c.prototype,"canDisplay",{get:function(){return!!this.attached&&!!this.displayList},enumerable:!0,configurable:!0});c.prototype.setData=function(a,b,f){a&&a.tileDisplayData&&(this._hasVisualVariables=b,this.displayList&&a.tileDisplayData.displayList!==this.displayList&&
l.pool.release(this.displayList),this.displayList=a.tileDisplayData.displayList,this.fillDisplayRecords=a.tileDisplayData.displayRecords[d.WGLGeometryType.FILL],this.lineDisplayRecords=a.tileDisplayData.displayRecords[d.WGLGeometryType.LINE],this.iconDisplayRecords=a.tileDisplayData.displayRecords[d.WGLGeometryType.MARKER],this.textDisplayRecords=a.tileDisplayData.displayRecords[d.WGLGeometryType.TEXT],this.displayObjectRegistry=a.tileDisplayData.displayObjectRegistry,this.fillDisplayRecords&&0<this.fillDisplayRecords.length&&
(this.fillGeometry=new m,this.fillGeometry.initializeWithBuffers(this._hasVisualVariables?k.C_FILL_VERTEX_DEF_VV:k.C_FILL_VERTEX_DEF,a.tileBufferData.geometries[d.WGLGeometryType.FILL],35044)),this.lineDisplayRecords&&0<this.lineDisplayRecords.length&&(this.lineGeometry=new m,this.lineGeometry.initializeWithBuffers(this._hasVisualVariables?k.C_LINE_VERTEX_DEF_VV:k.C_LINE_VERTEX_DEF,a.tileBufferData.geometries[d.WGLGeometryType.LINE],35044)),this.iconDisplayRecords&&0<this.iconDisplayRecords.length&&
(this.iconGeometry=new m,this.iconGeometry.initializeWithBuffers(this._hasVisualVariables?k.C_ICON_VERTEX_DEF_VV:k.C_ICON_VERTEX_DEF,a.tileBufferData.geometries[d.WGLGeometryType.MARKER],35044)),this.textDisplayRecords&&0<this.textDisplayRecords.length&&(this.textGeometry=new m,this.textGeometry.initializeWithBuffers(this._hasVisualVariables?k.C_TEXT_VERTEX_DEF_VV:k.C_TEXT_VERTEX_DEF,a.tileBufferData.geometries[d.WGLGeometryType.TEXT],35044)))};c.prototype.appendData=function(a){};c.prototype.updateObjects=
function(a){var b=(a.remove||[]).slice();a=a.update||[];for(var f=[],c=[],g=[],n=[],p=[],e=0;e<a.length;e++){var h=a[e];this.displayObjectRegistry.get(h.id)&&b.push(h.id)}for(var r=0;r<b.length;r++){var q=b[r];if(h=this.displayObjectRegistry.get(q)){for(var t=0,h=h.displayRecords;t<h.length;t++)switch(e=h[t],f.push(e),e.geometryType){case d.WGLGeometryType.FILL:c.push(e);break;case d.WGLGeometryType.LINE:g.push(e);break;case d.WGLGeometryType.MARKER:n.push(e);break;case d.WGLGeometryType.TEXT:p.push(e)}this.displayObjectRegistry.delete(q)}}this.displayList||
(this.displayList=l.pool.acquire());(h=this.displayList)&&h.removeFromList(f);this._removeRecords(this.fillGeometry,this.fillDisplayRecords,c);this._removeRecords(this.lineGeometry,this.lineDisplayRecords,g);this._removeRecords(this.iconGeometry,this.iconDisplayRecords,n);this._removeRecords(this.textGeometry,this.textDisplayRecords,p);b=[];for(f=0;f<a.length;f++){h=a[f];c=0;for(g=h.displayRecords;c<g.length;c++)switch(e=g[c],b.push(e),e.geometryType){case d.WGLGeometryType.FILL:this.fillDisplayRecords=
this.fillDisplayRecords||[];this.fillDisplayRecords.push(e);break;case d.WGLGeometryType.LINE:this.lineDisplayRecords=this.lineDisplayRecords||[];this.lineDisplayRecords.push(e);break;case d.WGLGeometryType.MARKER:this.iconDisplayRecords=this.iconDisplayRecords||[];this.iconDisplayRecords.push(e);break;case d.WGLGeometryType.TEXT:this.textDisplayRecords=this.textDisplayRecords||[],this.textDisplayRecords.push(e)}this.displayObjectRegistry.set(h.id,h)}a=!1;this.fillGeometry||(this.fillGeometry=new m);
this.lineGeometry||(this.lineGeometry=new m);this.iconGeometry||(this.iconGeometry=new m);a=a||this._updateRecords(this.iconGeometry,this.iconDisplayRecords,this._hasVisualVariables?k.C_ICON_VERTEX_DEF_VV:k.C_ICON_VERTEX_DEF);this.textGeometry||(this.textGeometry=new m);a?(this.displayList&&l.pool.release(this.displayList),a=l.pool.acquire(),a.addToList(this.fillDisplayRecords),a.addToList(this.lineDisplayRecords),a.addToList(this.iconDisplayRecords),a.addToList(this.textDisplayRecords),this.displayList=
a):(a=this.displayList)?a.addToList(b):(a=l.pool.acquire(),a.addToList(b),this.displayList=a)};c.prototype._updateRecords=function(a,b,c){if(a.update(b)===d.WGLGeometryTransactionStatus.FAILED_OUT_OF_MEMORY)return a.initializeWithRecords(c,b,35044),this.attached=!1,!0;a.invalidateIndexBuffer();a.invalidateVertexBuffers();return!1};c.prototype._removeRecords=function(a,b,c){if(a){this.iconGeometry.remove(c);for(var f=a=b.length,g=0;g<a;++g){for(var n=void 0,n=0;n<f&&b[g]!==c[n];++n);n<c.length&&(b.splice(g,
1),g--)}}};c.prototype.clear=function(){this.iconGeometry&&(this.iconGeometry.clear(),this.iconGeometry=null);this.textGeometry&&(this.textGeometry.clear(),this.textGeometry=null);this.lineGeometry&&(this.lineGeometry.clear(),this.lineGeometry=null);this.fillGeometry&&(this.fillGeometry.clear(),this.fillGeometry=null);this.displayObjectRegistry.clear();this.displayList&&(l.pool.release(this.displayList),this.displayList=null);this.hlDisplayList&&(l.pool.release(this.hlDisplayList),this.hlDisplayList=
null);this.iconDisplayRecords&&(this.iconDisplayRecords.length=0);this.textDisplayRecords&&(this.textDisplayRecords.length=0);this.lineDisplayRecords&&(this.lineDisplayRecords.length=0);this.fillDisplayRecords&&(this.fillDisplayRecords.length=0)};c.prototype.dispose=function(){this.release()};c.prototype.attach=function(a){var b=!0;this.fillGeometry&&(this.fillGeometry.attached||(b=b&&this.fillGeometry.attach(a)));this.lineGeometry&&(this.lineGeometry.attached||(b=b&&this.lineGeometry.attach(a)));
this.iconGeometry&&(this.iconGeometry.attached||(b=b&&this.iconGeometry.attach(a)));this.textGeometry&&(this.textGeometry.attached||(b=b&&this.textGeometry.attach(a)));return b};c.prototype.detach=function(a){};c.prototype.doRender=function(a){};c.prototype.buildHLList=function(a){var b=this;this.hlDisplayList&&l.pool.release(this.hlDisplayList);this.hlDisplayList=l.pool.acquire();a.forEach(function(a){if(a=b.displayObjectRegistry.get(a)){a=a.displayRecords.map(function(a){var b=q.pool.acquire();
b.id=a.id;b.geometryType=a.geometryType;b.vertexFrom=a.vertexFrom;b.vertexCount=a.vertexCount;b.indexFrom=a.indexFrom;b.indexCount=a.indexCount;b.materialInfo=a.materialInfo;b.meshData=null;b.sortKey=0;b.symbolLevel=0;b.zOrder=0;return b});a.sort(function(a,b){return a.sortKey-b.sortKey});b.hlDisplayList.addToList(a);for(var c=0;c<a.length;c++)q.pool.release(a[c])}})};c.pool=new w(c);return c}(z)});