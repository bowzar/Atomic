// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/accessorSupport/decorators ../../core/arrayUtils ../../core/watchUtils ../../core/Accessor ../../core/HandleRegistry ../../portal/support/geometryServiceUtils ../../geometry/support/webMercatorUtils ../../geometry/support/heightModelInfoUtils".split(" "),function(v,w,p,g,d,h,q,r,t,u,m,n){return function(k){function b(){var a=null!==k&&k.apply(this,arguments)||this;a._handles=new t;a._waitTask=
null;a._isStarted=!1;a._spatialReferenceCandidates=null;a._extentCandidates=null;a.isSpatialReferenceDone=!1;a.isTileInfoDone=!1;a.isHeightModelInfoSearching=!1;a.spatialReference=null;a.extent=null;a.heightModelInfo=null;a.vcsWkid=null;a.latestVcsWkid=null;a.mapCollectionPaths=l.DefaultMapCollectionPaths.slice();a.tileInfo=null;return a}p(b,k);l=b;b.prototype.initialize=function(){var a=this;this.watch("mapCollectionPaths",function(){a._isStarted&&(a.reset(),a.start())})};b.prototype.destroy=function(){this._set("view",
null);this._handles&&(this._handles.destroy(),this._handles=null,this._isStarted=!1);this._cancelLoading()};b.prototype.reset=function(){this._handles.removeAll();this._isStarted=!1;this._set("isSpatialReferenceDone",!1);this._set("isTileInfoDone",!1);this._set("isHeightModelInfoSearching",!1);this._set("spatialReference",null);this._set("extent",null);this._set("heightModelInfo",null);this._set("vcsWkid",null);this._set("latestVcsWkid",null);this._set("tileInfo",null);this._extentCandidates=this._spatialReferenceCandidates=
null};b.prototype.start=function(){this._handles.removeAll();this._isStarted=!0;for(var a=this._updateLayerChange.bind(this),f=0,c=this.mapCollectionPaths;f<c.length;f++)this._handles.add(q.on(this.view,"map."+c[f],"change",a,a,a,!0))};b.prototype._ownerNameFromCollectionName=function(a){var f=a.lastIndexOf(".");return-1===f?"view":"view."+a.slice(0,f)};b.prototype._ensureLoadedOwnersFromCollectionName=function(a){a=this._ownerNameFromCollectionName(a).split(".");for(var f,c=0;c<a.length;c++){f=this.get(a.slice(0,
c+1).join("."));if(!f)break;if(f.load&&!f.isFulfilled())return{owner:null,loading:f.load()}}return{owner:f}};b.prototype._cancelLoading=function(){this._waitTask=null;this._extentProjectTask&&(this._extentProjectTask.cancel(),this._extentProjectTask=null)};b.prototype._updateWhen=function(a){var f=this,c=!0,b=!1,e=a.always(function(){c?b=!0:e===f._waitTask&&f._update()}),c=!1;b||(this._waitTask=e);return b};b.prototype._updateLayerChange=function(){this.isSpatialReferenceDone&&!this.spatialReference&&
this._set("isSpatialReferenceDone",!1);this._update()};b.prototype._update=function(){var a=this;this._cancelLoading();if(this.view){if(!this.isSpatialReferenceDone&&0!==this._processMapCollections(function(c){return a._processSpatialReferenceSource(c)})){var f=null,c=this._spatialReferenceCandidates;!c||1>c.length?f=this.defaultSpatialReference:(this.defaultSpatialReference&&1<c.length&&-1<h.findIndex(c,function(c){return c.equals(a.defaultSpatialReference)})&&(c=[this.defaultSpatialReference]),
f=c[0]);this._set("spatialReference",f);this._set("isSpatialReferenceDone",!0);f&&(this._processMapCollections(function(c){return a._findExtent(c,f)}),this.extent||this._projectExtentCandidate())}null==this.heightModelInfo&&this.view.isHeightModelInfoRequired&&(c=this._processMapCollections(function(c){return a._processHeightModelInfoSource(c)},function(a){return n.mayHaveHeightModelInfo(a)}),this._set("isHeightModelInfoSearching",0===c));null==this.tileInfo&&(c=!1,this.view.isTileInfoRequired()&&
(c=this._deriveTileInfo()),c||this._set("isTileInfoDone",!0))}};b.prototype._processMapCollections=function(a,f){for(var c=0,b=this.mapCollectionPaths;c<b.length;c++){var e="map."+b[c],d=this._ensureLoadedOwnersFromCollectionName(e);if(d.loading&&!this._updateWhen(d.loading))return 0;d=d.owner;if(!(!d||d.isRejected&&d.isRejected())&&(e=this.view.get(e))&&(e=this._processMapCollection(e,a,f),2!==e))return e}return 2};b.prototype._processMapCollection=function(a,f,c){for(var b=0;b<a.length;b++){var e=
a.getItemAt(b),d=null!=c&&!c(e);if(!d&&e.load&&!e.isFulfilled()&&!this._updateWhen(e.load()))return 0;if(!d&&(!e.load||e.isResolved())){if(f(e))return 1;if(e.layers&&(e=this._processMapCollection(e.layers,f),2!==e))return e}}return 2};b.prototype._processSpatialReferenceSource=function(a){a=this._getSupportedSpatialReferences(a);if(0===a.length)return!1;this._spatialReferenceCandidates?(a=h.intersect(a,this._spatialReferenceCandidates,function(a,c){return a.equals(c)}),0<a.length&&(this._spatialReferenceCandidates=
a)):this._spatialReferenceCandidates=a;return 1===this._spatialReferenceCandidates.length};b.prototype._findExtent=function(a,b){var c=a.fullExtents||(a.fullExtent?[a.fullExtent]:[]),f=h.find(c,function(a){return a.spatialReference.equals(b)});if(f)return this._set("extent",f),!0;0<this._getSupportedSpatialReferences(a).length&&(c=c.map(function(c){return{extent:c,layer:a}}),this._extentCandidates=(this._extentCandidates||[]).concat(c));return!1};b.prototype._projectExtentCandidate=function(){var a=
this;if(this._extentCandidates&&this._extentCandidates.length){var b=this.spatialReference,c=h.find(this._extentCandidates,function(a){return m.canProject(a.extent.spatialReference,b)});c?this._set("extent",m.project(c.extent,b)):(c=this._extentCandidates[0],this._extentProjectTask=u.projectGeometry(c.extent,b,c.layer.portalItem).then(function(c){a._set("extent",c)}))}};b.prototype._getSupportedSpatialReferences=function(a){var b=this;return(a.supportedSpatialReferences||(a.spatialReference?[a.spatialReference]:
[])).filter(function(c){return b.view.isSpatialReferenceSupported(c,a)})};b.prototype._processHeightModelInfoSource=function(a){var b=n.deriveHeightModelInfoFromLayer(a);return b?(this._set("heightModelInfo",b),this._set("isHeightModelInfoSearching",!1),a.spatialReference&&(this._set("vcsWkid",a.spatialReference.vcsWkid),this._set("latestVcsWkid",a.spatialReference.latestVcsWkid)),!0):!1};b.prototype._deriveTileInfo=function(){if(!this.isSpatialReferenceDone)return!0;var a=this.get("view.map");if(!a)return!0;
var b=a.basemap,c=b&&b.get("baseLayers.0"),a=a.get("layers.0"),d=!1,e=null;b&&"failed"!==b.loadStatus?b.loaded?c&&"failed"!==c.loadStatus?c.loaded?e=c.tileInfo:(this._updateWhen(c.load()),d=!0):a&&"failed"!==a.loadStatus?a.loaded?e=a.tileInfo:(this._updateWhen(a.load()),d=!0):d=!0:(this._updateWhen(b.load()),d=!0):a&&"failed"!==a.loadStatus&&(a.loaded?e=a.tileInfo:(this._updateWhen(a.load()),d=!0));e&&!e.spatialReference.equals(this.spatialReference)&&(e=null);d||this._set("tileInfo",e);return d};
b.DefaultMapCollectionPaths=["basemap.baseLayers","layers","ground.layers","basemap.referenceLayers"];g([d.property({readOnly:!0})],b.prototype,"isSpatialReferenceDone",void 0);g([d.property({readOnly:!0})],b.prototype,"isTileInfoDone",void 0);g([d.property({readOnly:!0})],b.prototype,"isHeightModelInfoSearching",void 0);g([d.property({constructOnly:!0})],b.prototype,"view",void 0);g([d.property({readOnly:!0})],b.prototype,"spatialReference",void 0);g([d.property({readOnly:!0})],b.prototype,"extent",
void 0);g([d.property({readOnly:!0})],b.prototype,"heightModelInfo",void 0);g([d.property({readOnly:!0})],b.prototype,"vcsWkid",void 0);g([d.property({readOnly:!0})],b.prototype,"latestVcsWkid",void 0);g([d.property()],b.prototype,"mapCollectionPaths",void 0);g([d.property()],b.prototype,"defaultSpatialReference",void 0);g([d.property({readOnly:!0})],b.prototype,"tileInfo",void 0);return b=l=g([d.subclass("esri.views.support.DefaultsFromMap")],b);var l}(d.declared(r))});