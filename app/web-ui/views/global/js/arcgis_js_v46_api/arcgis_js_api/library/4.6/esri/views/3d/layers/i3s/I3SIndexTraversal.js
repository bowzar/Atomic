// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ./GoogPriorityQueue ../../support/PromiseLightweight ../../lib/glMatrix ../../../../core/urlUtils".split(" "),function(t,u,l,q,p,m){var k=l.goog.structs.PriorityQueue;return function(){function c(a,b,d,c,f,h,g,r,k,l,n){void 0===n&&(n={initDepthFirst:!0,neighborhood:!0,perLevelTraversal:!1});var e=this;this.baseURL=a;this.startNodeUrl=b;this.rootId=d;this.poi=c;this.nodeIndex=f;this.streamDataSupplier=h;this.viewportQueries=g;this.processNodeIndexDocument=r;this.finishedLevelCallback=
k;this.logger=l;this.traversalOptions=n;this.queues=[];this.knownNodes=new Set;this.dataLoadingPerLevel=[];this.numIndicesLoading=this.currentLevel=0;this.cancelled=this.queueTraversalEnabled=!1;this.progressiveLoadPenalty=0;this.initQueryErrback=function(){e.initPromise.done()};this.initQueryCallback=function(a,b){if(e.cancelled)e.initPromise.done();else if(e.nodeTraversalState(b.id),e.enqueueConnected(a,b,0),e.isLeafNode(b))e.initPromise.done();else{for(var d=Infinity,c=null,f=0;f<b.children.length;++f){var g=
b.children[f];if(e.nodeIsVisible(g)&&(!e.viewportQueries.hasLOD(b)||!e.viewportQueries.getLodLevel(b))){var h=e.viewportQueries.distToPOI(g,e.poi);h<d&&(d=h,c=g)}}c?(a=m.makeAbsolute(c.href,a),e.getNode(a,c.id,e.initQueryCallback,e.initQueryErrback)):e.initPromise.done()}};this.poi=p.vec3d.create(c);this._maxLodLevel=this.viewportQueries.maxLodLevel}c.prototype.updatePointOfInterest=function(a){p.vec3d.set(a,this.poi);this.reprioritizeQueues()};c.prototype.start=function(){var a=this;this._nodeTraversalState=
{};this._nodeIsVisibleCached={};this.dataLoadingPerLevel=[];this.currentLevel=0;this.maxLevel=[];for(var b=0;b<this._maxLodLevel;b++)this.maxLevel[b]=0;this.rootUrl=m.makeAbsolute(this.startNodeUrl,this.baseURL);this.traversalOptions.initDepthFirst?(this.initPromise=new q.Promise,this.getNode(this.rootUrl,this.rootId,this.initQueryCallback,this.initQueryErrback),this.initPromise.then(function(){a.cancelled||(a.queueTraversalEnabled=!0)})):(this.enqueue({id:this.rootId,hrefConcat:this.rootUrl,mbs:null},
0),this.queueTraversalEnabled=!0)};c.prototype.continueTraversal=function(a){void 0===a&&(a=5);if(this.queueTraversalEnabled)for(var b=0;b<this.queues.length;b++)if(!this.traversalOptions.perLevelTraversal||this.currentLevel===b){for(var d=this.queues[b];this.numIndicesLoading<a&&!d.isEmpty();)this.processQueueOne(b);this.traversalOptions.perLevelTraversal&&d.isEmpty()&&0===this.dataLoadingPerLevel[b]&&(this.finishedLevelCallback.call(null,this.currentLevel),this.currentLevel++)}};c.prototype.isQueueTraversalEnabled=
function(){return this.queueTraversalEnabled};c.prototype.getQueueSize=function(){for(var a=0,b=0;b<this.queues.length;b++)a+=this.queues[b].getCount();return a};c.prototype.cancel=function(){this.queueTraversalEnabled=!1;for(var a=0;a<this.queues.length;a++)this.queues[a].clear();this.cancelled=!0};c.prototype.isLoading=function(){return 0<this.numIndicesLoading||0<this.getQueueSize()};c.prototype.getNumLoading=function(){return this.numIndicesLoading+this.dataLoadingPerLevel[this.currentLevel]};
c.prototype.getMaxLevel=function(a){return this.maxLevel[a]};c.prototype.nodeIsVisible=function(a){if(this.traversalOptions.loadEverything)return!0;if(null!=this._nodeIsVisibleCached[a.id])return this._nodeIsVisibleCached[a.id];this._nodeIsVisibleCached[a.id]=this.viewportQueries.isNodeVisible(a);return this._nodeIsVisibleCached[a.id]};c.prototype.nodeTraversalState=function(a){if(null!=this._nodeTraversalState[a])return this._nodeTraversalState[a];var b=this.nodeIndex[a];if(null==b)return null;var d=
null,e=0;if(null!=b.parentNode){d=this.nodeIndex[b.parentNode.id];if(null==d)return null;d=this._nodeTraversalState[d.id];null!=d&&(e=d.lodLevel)}var d=this.viewportQueries.hasLOD(b),c=this.viewportQueries.getLodLevel(b);this._nodeTraversalState[b.id]={visited:!0,nodeHasLOD:d,lodLevel:c,isChosen:!d||c>e};return this._nodeTraversalState[a]};c.prototype.reprioritizeQueues=function(){for(var a=0;a<this.queues.length;a++)this.queues[a]=this.reprioritizeQueue(this.queues[a])};c.prototype.reprioritizeQueue=
function(a){for(var b=new k;!a.isEmpty();){var d=a.dequeue(),e=this.entryPriority(d);b.enqueue(e,d)}return b};c.prototype.processQueueOne=function(a){var b=this,d=this.queues[a].dequeue();this.dataLoadingPerLevel[a]++;var e=function(){return b.dataLoadingPerLevel[a]--},c=function(c,g){b.nodeTraversalState(g.id);b.enqueueConnected(c,g,a);c=b.entryPriority(d);b.processNodeIndexDocument(g,c).then(e,e)};this.getNode(d.hrefConcat,d.id,function(a,d){if(b.traversalOptions.neighborhood&&null!=d.parentNode){var f=
b.concatHref(d.parentNode,a);b.getNode(f,d.parentNode.id,function(){return c(a,d)},e)}else c(a,d)},e)};c.prototype.getNode=function(a,b,d,c){var e=this;this.numIndicesLoading++;this.nodeIndex[b]?(d(a,this.nodeIndex[b]),this.numIndicesLoading--):this.streamDataSupplier.request(a,"json").then(function(a,b){e.nodeIndex[b.id]=b;b.baseUrl=a;d(a,b);e.numIndicesLoading--},function(b){null!=c&&c(b);e.loadErrorCallback(a);e.numIndicesLoading--})};c.prototype.isLeafNode=function(a){return null==a.children};
c.prototype.concatHref=function(a,b){return m.makeAbsolute(a.href,b)};c.prototype.enqueue=function(a,b){this.traversalOptions.perLevelTraversal||(b=0);for(this.knownNodes.add(a.id);this.queues.length<=b;)this.queues.push(new k),this.dataLoadingPerLevel.push(0);var d=this.entryPriority(a);this.queues[b].enqueue(d,a)};c.prototype.entryPriority=function(a){if(a.id===this.rootId)return 0;var b=0,d=this.nodeIndex[a.id];null!=d&&null!=d.parentNode&&(d=this._nodeTraversalState[d.parentNode.id],null!=d&&
(b=d.lodLevel));a=this.viewportQueries.distToPOI(a,this.poi);return a+b*(a+this.progressiveLoadPenalty)};c.prototype.queueEntryFromNode=function(a,b){return{id:a.id,mbs:a.mbs,hrefConcat:b}};c.prototype.queueEntryFromNodeRef=function(a,b){return this.queueEntryFromNode(a,this.concatHref(a,b))};c.prototype.enqueueConnected=function(a,b,d){if(!this.cancelled&&null!=b){b.id===this.rootId||null==b.parentNode||this.knownNodes.has(b.parentNode.id)?b.id===this.rootId&&!this.knownNodes.has(b.id)&&this.nodeIsVisible(b)&&
this.enqueue(this.queueEntryFromNode(b,a),d):this.enqueue(this.queueEntryFromNodeRef(b.parentNode,a),d-1);var c=this.nodeTraversalState(b.id);if(!c.nodeHasLOD||c.lodLevel!==this._maxLodLevel){if(b.children)for(var f=0,h=b.children;f<h.length;f++){var g=h[f],k=this.nodeIsVisible(g);!this.knownNodes.has(g.id)&&k&&(this.enqueue(this.queueEntryFromNodeRef(g,a),d+1),this.maxLevel[c.lodLevel]=Math.max(b.level+1,this.maxLevel[c.lodLevel]))}if(this.traversalOptions.neighborhood&&b.neighbors)for(c=0,b=b.neighbors;c<
b.length;c++)f=b[c],h=this.nodeIsVisible(f),!this.knownNodes.has(f.id)&&h&&this.enqueue(this.queueEntryFromNodeRef(f,a),d)}}};c.prototype.loadErrorCallback=function(a){this.logger.warn("Error loading node: "+a)};return c}()});