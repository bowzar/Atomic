// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ./Graphics3DSymbolLayer ./Graphics3DGraphicLayer ./Graphics3DSymbolCommonCode ../../../../geometry/Polygon ../../../../geometry/Point ../../support/projectionUtils ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/materials/Material ../../webgl-engine/lib/Util ./earcut/earcut ./graphicUtils".split(" "),function(M,oa,Y,Z,aa,
H,ba,ca,da,N,O,ea,fa,ga,ha,ia,ja,ka){function la(d,e,a,b,c,k,f,v,w,l,m,t,g,ma){var n=a.length/3,C=0;m+=2*b.count;var h=b.index,y=b.count,p=w,u=m;q.set(g,r);var x=0<t?1:-1,h=3*h,z=p;g=3*z;for(var A=p+y,p=3*A,D=0;D<y;++D)ma&&(r[0]=d[h+0],r[1]=d[h+1],r[2]=d[h+2],q.normalize(r)),c[g+0]=d[h+0],c[g+1]=d[h+1],c[g+2]=d[h+2],k[g+0]=e[h+0],k[g+1]=e[h+1],k[g+2]=e[h+2],f[g+0]=-x*r[0],f[g+1]=-x*r[1],f[g+2]=-x*r[2],v[z]=0,c[p+0]=d[h+0]+t*r[0],c[p+1]=d[h+1]+t*r[1],c[p+2]=d[h+2]+t*r[2],k[p+0]=e[h+0],k[p+1]=e[h+1],
k[p+2]=e[h+2],f[p+0]=x*r[0],f[p+1]=x*r[1],f[p+2]=x*r[2],v[A]=t,g+=3,p+=3,h+=3,z+=1,A+=1;h=0;g=3*u;p=3*(u+n);g=3*(u+n);p=3*u;d=P;e=Q;0>t&&(d=Q,e=P);for(D=0;D<n;++D)l[g+0]=a[h+d[0]],l[g+1]=a[h+d[1]],l[g+2]=a[h+d[2]],l[p+0]=a[h+e[0]]+y,l[p+1]=a[h+e[1]]+y,l[p+2]=a[h+e[2]]+y,g+=3,p+=3,h+=3;w+=2*b.count;m=m+2*n-(2*b.count+2*n);R(c,k,v,f,C,b.pathLengths[0],b.count,w,l,m,t);w+=4*b.pathLengths[0];m+=2*b.pathLengths[0];C+=b.pathLengths[0];for(a=1;a<b.pathLengths.length;++a)R(c,k,v,f,C,b.pathLengths[a],b.count,
w,l,m,t),w+=4*b.pathLengths[a],m+=2*b.pathLengths[a],C+=b.pathLengths[a]}function K(d,e,a,b,c,k,f){b[k]=b[f];f*=3;k*=3;d[k+0]=d[f+0];d[k+1]=d[f+1];d[k+2]=d[f+2];e[k+0]=e[f+0];e[k+1]=e[f+1];e[k+2]=e[f+2];a[k+0]=c[0];a[k+1]=c[1];a[k+2]=c[2]}function R(d,e,a,b,c,k,f,v,w,l,m){var t=c,g=c+1,r=c+f,n=c+f+1,C=v,h=v+1,y=v+2*k;v=v+2*k+1;0>m&&(t=c+f+1,n=c);l*=3;for(var p=0;p<k;++p){p===k-1&&(0<m?(g=c,n=c+f):(g=c,t=c+f));var u=d,x=t,z=g,A=r,D=I,x=3*x,z=3*z,A=3*A;q.set3(u[x++],u[x++],u[x++],L);q.set3(u[z++],u[z++],
u[z++],S);q.set3(u[A++],u[A++],u[A++],T);q.subtract(S,L,U);q.subtract(T,L,V);q.cross(V,U,D);q.normalize(D,D);K(d,e,b,a,I,C,t);K(d,e,b,a,I,h,g);K(d,e,b,a,I,y,r);K(d,e,b,a,I,v,n);w[l++]=C;w[l++]=y;w[l++]=v;w[l++]=C;w[l++]=v;w[l++]=h;t++;g++;r++;n++;C+=2;h+=2;y+=2;v+=2}}function na(d,e,a,b){var c=b.setAltitude;J.spatialReference=a.spatialReference;for(var k=d.getGeometryRecords(),f=k.length,v="absolute-height"!==e.mode,w=0,l=0;l<f;l++){var m=k[l].geometry,t=k[l].transformation,g=m.getData();E[0]=t[12];
E[1]=t[13];E[2]=t[14];m.invalidateBoundingInfo();for(var g=g.getVertexAttr(),m=g[F.POSITION].data,t=g[F.SIZE].data,g=g.mapPos.data,q=m.length/3,n=0,r=0,h=!1,y=0,p=0;p<q;p++){J.x=g[r];J.y=g[r+1];J.z=g[r+2];G[0]=m[n];G[1]=m[n+1];G[2]=m[n+2];var u=H.computeElevation(a,J,e,b,v?W:null);v&&(y+=W.terrainElevation);B[0]=m[n]+E[0];B[1]=m[n+1]+E[1];B[2]=m[n+2]+E[2];c(u+t[n/3],B);m[n]=B[0]-E[0];m[n+1]=B[1]-E[1];m[n+2]=B[2]-E[2];u=.01/b.unitInMeters;if(Math.abs(G[0]-m[n])>u||Math.abs(G[1]-m[n+1])>u||Math.abs(G[2]-
m[n+2])>u)h=!0;r+=3;n+=3}h&&d.geometryVertexAttrsUpdated(l);w+=y/q}return w/f}var F=ia.VertexAttrConstants,q=N.vec3d,X=N.mat4d,B=q.create(),r=q.create(),P=[0,2,1],Q=[0,1,2],J=new ca,W={verticalDistanceToGround:0,terrainElevation:0};M=function(d){function e(){return null!==d&&d.apply(this,arguments)||this}Y(e,d);e.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var a=ka.validateSymbolLayerSize(this._getSymbolSize());if(a){this._logWarning(a);this.reject();return}}var a=this._getStageIdHint(),
b=this._getMaterialOpacityAndColor(),c=q.create(b),b=b[3],c={diffuse:c,ambient:c,opacity:b,transparent:1>b||this._isPropertyDriven("opacity"),vertexColors:!0};this._material=new ha(c,a+"_3dlinemat");this._context.stage.add(O.ModelContentType.MATERIAL,this._material);this.resolve()};e.prototype.destroy=function(){d.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._material&&this._context.stage.remove(O.ModelContentType.MATERIAL,this._material.getId())};e.prototype.createGraphics3DGraphic=
function(a,b){var c=this._validateGeometry(a.geometry);if("polygon"!==c.type&&"extent"!==c.type)return this._logWarning("unsupported geometry type for extrude symbol: "+c.type),null;var c="polygon"===c.type||"extent"===c.type?"rings":"paths",k="graphic"+a.uid,f=this._getVertexOpacityAndColor(b,Float32Array,255),e=this.getGraphicElevationContext(a);return this._createAs3DShape(a,c,b,f,e,k,a.uid)};e.prototype.layerPropertyChanged=function(a,b,c){if("opacity"===a)return b=this._getMaterialOpacity(),
c=1>b||this._isPropertyDriven("opacity"),this._material.setParameterValues({opacity:b,transparent:c}),!0;if("elevationInfo"===a){this._updateElevationContext();for(var k in b){var f=b[k];if(a=c(f))f=this.getGraphicElevationContext(f.graphic),a.needsElevationUpdates=H.needsElevationUpdates3D(f.mode),a.elevationContext.set(f)}return!0}return!1};e.prototype._getExtrusionSize=function(a){a=a.size&&this._isPropertyDriven("size")?H.getSingleSizeDriver(a.size,2):this._getSymbolSize();return a/=this._context.renderCoordsHelper.unitInMeters};
e.prototype._getSymbolSize=function(){return this.symbol.size||1};e.prototype._createAs3DShape=function(a,b,c,k,f,e,d){var l=a.geometry;"extent"===l.type&&(l=ba.fromExtent(l));a=l[b];var m=l.hasZ,v=[],g=[],r=[],n=q.create(),w=Array(6),h=this._context.renderSpatialReference===da.SphericalECEFSpatialReference,y=this._getExtrusionSize(c),p=q.create();h||this._context.renderCoordsHelper.worldUpAtPosition(null,p);c=H.getGeometryVertexData3D(a,m,l.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,
this._context.renderCoordsHelper,f);this._logGeometryCreationWarnings(c,a,b,"ExtrudeSymbol3DLayer");if(0<a.length){var u=c.geometryData.polygons,x=c.eleVertexData,z=c.vertexData;b=z.length/3;var A=new Float64Array(18*b),D=new Float64Array(18*b),E=new Float64Array(18*b),F=new Float64Array(6*b),B=0;b=function(a){var b=u[a],c=b.count,d=b.index;if(G._context.clippingExtent&&(H.computeBoundingBox(x,d,c,w),H.boundingBoxClipped(w,G._context.clippingExtent)))return"continue";var f=new Float64Array(x.buffer,
3*d*A.BYTES_PER_ELEMENT,3*c),m=b.holeIndices.map(function(a){return a-d}),f=ja(f,m,3);if(0<f.length){H.chooseOrigin(z,d,c,n);var m=new Uint32Array(6*c+2*f.length),l=6*c,q=new Float64Array(A.buffer,3*B*A.BYTES_PER_ELEMENT,3*l),t=new Float64Array(D.buffer,3*B*D.BYTES_PER_ELEMENT,3*l),C=new Float64Array(E.buffer,3*B*E.BYTES_PER_ELEMENT,3*l),I=new Float64Array(F.buffer,1*B*F.BYTES_PER_ELEMENT,1*l);la(z,x,f,b,q,C,t,I,0,m,0,y,p,h);H.subtractCoordinates(q,0,l,n);B+=6*c;b=G._createExtrudeGeometry(m,{positions:q,
elevation:C,normals:t,heights:I},k);a=new fa(b,e+"path"+a);a.singleUse=!0;v.push(a);g.push([G._material]);a=X.identity();X.translate(a,n,a);r.push(a)}};var G=this;for(a=0;a<u.length;++a)b(a);if(0<v.length)return d=new ea({geometries:v,materials:g,transformations:r,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicId:d},idHint:e}),d=new aa(this,d,v,null,null,na,f),d.alignedTerrainElevation=c.terrainElevation,d.needsElevationUpdates=H.needsElevationUpdates3D(f.mode),d}return null};e.prototype._createExtrudeGeometry=
function(a,b,c){for(var d=a.length,f=new Uint32Array(d),e=0;e<d;e++)f[e]=0;d={};e={};d[F.POSITION]=a;d[F.NORMAL]=a;d[F.COLOR]=f;e[F.POSITION]={size:3,data:b.positions};e[F.NORMAL]={size:3,data:b.normals};e[F.COLOR]={size:4,data:c};e[F.SIZE]={size:1,data:b.heights};b.elevation&&(e.mapPos={size:3,data:b.elevation},d.mapPos=a);return new ga(e,d)};return e}(Z);var I=q.create(),L=q.create(),S=q.create(),T=q.create(),U=q.create(),V=q.create(),G=q.create(),E=q.create();return M});