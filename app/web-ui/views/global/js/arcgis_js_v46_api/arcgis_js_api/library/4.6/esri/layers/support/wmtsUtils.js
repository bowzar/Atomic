// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../geometry/Extent ../../geometry/Point ../../geometry/SpatialReference ../../geometry/support/WKIDUnitConversion ./TileInfo ../../core/Error".split(" "),function(K,q,A,u,B,r,C,D){function l(a,c){return(a=c.getElementsByTagName(a))&&0<a.length?a[0]:null}function n(a,c){return Array.prototype.slice.call(c.getElementsByTagName(a)).map(function(a){return a.textContent})}function h(a,c){a.split("\x3e").forEach(function(a){c=l(a,c)});return c&&c.textContent}function p(a,c,b,
f){var d;Array.prototype.slice.call(f.childNodes).some(function(f){if(-1<f.nodeName.indexOf(a)){var e=l(c,f),e=e&&e.textContent;return e===b||b.split(":")&&b.split(":")[1]===e?(d=f,!0):!1}});return d}function v(a){var c=[],b=w[a],f=Array.prototype.slice.call(b.getElementsByTagName("ResourceURL")),b=b.getElementsByTagName("Dimension"),d,g,e,k;b.length&&(d=h("Identifier",b[0]),g=n("Default",b[0])||n("Value",b[0]));1<b.length&&(e=h("Identifier",b[1]),k=n("Default",b[1])||n("Value",b[1]));m[a]={dimensions:g,
dimensions2:k};f.forEach(function(a){var b=a.getAttribute("template");if(d&&g.length)if(-1<b.indexOf("{"+d+"}"))b=b.replace("{"+d+"}","{dimensionValue}");else{var f=b.toLowerCase().indexOf("{"+d.toLowerCase()+"}");-1<f&&(b=b.substring(0,f)+"{dimensionValue}"+b.substring(f+d.length+2))}e&&k.length&&(-1<b.indexOf("{"+e+"}")?b=b.replace("{"+e+"}","{dimensionValue2}"):(f=b.toLowerCase().indexOf("{"+e.toLowerCase()+"}"),-1<f&&(b=b.substring(0,f)+"{dimensionValue2}"+b.substring(f+e.length+2))));c.push({template:b,
format:a.getAttribute("fomrat"),resourceType:a.getAttribute("resourceType")})});return c}function F(a){return Array.prototype.slice.call(a.getElementsByTagName("Style")).map(function(a){var b=l("LegendURL",a),c=l("Keywords",a),c=c&&n("Keyword",c);return{abstract:h("Abstract",a),id:h("Identifier",a),isDefault:"true"===a.getAttribute("isDefault"),keywords:c,legendUrl:b&&b.getAttribute("xlink:href"),title:h("Title",a)}})}function G(a,c){return n("TileMatrixSet",a).map(function(b){return H(b,a,c)})}function H(a,
c,b){c=p("TileMatrixSetLink","TileMatrixSet",a,c);c=n("TileMatrix",c);var f=p("TileMatrixSet","Identifier",a,b);b=I(f);var d=b.spatialReference,g=d.wkid,e=l("TileMatrix",f),e=[parseInt(h("TileWidth",e),10),parseInt(h("TileHeight",e),10)],k=[];c.length?c.forEach(function(b,c){b=p("TileMatrix","Identifier",b,f);k.push(x(b,g,c,a))}):Array.prototype.slice.call(f.getElementsByTagName("TileMatrix")).forEach(function(b,c){k.push(x(b,g,c,a))});c=J(f,b,e,k[0]);return{id:a,fullExtent:c,tileInfo:new C({dpi:96,
spatialReference:d,size:e,origin:b,lods:k})}}function I(a){var c=h("SupportedCRS",a);c&&(c=c.toLowerCase());var b=parseInt(c.split(":").pop(),10);if(900913===b||3857===b)b=102100;var f=!1;if(-1<c.indexOf("crs84")||-1<c.indexOf("crs:84"))b=4326,f=!0;else if(-1<c.indexOf("crs83")||-1<c.indexOf("crs:83"))b=4269,f=!0;else if(-1<c.indexOf("crs27")||-1<c.indexOf("crs:27"))b=4267,f=!0;var d=new B({wkid:b});a=l("TileMatrix",a);var g=h("TopLeftCorner",a).split(" ");a=g[0].split("E").map(function(a){return Number(a)});
var g=g[1].split("E").map(function(a){return Number(a)}),e=a[0],k=g[0],t;1<a.length&&(e=a[0]*Math.pow(10,a[1]));1<g.length&&(k=g[0]*Math.pow(10,g[1]));var E=f&&4326===b&&90===e&&-180===k;y.some(function(a,g){var h=Number(c.split(":").pop());if(h>=a[0]&&h<=a[1]||4326===b&&(!f||E))return t=new u(k,e,d),!0;g===y.length-1&&(t=new u(e,k,d));return!1});return t}function J(a,c,b,f){var d=l("BoundingBox",a),g,e;d&&(g=h("LowerCorner",d).split(" "),e=h("UpperCorner",d).split(" "));g&&1<g.length&&e&&1<e.length?
(a=parseFloat(g[0]),b=parseFloat(g[1]),g=parseFloat(e[0]),e=parseFloat(e[1])):(a=l("TileMatrix",a),g=parseFloat(h("MatrixWidth",a)),d=parseFloat(h("MatrixHeight",a)),a=c.x,e=c.y,g=a+g*b[0]*f.resolution,b=e-d*b[1]*f.resolution);return new A(a,b,g,e,c.spatialReference)}function x(a,c,b,f){var d=h("Identifier",a);a=h("ScaleDenominator",a).split("E").map(function(a){return Number(a)});a=1<a.length?a[0]*Math.pow(10,a[1]):a[0];c=z(c,a,f);return{level:b,levelValue:d,scale:1.058267716535433*a,resolution:c}}
function z(a,c,b){a=r.hasOwnProperty(String(a))?r.values[r[a]]:"default028mm"===b?6370997*Math.PI/180:6378137*Math.PI/180;return 7*c/25E3/a}Object.defineProperty(q,"__esModule",{value:!0});var y=[[3819,3819],[3821,3824],[3889,3889],[3906,3906],[4001,4025],[4027,4036],[4039,4047],[4052,4055],[4074,4075],[4080,4081],[4120,4176],[4178,4185],[4188,4216],[4218,4289],[4291,4304],[4306,4319],[4322,4326],[4463,4463],[4470,4470],[4475,4475],[4483,4483],[4490,4490],[4555,4558],[4600,4646],[4657,4765],[4801,
4811],[4813,4821],[4823,4824],[4901,4904],[5013,5013],[5132,5132],[5228,5229],[5233,5233],[5246,5246],[5252,5252],[5264,5264],[5324,5340],[5354,5354],[5360,5360],[5365,5365],[5370,5373],[5381,5381],[5393,5393],[5451,5451],[5464,5464],[5467,5467],[5489,5489],[5524,5524],[5527,5527],[5546,5546],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,
2953],[3006,3030],[3034,3035],[3038,3051],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3150,3151],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3389,3390],[3416,3417],[3833,3841],[3844,3850],[3854,3854],[3873,3885],[3907,3910],[4026,4026],[4037,4038],[4417,4417],[4434,4434],[4491,4554],[4839,4839],[5048,5048],[5105,5130],[5253,5259],[5269,5275],[5343,5349],[5479,5482],[5518,5519],[5520,5520],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,
22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]],m=new Map,w=new Map;q.parseCapabilities=function(a,c){a=a.replace(/ows:/gi,"");a=(new DOMParser).parseFromString(a,"text/xml").documentElement;var b=l("Contents",a);if(!b)throw new D("wmtslayer:wmts-capabilities-xml-is-not-valid");var f=l("OperationsMetadata",a),f=(f=(f=f&&f.querySelector("[name\x3d'GetTile']"))&&
f.getElementsByTagName("Get"))&&Array.prototype.slice.call(f),d=c.serviceMode,g,e,k;f&&f.length&&f.some(function(a){var b=l("Constraint",a);if(!b||p("AllowedValues","Value",d,b))return e=a.attributes[0].nodeValue,!0;if(!b||p("AllowedValues","Value","RESTful",b)||p("AllowedValues","Value","REST",b))k=a.attributes[0].nodeValue;else if(!b||p("AllowedValues","Value","KVP",b))g=a.attributes[0].nodeValue;return!1});e||(k?(e=k,d="RESTful"):g?(e=g,d="KVP"):e=l("ServiceMetadataURL",a).getAttribute("xlink:href"));
c=e.indexOf("1.0.0/");-1===c&&"RESTful"===d?e+="/":-1<c&&(e=e.substring(0,c));"KVP"===d&&(e+=-1<c?"":"?");c=h("ServiceIdentification\x3eAccessConstraints",a);a=Array.prototype.slice.call(b.getElementsByTagName("Layer")).map(function(a){var c=h("Identifier",a);w[c]=a;var d=h("Abstract",a),f=n("Format",a),e,g=l("WGS84BoundingBox",a);e=g?h("LowerCorner",g).split(" "):["-180","-90"];g=g?h("UpperCorner",g).split(" "):["180","90"];e={xmin:parseFloat(e[0]),ymin:parseFloat(e[1]),xmax:parseFloat(g[0]),ymax:parseFloat(g[1]),
spatialReference:{wkid:4326}};var g=F(a),k=h("Title",a);a=G(a,b);return{id:c,fullExtent:e,description:d,formats:f,styles:g,title:k,tileMatrixSets:a}});return{copyright:c,layers:a,tileUrl:e,serviceMode:d}};q.parseResourceInfo=function(a){a.layers.forEach(function(a){a.tileMatrixSets.forEach(function(a){var b=a.tileInfo;96!==b.dpi&&(b.lods.forEach(function(c){c.scale=96*c.scale/b.dpi;c.resolution=z(b.spatialReference.wkid,90.71428571428571*c.scale/96,a.id)}),b.dpi=96)})});return a};q.getTileUrlFromResourceUrls=
function(a,c,b,f,d,g){var e=v(a),h=m[a].dimensions&&m[a].dimensions[0];a=m[a].dimensions2&&m[a].dimensions2[0];var l="";e&&0<e.length&&(l=e[d%e.length].template.replace(/\{Style\}/gi,b).replace(/\{TileMatrixSet\}/gi,c).replace(/\{TileMatrix\}/gi,f).replace(/\{TileRow\}/gi,d).replace(/\{TileCol\}/gi,g).replace(/\{dimensionValue\}/gi,h).replace(/\{dimensionValue2\}/gi,a));return l};q.getTileUrlTemplateFromResourceUrls=function(a,c,b,f){b=v(a);var d="";if(b&&0<b.length){var g=m[a].dimensions&&m[a].dimensions[0];
a=m[a].dimensions2&&m[a].dimensions2[0];d=b[0].template;d.indexOf(".xxx")===d.length-4&&(d=d.slice(0,d.length-4));d=d.replace(/\{Style\}/gi,f);d=d.replace(/\{TileMatrixSet\}/gi,c);d=d.replace(/\{TileMatrix\}/gi,"{level}");d=d.replace(/\{TileRow\}/gi,"{row}");d=d.replace(/\{TileCol\}/gi,"{col}");d=d.replace(/\{dimensionValue\}/gi,g);d=d.replace(/\{dimensionValue2\}/gi,a)}return d}});