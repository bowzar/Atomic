// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../webgl/VertexArrayObject","../../../../webgl/Texture","../Utils"],function(x,y,n,w,t){return function(){function l(){this._iconAttributeLocations={a_pos:0,a_vertexOffsetAndTex:1,a_id:2,a_color:3,a_outlineColor:4,a_sizeAndOutlineWidth:5};this._iconAttributeLocationsVV={a_pos:0,a_vertexOffsetAndTex:1,a_id:2,a_color:3,a_outlineColor:4,a_sizeAndOutlineWidth:5,a_vv:6};this._iconAttributeLocationsHeatmap={a_pos:0,a_vertexOffsetAndTex:1,a_id:2,a_color:3,a_outlineColor:4,
a_sizeAndOutlineWidth:5,a_weight:6};this._iconVertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:24,normalized:!1,divisor:0},{name:"a_vertexOffsetAndTex",count:4,type:5120,offset:4,stride:24,normalized:!1,divisor:0},{name:"a_id",count:4,type:5121,offset:8,stride:24,normalized:!0,divisor:0},{name:"a_color",count:4,type:5121,offset:12,stride:24,normalized:!0,divisor:0},{name:"a_outlineColor",count:4,type:5121,offset:16,stride:24,normalized:!0,divisor:0},{name:"a_sizeAndOutlineWidth",
count:4,type:5121,offset:20,stride:24,normalized:!1,divisor:0}]};this._iconVertexAttributesWithVV={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:40,normalized:!1,divisor:0},{name:"a_vertexOffsetAndTex",count:4,type:5120,offset:4,stride:40,normalized:!1,divisor:0},{name:"a_id",count:4,type:5121,offset:8,stride:40,normalized:!0,divisor:0},{name:"a_color",count:4,type:5121,offset:12,stride:40,normalized:!0,divisor:0},{name:"a_outlineColor",count:4,type:5121,offset:16,stride:40,normalized:!0,
divisor:0},{name:"a_sizeAndOutlineWidth",count:4,type:5121,offset:20,stride:40,normalized:!1,divisor:0},{name:"a_vv",count:4,type:5126,offset:24,stride:40,normalized:!1,divisor:0}]};this._iconVertexAttributesWithHeatmap={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:28,normalized:!1,divisor:0},{name:"a_vertexOffsetAndTex",count:4,type:5120,offset:4,stride:28,normalized:!1,divisor:0},{name:"a_id",count:4,type:5121,offset:8,stride:28,normalized:!0,divisor:0},{name:"a_color",count:4,type:5121,
offset:12,stride:28,normalized:!0,divisor:0},{name:"a_outlineColor",count:4,type:5121,offset:16,stride:28,normalized:!0,divisor:0},{name:"a_sizeAndOutlineWidth",count:4,type:5121,offset:20,stride:28,normalized:!1,divisor:0},{name:"a_weight",count:1,type:5126,offset:24,stride:28,normalized:!1,divisor:0}]};this._spritesTextureSize=new Float32Array(2)}l.prototype.draw=function(f,a,q,d,b,m,n,h,c,l,t){if(q.canDisplay){var e=a.materialKeyInfo,k=e.heatmap,g=e.vvSizeMinMaxValue||e.vvSizeScaleStops||e.vvSizeFieldStops||
e.vvSizeUnitValue||e.vvColor||e.vvRotation||e.vvOpacity;if(b=h.getProgram(a.materialKey,b,g?this._iconAttributeLocationsVV:this._iconAttributeLocations)){f.bindProgram(b);g=this._getVAO(f,q,g,k);f.bindVAO(g);if(k){c=d.heatmapParameters;if(c.intensityKernel&&!c.refreshIntensityKernel)c=c.intensityKernel;else{c.intensityKernel&&(c.intensityKernel.dispose(),c.intensityKernel=null);h=c.radius;a=c.kernelSize;for(var u=c.blurRadius,v=h*h,k=[],g=-1;++g<a;)k[g]=Math.exp(-Math.pow(g-u,2)/(2*v))/(h/2*Math.sqrt(2*
Math.PI));h=[];for(var p,r=0;r<a;r++)for(v=k[r],g=0;g<a;g++)p=r*a+g,u=k[g],h[4*p+0]=v*u,h[4*p+1]=0,h[4*p+2]=0,h[4*p+3]=1;a=new w(f,{target:3553,pixelFormat:6408,internalFormat:34836,dataType:5126,samplingMode:f.extensions.textureFloatLinear?9729:9728,wrapMode:33071,width:a,height:a},new Float32Array(h));c.intensityKernel=a;c.refreshIntensityKernel=!1;c=a}f.bindTexture(c,1);b.setUniform1i("u_texture",1);this._spritesTextureSize[0]=Math.round(d.heatmapParameters.radius);this._spritesTextureSize[1]=
Math.round(d.heatmapParameters.radius)}else k=a.texBindingInfo[0],a=k.pageId,c.bindSpritePage(f,a,k.unit),b.setUniform1i(k.semantic,k.unit),c=c.sprites,this._spritesTextureSize[0]=c.getWidth(a)/4,this._spritesTextureSize[1]=c.getHeight(a)/4;l=d.vvMaterialParameters.vvRotationEnabled&&"geographic"===d.vvMaterialParameters.vvRotationType?l:t;b.setUniformMatrix4fv("u_transformMatrix",q.tileTransform.transform);b.setUniformMatrix4fv("u_extrudeMatrix",l);b.setUniform2fv("u_normalized_origin",q.tileTransform.displayCoord);
b.setUniform2fv("u_mosaicSize",this._spritesTextureSize);b.setUniform1f("u_opacity",1);e.vvSizeMinMaxValue&&b.setUniform4fv("u_vvSizeMinMaxValue",d.vvSizeMinMaxValue);e.vvSizeScaleStops&&b.setUniform1f("u_vvSizeScaleStopsValue",d.vvSizeScaleStopsValue);e.vvSizeFieldStops&&(b.setUniform1fv("u_vvSizeFieldStopsValues",d.vvSizeFieldStopsValues),b.setUniform1fv("u_vvSizeFieldStopsSizes",d.vvSizeFieldStopsSizes));e.vvSizeUnitValue&&b.setUniform1f("u_vvSizeUnitValueWorldToPixelsRatio",d.vvSizeUnitValueToPixelsRatio);
e.vvColor&&(b.setUniform1fv("u_vvColorValues",d.vvColorValues),b.setUniform4fv("u_vvColors",d.vvColors));e.vvOpacity&&(b.setUniform1fv("u_vvOpacityValues",d.vvOpacityValues),b.setUniform1fv("u_vvOpacities",d.vvOpacities));f.drawElements(4,n,5125,4*m);f.bindVAO(null)}}};l.prototype._getVAO=function(f,a,l,d){if(a.iconGeometry.vao)return a.iconGeometry.vao;var b=a.iconGeometry.vertexBufferMap[t.C_VBO_GEOMETRY],m=a.iconGeometry.indexBuffer;if(!b||!m)return null;a.iconGeometry.vao=l?new n(f,this._iconAttributeLocationsVV,
this._iconVertexAttributesWithVV,{geometry:b},m):d?new n(f,this._iconAttributeLocationsHeatmap,this._iconVertexAttributesWithHeatmap,{geometry:b},m):new n(f,this._iconAttributeLocations,this._iconVertexAttributes,{geometry:b},m);return a.iconGeometry.vao};return l}()});