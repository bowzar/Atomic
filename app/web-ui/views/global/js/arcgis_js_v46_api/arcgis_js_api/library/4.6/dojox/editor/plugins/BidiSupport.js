//>>built
define("dojo/_base/declare dojo/_base/array dojo/aspect dojo/_base/lang dojo/dom-attr dojo/dom-class dojo/dom-construct dojo/i18n dojo/NodeList-dom dojo/NodeList-traverse dojo/dom-style dojo/sniff dojo/query dijit dojox dijit/_editor/_Plugin dijit/_editor/range dijit/_editor/plugins/EnterKeyHandling dijit/_editor/plugins/FontChoice ./NormalizeIndentOutdent dijit/form/ToggleButton dojo/i18n!./nls/BidiSupport".split(" "),function(A,q,w,n,l,B,m,C,G,H,g,p,r,I,J,x,t,y,D,E,F){var z=A("dojox.editor.plugins.BidiSupport",
x,{useDefaultCommand:!1,buttonClass:null,iconClassPrefix:"dijitAdditionalEditorIcon",command:"bidiSupport",blockMode:"DIV",shortcutonly:!1,bogusHtmlContent:"\x26nbsp;",buttonLtr:null,buttonRtl:null,_indentBy:40,_lineTextArray:"DIV P LI H1 H2 H3 H4 H5 H6 ADDRESS PRE DT DE TD".split(" "),_lineStyledTextArray:"H1 H2 H3 H4 H5 H6 ADDRESS PRE P".split(" "),_tableContainers:["TABLE","THEAD","TBODY","TR"],_blockContainers:["TABLE","OL","UL","BLOCKQUOTE"],_initButton:function(){this.shortcutonly||(this.buttonLtr||
(this.buttonLtr=this._createButton("ltr")),this.buttonRtl||(this.buttonRtl=this._createButton("rtl")))},_createButton:function(a){return F(n.mixin({label:C.getLocalization("dojox.editor.plugins","BidiSupport")[a],dir:this.editor.dir,lang:this.editor.lang,showLabel:!1,iconClass:this.iconClassPrefix+" "+this.iconClassPrefix+("ltr"==a?"ParaLeftToRight":"ParaRightToLeft"),onClick:n.hitch(this,"_changeState",[a])},this.params||{}))},setToolbar:function(a){this.shortcutonly||(this.editor.isLeftToRight()?
(a.addChild(this.buttonLtr),a.addChild(this.buttonRtl)):(a.addChild(this.buttonRtl),a.addChild(this.buttonLtr)))},updateState:function(){if(this.editor&&this.editor.isLoaded&&!this.shortcutonly&&(this.buttonLtr.set("disabled",!!this.disabled),this.buttonRtl.set("disabled",!!this.disabled),!this.disabled)){var a=t.getSelection(this.editor.window);if(a&&0!=a.rangeCount){var b=a.getRangeAt(0);if(b.startContainer!==this.editor.editNode||b.startContainer.hasChildNodes()){a=b.startContainer;b=b.startOffset;
if(this._isBlockElement(a))for(;a.hasChildNodes();)b==a.childNodes.length&&b--,a=a.childNodes[b],b=0;a=this._getBlockAncestor(a)}else a=b.startContainer;a=g.get(a,"direction");this.buttonLtr.set("checked","ltr"==a);this.buttonRtl.set("checked","rtl"==a)}}},setEditor:function(a){this.editor=a;"P"!=this.blockMode&&"DIV"!=this.blockMode&&(this.blockMode="DIV");this._initButton();this.editor.contentPreFilters.push(this._preFilterNewLines);a=n.hitch(this,function(b){if(this.disabled||!b.hasChildNodes())return b;
this._changeStateOfBlocks(this.editor.editNode,this.editor.editNode,this.editor.editNode,"explicitdir",null);return this.editor.editNode});this.editor.contentDomPostFilters.push(a);this.editor._justifyleftImpl=n.hitch(this,function(){this._changeState("left");return!0});this.editor._justifyrightImpl=n.hitch(this,function(){this._changeState("right");return!0});this.editor._justifycenterImpl=n.hitch(this,function(){this._changeState("center");return!0});this.editor._insertorderedlistImpl=n.hitch(this,
"_insertLists","insertorderedlist");this.editor._insertunorderedlistImpl=n.hitch(this,"_insertLists","insertunorderedlist");this.editor._indentImpl=n.hitch(this,"_indentAndOutdent","indent");this.editor._outdentImpl=n.hitch(this,"_indentAndOutdent","outdent");this.editor._formatblockImpl=n.hitch(this,"_formatBlocks");this.editor.onLoadDeferred.addCallback(n.hitch(this,function(){var b=this.editor._plugins,c,a,d=b.length;c=n.hitch(this,"_changeState","mirror");a=n.hitch(this,"_changeState","ltr");
var e=n.hitch(this,"_changeState","rtl");this.editor.addKeyHandler("9",1,0,c);this.editor.addKeyHandler("8",1,0,a);this.editor.addKeyHandler("0",1,0,e);for(c=0;c<b.length;c++)if(a=b[c])a.constructor===y?(a.destroy(),a=null,d=c):a.constructor===E?(this.editor._normalizeIndentOutdent=!0,this.editor._indentImpl=n.hitch(this,"_indentAndOutdent","indent"),this.editor._outdentImpl=n.hitch(this,"_indentAndOutdent","outdent")):a.constructor===D&&"formatBlock"===a.command&&this.own(w.before(a.button,"_execCommand",
n.hitch(this,"_handleNoFormat")));this.editor.addPlugin({ctor:y,blockNodeForEnter:this.blockMode,blockNodes:/^(?:P|H1|H2|H3|H4|H5|H6|LI|DIV)$/},d);a=this.editor._plugins[d];this.own(w.after(a,"handleEnterKey",n.hitch(this,"_checkNewLine"),!0))}));this.own(w.after(this.editor,"onNormalizedDisplayChanged",n.hitch(this,"updateState"),!0))},_checkNewLine:function(){var a=t.getSelection(this.editor.window).getRangeAt(0),a=t.getBlockAncestor(a.startContainer,null,this.editor.editNode).blockNode;a.innerHTML===
this.bogusHtmlContent&&a.previousSibling?a.style.cssText=a.previousSibling.style.cssText:a.innerHTML!==this.bogusHtmlContent&&a.previousSibling&&a.previousSibling.innerHTML===this.bogusHtmlContent&&(a.previousSibling.style.cssText=a.style.cssText)},_handleNoFormat:function(a,b,c){return"noFormat"===c?[a,b,"DIV"]:arguments},_execNativeCmd:function(a,b,c){if(this._isSimpleInfo(c))return a=this.editor.document.execCommand(a,!1,b),p("webkit")&&r("table",this.editor.editNode).prev().forEach(function(b,
c,a){this._hasTag(b,"BR")&&b.parentNode.removeChild(b)},this),a;var k=t.getSelection(this.editor.window);if(!k||0==k.rangeCount)return!1;for(var d=k.getRangeAt(0),e=d.cloneRange(),h=d.startContainer,f=d.startOffset,g=d.endContainer,d=d.endOffset,l=0;l<c.groups.length;l++){var m=c.groups[l],n=m[m.length-1].childNodes.length;e.setStart(m[0],0);e.setEnd(m[m.length-1],n);k.removeAllRanges();k.addRange(e);n=this.editor.selection.getParentOfType(m[0],["TABLE"]);m=this.editor.document.execCommand(a,!1,b);
p("webkit")&&(n&&this._hasTag(n.previousSibling,"BR")&&n.parentNode.removeChild(n.previousSibling),this.editor.focus(),k=t.getSelection(this.editor.window),n=k.getRangeAt(0),0==l?(h=n.endContainer,f=n.endOffset):l==c.groups.length-1&&(g=n.endContainer,d=n.endOffset));if(!m)break;p("webkit")&&this._changeState(a)}k.removeAllRanges();try{e.setStart(h,f),e.setEnd(g,d),k.addRange(e)}catch(K){}return!0},_insertLists:function(a){var b=this._changeState("preparelists",a);if(!this._execNativeCmd(a,null,b))return!1;
p("webkit")&&!this._isSimpleInfo(b)||this._changeState(a);this._cleanLists();this._mergeLists();return!0},_indentAndOutdent:function(a){if(this.editor._normalizeIndentOutdent)return this._changeState("normalize"+a),!0;var b=this._changeState("prepare"+a),c;try{c=this.editor.document.queryCommandValue("styleWithCSS")}catch(k){c=!1}this.editor.document.execCommand("styleWithCSS",!1,!0);b=this._execNativeCmd(a,null,b);this.editor.document.execCommand("styleWithCSS",!1,c);if(!b)return!1;this._changeState(a);
this._mergeLists();return!0},_formatBlocks:function(a){var b;b=this._changeState("prepareformat",a);p("ie")&&a&&"\x3c"!=a.charAt(0)&&(a="\x3c"+a+"\x3e");if(!this._execNativeCmd("formatblock",a,b))return!1;p("webkit")&&!this._isSimpleInfo(b)||this._changeState("formatblock",a);this._mergeLists();return!0},_changeState:function(a,b){if(this.editor.window){this.editor.focus();var c=t.getSelection(this.editor.window);if(c&&0!=c.rangeCount){var k=c.getRangeAt(0),d=k.cloneRange(),e,h,f;e=k.startContainer;
c=k.startOffset;h=k.endContainer;f=k.endOffset;k=e===h&&c==f;if(this._isBlockElement(e)||this._hasTagFrom(e,this._tableContainers))for(;e.hasChildNodes();)c==e.childNodes.length&&c--,e=e.childNodes[c],c=0;d.setStart(e,c);e=this._getClosestBlock(e,"start",d);(c=t.getBlockAncestor(e,/li/i,this.editor.editNode).blockNode)&&c!==e&&(e=c);h=d.endContainer;f=d.endOffset;if(this._isBlockElement(h)||this._hasTagFrom(h,this._tableContainers))for(;h.hasChildNodes();)f==h.childNodes.length&&f--,h=h.childNodes[f],
f=h.hasChildNodes()?h.childNodes.length:3==h.nodeType&&h.nodeValue?h.nodeValue.length:0;d.setEnd(h,f);h=this._getClosestBlock(h,"end",d);(c=t.getBlockAncestor(h,/li/i,this.editor.editNode).blockNode)&&c!==h&&(h=c);c=t.getSelection(this.editor.window,!0);c.removeAllRanges();c.addRange(d);c=t.getCommonAncestor(e,h);a=this._changeStateOfBlocks(e,h,c,a,b,d);k&&(h=d.startContainer,f=d.startOffset,d.setEnd(h,f),c=t.getSelection(this.editor.window,!0),c.removeAllRanges(),c.addRange(d));return a}}},_isBlockElement:function(a){if(!a||
1!=a.nodeType)return!1;a=g.get(a,"display");return"block"==a||"list-item"==a||"table-cell"==a},_isInlineOrTextElement:function(a){return!this._isBlockElement(a)&&(1==a.nodeType||3==a.nodeType||8==a.nodeType)},_isElement:function(a){return a&&(1==a.nodeType||3==a.nodeType)},_isBlockWithText:function(a){return a!==this.editor.editNode&&this._hasTagFrom(a,this._lineTextArray)},_getBlockAncestor:function(a){for(;a.parentNode&&!this._isBlockElement(a);)a=a.parentNode;return a},_getClosestBlock:function(a,
b,c){if(this._isBlockElement(a))return a;var k=a.parentNode,d,e,h=!1;for(removeOffset=!1;;){for(var f=a,h=!1;this._isInlineOrTextElement(f)&&(d=f,e||(e=f)),f=f.previousSibling,f;)if(this._isBlockElement(f)||this._hasTagFrom(f,this._blockContainers)||this._hasTag(f,"BR")){h=!0;break}else if(3==f.nodeType&&3==f.nextSibling.nodeType&&(f.nextSibling.nodeValue=f.nodeValue+f.nextSibling.nodeValue,"start"==b&&f===c.startContainer?c.setStart(f.nextSibling,0):"end"!=b||f!==c.endContainer&&f.nextSibling!==
c.endContainer||c.setEnd(f.nextSibling,f.nextSibling.nodeValue.length),f=f.nextSibling,f.parentNode.removeChild(f.previousSibling),!f.previousSibling))break;for(f=a;this._isInlineOrTextElement(f)&&(d||(d=f),e=f),f=f.nextSibling,f;)if(this._isBlockElement(f)||this._hasTagFrom(f,this._blockContainers)){h=!0;break}else if(this._hasTag(f,"BR")&&f.nextSibling&&!this._isBlockElement(f.nextSibling)&&!this._hasTagFrom(f.nextSibling,this._blockContainers)){e=f;h=!0;break}else if(3==f.nodeType&&3==f.previousSibling.nodeType&&
(f.previousSibling.nodeValue+=f.nodeValue,"start"==b&&f===c.startContainer?c.setStart(f.previousSibling,0):"end"!=b||f!==c.endContainer&&f.previousSibling!==c.endContainer||c.setEnd(f.previousSibling,f.previousSibling.nodeValue.length),f=f.previousSibling,f.parentNode.removeChild(f.nextSibling),!f.nextSibling))break;if(h||this._isBlockElement(k)&&!this._isBlockWithText(k)&&d){a=c?c.startOffset:0;var h=c?c.endOffset:0,f=c?c.startContainer:null,g=c?c.endContainer:null,k=this._repackInlineElements(d,
e,k);b=k["start"==b?0:k.length-1];c&&b&&d===f&&this._hasTag(d,"BR")&&(f=b,a=0,e===d&&(g=f,h=0));c&&(c.setStart(f,a),c.setEnd(g,h));return b}if(this._isBlockElement(k))return k;a=k;removeOffset=!0;k=k.parentNode;d=e=null}},_changeStateOfBlocks:function(a,b,c,k,d,e){var h=[];if(a===this.editor.editNode){if(!a.hasChildNodes())return;this._isInlineOrTextElement(a.firstChild)&&this._rebuildBlock(a);a=this._getClosestBlock(a.firstChild,"start",null)}if(b===this.editor.editNode){if(!b.hasChildNodes())return;
this._isInlineOrTextElement(b.lastChild)&&this._rebuildBlock(b);b=this._getClosestBlock(b.lastChild,"end",null)}var f=e?e.startOffset:0,g=e?e.endOffset:0,l=e?e.startContainer:null,m=e?e.endContainer:null;a=this._collectNodes(a,b,c,e,h,l,f,m,g,k);h={nodes:h,groups:a.groups,cells:a.cells};k=k.toString();switch(k){case "mirror":case "ltr":case "rtl":case "left":case "right":case "center":case "explicitdir":this._execDirAndAlignment(h,k,d);break;case "preparelists":this._prepareLists(h,d);break;case "insertorderedlist":case "insertunorderedlist":this._execInsertLists(h);
break;case "prepareoutdent":this._prepareOutdent(h);break;case "prepareindent":this._prepareIndent(h);break;case "indent":this._execIndent(h);break;case "outdent":this._execOutdent(h);break;case "normalizeindent":this._execNormalizedIndent(h);break;case "normalizeoutdent":this._execNormalizedOutdent(h);break;case "prepareformat":this._prepareFormat(h,d);break;case "formatblock":this._execFormatBlocks(h,d);break;default:console.error("Command "+k+" isn't handled")}e&&(e.setStart(l,f),e.setEnd(m,g),
sel=t.getSelection(this.editor.window,!0),sel.removeAllRanges(),sel.addRange(e),this.editor.onDisplayChanged());return h},_collectNodes:function(a,b,c,k,d,e,h,f,g,l){k=a.parentNode;f=[];var m,v=[],u=[],r=[],q=this.editor.editNode;e=n.hitch(this,function(b){d.push(b);var c=this.editor.selection.getParentOfType(b,["TD"]);if(q!==c||p("webkit")&&("prepareformat"===l||"preparelists"===l))u.length&&v.push(u),u=[],q!=c&&(q=c)&&r.push(q);u.push(b)});for(this._rebuildBlock(k);;){if(this._hasTagFrom(a,this._tableContainers)){if(a.firstChild){k=
a;a=a.firstChild;continue}}else if(this._isBlockElement(a)){if((h=t.getBlockAncestor(a,/li/i,this.editor.editNode).blockNode)&&h!==a){a=h;k=a.parentNode;continue}if(!this._hasTag(a,"LI")&&a.firstChild&&(this._rebuildBlock(a),this._isBlockElement(a.firstChild)||this._hasTagFrom(a.firstChild,this._tableContainers))){k=a;a=a.firstChild;continue}this._hasTagFrom(a,this._lineTextArray)&&e(a)}else if(this._isInlineOrTextElement(a)&&!this._hasTagFrom(a.parentNode,this._tableContainers)){for(f=a;a;){h=a.nextSibling;
if(this._isInlineOrTextElement(a)){if(m=a,this._hasTag(a,"BR")&&(!this._isBlockElement(k)||a!==k.lastChild)){f=this._repackInlineElements(f,m,k);a=f[f.length-1];for(g=0;g<f.length;g++)e(f[g]);f=m=null;h&&this._isInlineOrTextElement(h)&&(f=h)}}else if(this._isBlockElement(a))break;a=h}if(!f)continue;f=this._repackInlineElements(f,m,k);a=f[f.length-1];for(g=0;g<f.length;g++)e(f[g])}if(a===b)break;if(a.nextSibling)a=a.nextSibling;else if(k!==c){for(;!k.nextSibling&&(a=k,k=a.parentNode,k!==c););if(k!==
c&&k.nextSibling)a=k.nextSibling,k=k.parentNode;else break}else break}u.length&&(p("webkit")||q?v.push(u):v.unshift(u));return{groups:v,cells:r}},_execDirAndAlignment:function(a,b,c){switch(b){case "mirror":case "ltr":case "rtl":q.forEach(a.nodes,function(c){var a=g.getComputedStyle(c),k=a.direction,h="mirror"!=b?b:"ltr"==k?"rtl":"ltr",f=a.textAlign,m=isNaN(parseInt(a.marginLeft))?0:parseInt(a.marginLeft),a=isNaN(parseInt(a.marginRight))?0:parseInt(a.marginRight);l.remove(c,"dir");l.remove(c,"align");
g.set(c,{direction:h,textAlign:""});if(!this._hasTag(c,"CENTER"))if(0<=f.indexOf("center")&&g.set(c,"textAlign","center"),this._hasTag(c,"LI")){this._refineLIMargins(c);var m="rtl"===k?a:m,a=0,n=c.parentNode;if(k!=g.get(n,"direction")){for(;n!==this.editor.editNode;)this._hasTagFrom(n,["OL","UL"])&&a++,n=n.parentNode;m-=this._getMargins(a)}k="rtl"==h?"marginRight":"marginLeft";a=g.get(c,k);a=isNaN(a)?0:parseInt(a);g.set(c,k,""+(a+m)+"px");p("webkit")?0>f.indexOf("center")&&g.set(c,"textAlign","rtl"==
h?"right":"left"):c.firstChild&&c.firstChild.tagName&&this._hasTagFrom(c.firstChild,this._lineStyledTextArray)&&(a=g.getComputedStyle(c),h=this._refineAlignment(a.direction,a.textAlign),g.set(c.firstChild,{textAlign:h}))}else"rtl"==h&&0!=m?g.set(c,{marginLeft:"",marginRight:""+m+"px"}):"ltr"==h&&0!=a&&g.set(c,{marginRight:"",marginLeft:""+a+"px"})},this);r("table",this.editor.editNode).forEach(function(c,d,e){d=b;"mirror"===b&&(d="ltr"===g.get(c,"direction")?"rtl":"ltr");e=r("td",c);for(var k=!1,
f=!1,l=0;l<a.cells.length;l++)if(!k&&e[0]===a.cells[l])k=!0;else if(e[e.length-1]===a.cells[l]){f=!0;break}if(k&&f)for(g.set(c,"direction",d),l=0;l<e.length;l++)g.set(e[l],"direction",d)},this);break;case "left":case "right":case "center":q.forEach(a.nodes,function(c){if(!this._hasTag(c,"CENTER")&&(l.remove(c,"align"),g.set(c,"textAlign",b),this._hasTag(c,"LI")&&c.firstChild&&c.firstChild.tagName&&this._hasTagFrom(c.firstChild,this._lineStyledTextArray))){var a=g.getComputedStyle(c),a=this._refineAlignment(a.direction,
a.textAlign);g.set(c.firstChild,"textAlign",a)}},this);break;case "explicitdir":q.forEach(a.nodes,function(b){var c=g.getComputedStyle(b).direction;l.remove(b,"dir");g.set(b,{direction:c})},this)}},_prepareLists:function(a,b){q.forEach(a.nodes,function(c,a,d){(a=this._getParentFrom(c,["TD"]))&&0==r("div[tempRole]",a).length&&m.create("div",{innerHTML:"\x3cspan tempRole\x3d'true'\x3e"+this.bogusHtmlContent+"\x3c/span",tempRole:"true"},a);a=this._tag(c);var k;if(p("webkit")&&this._hasTagFrom(c,this._lineStyledTextArray)||
this._hasTag(c,"LI")&&this._hasStyledTextLineTag(c.firstChild)){k=this._hasTag(c,"LI")?this._tag(c.firstChild):a;if(this._hasTag(c,"LI")){for(;c.firstChild.lastChild;)m.place(c.firstChild.lastChild,c.firstChild,"after");c.removeChild(c.firstChild)}k=m.create("span",{innerHTML:this.bogusHtmlContent,bogusFormat:k},c,"first")}if(p("webkit")||"DIV"==a||"P"==a||"LI"==a)if(p("webkit")&&this._isListTypeChanged(c,b)&&c===c.parentNode.lastChild&&m.create("li",{tempRole:"true"},c,"after"),!("LI"==a&&c.firstChild&&
c.firstChild.tagName&&this._hasTagFrom(c.firstChild,this._lineStyledTextArray))){var h=g.getComputedStyle(c);d=h.direction;var h=h.textAlign,h=this._refineAlignment(d,h),f=this._getLIIndent(c),f=0==f?"":""+f+"px";p("webkit")&&"LI"==a&&g.set(c,"textAlign","");c=k?c.firstChild:m.create("span",{innerHTML:this.bogusHtmlContent},c,"first");l.set(c,"bogusDir",d);""!=h&&l.set(c,"bogusAlign",h);f&&l.set(c,"bogusMargin",f)}},this);p("webkit")&&r("table",this.editor.editNode).forEach(function(b,a,d){(a=b.nextSibling)&&
this._hasTagFrom(a,["UL","OL"])&&m.create("UL",{tempRole:"true"},b,"after")},this)},_execInsertLists:function(a){q.forEach(a.nodes,function(b,c){if(this._hasTag(b,"LI")){if(b.firstChild&&b.firstChild.tagName&&this._hasTagFrom(b.firstChild,this._lineStyledTextArray)){var a=g.getComputedStyle(b.firstChild),d=this._refineAlignment(a.direction,a.textAlign);g.set(b,{direction:a.direction,textAlign:d});c=this._getIntStyleValue(b,"marginLeft")+this._getIntStyleValue(b.firstChild,"marginLeft");var e=this._getIntStyleValue(b,
"marginRight")+this._getIntStyleValue(b.firstChild,"marginRight");g.set(b,{marginLeft:c?""+c+"px":"",marginRight:e?""+e+"px":""});g.set(b.firstChild,{direction:"",textAlign:""})}for(;1<b.childNodes.length&&3==b.lastChild.nodeType&&b.lastChild.previousSibling&&3==b.lastChild.previousSibling.nodeType&&""==n.trim(b.lastChild.nodeValue);)b.removeChild(b.lastChild);if(p("safari")&&this._hasTag(b.firstChild,"SPAN")&&B.contains(b.firstChild,"Apple-style-span")&&(c=b.firstChild,this._hasTag(c.firstChild,
"SPAN")&&l.has(c.firstChild,"bogusFormat"))){for(;c.lastChild;)m.place(c.lastChild,c,"after");b.removeChild(c)}}else if(this._hasTag(b,"DIV")&&0==b.childNodes.length){b.parentNode.removeChild(b);return}if(p("ie")){if(this._hasTag(b,"P")&&"DIV"==this.blockMode.toUpperCase()){if(this._hasTag(b.firstChild,"SPAN")&&l.has(b.firstChild,"bogusIEFormat")){"PRE"===l.get(b.firstChild,"bogusIEFormat").toUpperCase()?(c=m.create("pre",{innerHTML:b.innerHTML},b,"before"),c.style.cssText=b.style.cssText,c.removeChild(c.firstChild),
b.parentNode.removeChild(b)):b.removeChild(b.firstChild);return}c=m.create("div");c.style.cssText=b.style.cssText;for(b.parentNode.insertBefore(c,b);b.firstChild;)c.appendChild(b.firstChild);b.parentNode.removeChild(b)}if(!this._hasTag(b,"LI"))return;this._refineLIMargins(b);c=b.firstChild;if(!this._hasTag(c,"DIV")||c!==b.lastChild)return;var a=g.getComputedStyle(c),h=a.direction,d=a.textAlign;g.getComputedStyle(b);g.set(b,"direction",h);d=this._refineAlignment(h,d);for(g.set(b,"textAlign",d);c.firstChild;)b.insertBefore(c.firstChild,
c);b.removeChild(c)}else if(!this._hasTag(b.firstChild,"SPAN")){this._hasTag(b,"LI")&&(this._refineLIMargins(b),this._hasStyledTextLineTag(b.firstChild)&&this._recountLIMargins(b));return}var f=!1,v=c=!1,e=0;l.has(b.firstChild,"bogusDir")&&(f=!0,h=l.get(b.firstChild,"bogusDir"),g.set(b,"direction",h));if(l.has(b.firstChild,"bogusAlign")&&(v=f=!0,d=l.get(b.firstChild,"bogusAlign"),g.set(b,"textAlign",d),a=b.firstChild.nextSibling,this._hasTag(a,"SPAN")&&g.get(a,"textAlign")===d&&(g.set(a,"textAlign",
""),""==a.style.cssText))){for(;a.lastChild;)m.place(a.lastChild,a,"after");b.removeChild(a)}l.has(b.firstChild,"bogusMargin")&&(c=f=!0,e=parseInt(l.get(b.firstChild,"bogusMargin")),this._hasTag(b,"LI")||(a="rtl"===g.get(b,"direction")?"marginRight":"marginLeft",d=this._getIntStyleValue(b,a)+e,g.set(b,a,0==d?"":""+d+"px")));if(l.has(b.firstChild,"bogusFormat")){f=!1;l.remove(b.firstChild,"bogusDir");if(b.firstChild.nextSibling&&this._hasTag(b.firstChild.nextSibling,"SPAN")){for(var d=b.firstChild.style.cssText.trim().split(";"),
h=b.firstChild.nextSibling.style.cssText.trim().split(";"),u=0;u<d.length;u++)if(d[u])for(a=0;a<h.length;a++)if(d[u].trim()==h[a].trim()){a=d[u].trim().split(":")[0];g.set(b.firstChild.nextSibling,a,"");break}if(""===b.firstChild.nextSibling.style.cssText){for(;b.firstChild.nextSibling.firstChild;)m.place(b.firstChild.nextSibling.firstChild,b.firstChild.nextSibling,"after");b.removeChild(b.firstChild.nextSibling)}}a=l.get(b.firstChild,"bogusFormat");for(d=m.create(a,null,b.firstChild,"after");d.nextSibling;)m.place(d.nextSibling,
d,"last");b.removeChild(b.firstChild);p("webkit")&&this._hasTag(b,"LI")&&(h=b.parentNode.parentNode,this._hasTag(h,a)&&l.set(h,"tempRole","true"));1!=b.childNodes.length||this._hasTag(b,"TD")||this._hasTag(b,"LI")||(d.style.cssText=b.style.cssText,m.place(d,b,"after"),l.set(b,"tempRole","true"))}f&&b.removeChild(b.firstChild);this._hasTag(b,"LI")&&(p("webkit")&&!v&&"center"!=g.get(b,"textAlign")&&g.set(b,"textAlign","rtl"==g.get(b,"direction")?"right":"left"),p("safari")&&this._hasTag(b,"DIV")&&(b.innerHTML=
b.nextSibling.innerHTML,b.parentNode.removeChild(b.nextSibling)),f=b.parentNode.parentNode,f!==this.editor.editNode&&this._hasTag(f,"DIV")&&1==f.childNodes.length&&(f.parentNode.insertBefore(b.parentNode,f),f.parentNode.removeChild(f)),this._refineLIMargins(b),c&&this._recountLIMargins(b,e))},this);r("*[tempRole]",this.editor.editNode).forEach(function(b,a,k){if(this._hasTag(b,"SPAN")){if(l.get(b.parentNode,"tempRole"))return;if(this._hasTag(b.parentNode,"LI")){b.parentNode.parentNode.removeChild(b.parentNode);
return}}b.parentNode.removeChild(b)},this)},_execNormalizedIndent:function(a){q.forEach(a.nodes,function(b){var a="rtl"===g.get(b,"direction")?"marginRight":"marginLeft",k=g.get(b,a),k=isNaN(k)?0:parseInt(k);g.set(b,a,""+(k+this._indentBy)+"px")},this)},_execNormalizedOutdent:function(a){q.forEach(a.nodes,function(b){var a="rtl"===g.get(b,"direction")?"marginRight":"marginLeft",k=g.get(b,a),k=isNaN(k)?0:parseInt(k),d=0;if("LI"===b.tagName.toUpperCase()){var e=0,h=b.parentNode;if(g.get(b,"direction")!=
g.get(h,"direction")){for(;h!==this.editor.editNode;)this._hasTagFrom(h,["OL","UL"])&&e++,h=h.parentNode;d=this._getMargins(e)}}k>=this._indentBy+d&&g.set(b,a,k==this._indentBy?"":""+(k-this._indentBy)+"px")},this)},_prepareIndent:function(a){q.forEach(a.nodes,function(b){var a=this._getParentFrom(b,["TD"]);a&&0==r("div[tempRole]",a).length&&m.create("div",{innerHTML:this.bogusHtmlContent,tempRole:"true"},a);this._hasTag(b,"LI")&&(a=this._getLIIndent(b),l.set(b,"tempIndent",a));if(p("webkit")&&this._hasTag(b,
"LI")&&this._hasStyledTextLineTag(b.firstChild)){for(a=this._tag(b.firstChild);b.firstChild.lastChild;)m.place(b.firstChild.lastChild,b.firstChild,"after");b.removeChild(b.firstChild);m.create("span",{innerHTML:this.bogusHtmlContent,bogusFormat:a},b,"first")}},this)},_prepareOutdent:function(a){q.forEach(a.nodes,function(a){var b=this._getParentFrom(a,["TD"]);b&&0==r("div[tempRole]",b).length&&m.create("div",{innerHTML:this.bogusHtmlContent,tempRole:"true"},b);b=this._tag(a);if("LI"===b){var k=null;
if(p("webkit")&&this._hasTag(a,"LI")&&this._hasStyledTextLineTag(a.firstChild)){for(var b=this._tag(a.firstChild),d=a.firstChild;d.lastChild;)m.place(d.lastChild,d,"after");a.removeChild(a.firstChild);k=m.create("span",{innerHTML:this.bogusHtmlContent,bogusFormat:b},a,"first")}if(a.firstChild&&a.firstChild.tagName&&this._hasTagFrom(a.firstChild,this._lineStyledTextArray))a.firstChild.style.cssText=a.style.cssText,b="rtl"===g.get(a,"direction")?"marginRight":"marginLeft",d=this._getLIIndent(a),0<d&&
g.set(a.firstChild,b,""+d+"px");else{var e=g.getComputedStyle(a),d=e.direction,e=e.textAlign,e=this._refineAlignment(d,e);p("webkit")&&"LI"==b&&g.set(a,"textAlign","");b=k?a.firstChild:m.create("span",{innerHTML:this.bogusHtmlContent},a,"first");l.set(b,"bogusDir",d);""!=e&&l.set(b,"bogusAlign",e);d=this._getLIIndent(a);l.set(b,"bogusIndent",d);if(p("ie")&&"LI"==a.tagName.toUpperCase()&&(g.set(a,"marginLeft",""),g.set(a,"marginRight",""),1==this._getLILevel(a)&&(a.firstChild&&this._hasTagFrom(a.firstChild,
["P","PRE"])&&m.create("span",{bogusIEFormat:this._tag(a.firstChild)},a.firstChild,"first"),this._hasTag(a.firstChild,"PRE")))){for(b=m.create("p",null,a.firstChild,"after");a.firstChild.firstChild;)m.place(a.firstChild.firstChild,b,"last");b.style.cssText=a.style.cssText;a.removeChild(a.firstChild)}}}},this)},_execIndent:function(a){q.forEach(a.nodes,function(a){if(this._hasTag(a,"LI")){var b=0;l.has(a,"tempIndent")&&(b=parseInt(l.get(a,"tempIndent")),l.remove(a,"tempIndent"));this._refineLIMargins(a);
this._recountLIMargins(a,b)}if(l.has(a.firstChild,"bogusFormat")){b=l.get(a.firstChild,"bogusFormat");for(b=m.create(b,null,a.firstChild,"after");b.nextSibling;)m.place(b.nextSibling,b,"last");a.removeChild(a.firstChild)}if(p("ie")||p("webkit"))for(a=a.parentNode;a!==this.editor.editNode;){a=t.getBlockAncestor(a,/blockquote/i,this.editor.editNode).blockNode;if(!a)break;l.has(a,"dir")&&l.remove(a,"dir");g.set(a,"marginLeft","");g.set(a,"marginRight","");g.set(a,"margin","");a=a.parentNode}},this);
r("div[tempRole]",this.editor.editNode).forEach(function(a,c,k){a.parentNode.removeChild(a)});r("ul,ol",this.editor.editNode).forEach(function(a,c,k){g.set(a,"marginLeft","");g.set(a,"marginRight","")})},_execOutdent:function(a){q.forEach(a.nodes,function(a){if(this._hasTag(a.firstChild,"SPAN")){var c=!1,b=!1,d=0;if(l.has(a.firstChild,"bogusDir")){var c=!0,e=l.get(a.firstChild,"bogusDir");g.set(a,"direction",e)}l.has(a.firstChild,"bogusAlign")&&(c=!0,e=l.get(a.firstChild,"bogusAlign"),g.set(a,"textAlign",
e));if(l.has(a.firstChild,"bogusIndent")&&(c=!0,d=parseInt(l.get(a.firstChild,"bogusIndent")),!this._hasTag(a,"LI"))){var e="rtl"===g.get(a,"direction")?"marginRight":"marginLeft",h=""+(this._getIntStyleValue(a,e)+d)+"px";g.set(a,e,h)}if(l.has(a.firstChild,"bogusFormat")){c=!0;e=l.get(a.firstChild,"bogusFormat");for(e=m.create(e,null,a.firstChild,"after");e.nextSibling;)m.place(e.nextSibling,e,"last");this._hasTag(a,"LI")||(e.style.cssText=a.style.cssText,b=!0)}if(c&&(a.removeChild(a.firstChild),
b)){for(;a.lastChild;)m.place(a.lastChild,a,"after");l.set(a,"tempRole","true")}p("webkit")&&this._hasTag(a,"LI")&&"center"!=g.get(a,"textAlign")&&g.set(a,"textAlign","rtl"==g.get(a,"direction")?"right":"left");this._hasTag(a,"LI")&&(c=a.parentNode.parentNode,c!==this.editor.editNode&&this._hasTag(c,"DIV")&&1==c.childNodes.length&&(c.parentNode.insertBefore(a.parentNode,c),c.parentNode.removeChild(c)));if(p("ie")&&this._hasTag(a,"P")&&"DIV"==this.blockMode.toUpperCase()){if(this._hasTag(a.firstChild,
"SPAN")&&l.has(a.firstChild,"bogusIEFormat")){"PRE"===l.get(a.firstChild,"bogusIEFormat").toUpperCase()?(d=m.create("pre",{innerHTML:a.innerHTML},a,"before"),d.style.cssText=a.style.cssText,d.removeChild(d.firstChild),a.parentNode.removeChild(a)):a.removeChild(a.firstChild);return}c=m.create("div");c.style.cssText=a.style.cssText;for(a.parentNode.insertBefore(c,a);a.firstChild;)c.appendChild(a.firstChild);a.parentNode.removeChild(a)}this._hasTag(a,"LI")&&(this._refineLIMargins(a),this._recountLIMargins(a,
d))}else this._hasTag(a,"LI")&&(this._refineLIMargins(a),this._hasStyledTextLineTag(a.firstChild)&&(this._recountLIMargins(a),a.firstChild.style.cssText=""))},this);r("div[tempRole]",this.editor.editNode).forEach(function(a,c,k){a.parentNode.removeChild(a)})},_prepareFormat:function(a,b){q.forEach(a.nodes,function(a){if(this._hasTag(a,"LI")){if(a.firstChild&&!this._isBlockElement(a.firstChild)){var c=a.ownerDocument.createElement(b),d=a.firstChild;for(a.insertBefore(c,a.firstChild);d;)c.appendChild(d),
d=d.nextSibling}c=this._getLIIndent(a);l.set(a,"tempIndent",c)}if(p("webkit")){var e;if(this._hasTag(a,"LI")){if(this._hasStyledTextLineTag(a.firstChild)){for(;a.firstChild.lastChild;)m.place(a.firstChild.lastChild,a.firstChild,"after");a.removeChild(a.firstChild)}e=m.create("span",{innerHTML:this.bogusHtmlContent,bogusFormat:b},a,"first")}d=g.getComputedStyle(a);c=d.direction;d=d.textAlign;d=this._refineAlignment(c,d);a=e?a.firstChild:m.create("span",{innerHTML:this.bogusHtmlContent},a,"first");
l.set(a,"bogusDir",c);""!=d&&l.set(a,"bogusAlign",d)}},this)},_execFormatBlocks:function(a,b){q.forEach(a.nodes,function(a){if(this._hasTagFrom(a,this._lineTextArray)){if(this._hasTag(a.parentNode,"DIV")&&a.parentNode!==this.editor.editNode)for(;a.parentNode.lastChild&&(3==a.parentNode.lastChild.nodeType&&""==n.trim(a.parentNode.lastChild.nodeValue)||this._hasTag(a.parentNode.lastChild,"BR"));)a.parentNode.removeChild(a.parentNode.lastChild);if(this._hasTag(a.parentNode,"DIV")&&a.parentNode!==this.editor.editNode&&
1==a.parentNode.childNodes.length){var c=a.parentNode,d=g.getComputedStyle(c),e=this._refineAlignment(d.direction,d.textAlign);g.set(a,{direction:d.direction,textAlign:e});e="rtl"===d.direction?"marginRight":"marginLeft";d=parseInt(g.get(c,e));0==d||isNan(d)||g.set(a,e,d);c.parentNode.insertBefore(a,c);c.parentNode.removeChild(c)}}if(this._hasTag(a,"LI")){c=0;l.has(a,"tempIndent")&&(c=parseInt(l.get(a,"tempIndent")),l.remove(a,"tempIndent"));this._refineLIMargins(a);for(c&&this._recountLIMargins(a,
c);1<a.childNodes.length&&3==a.lastChild.nodeType&&""==n.trim(a.lastChild.nodeValue);)a.removeChild(a.lastChild);if(this._hasTagFrom(a.firstChild,this._lineStyledTextArray))d=g.getComputedStyle(a),e=this._refineAlignment(d.direction,d.textAlign);else if(this._hasTag(a.firstChild,"DIV")){for(c=a.firstChild;c.firstChild;)a.insertBefore(c.firstChild,c);a.removeChild(c)}if(p("ie")&&!this._hasTag(a.firstChild,"P")&&"\x3cp\x3e"===b){c=m.create("p");for(e=this._hasTagFrom(c.nextSibling,this._lineStyledTextArray)?
c.nextSibling:a;e.firstChild;)m.place(e.firstChild,c,"last");m.place(c,a,"first");e!==a&&a.removeChild(e)}}if(p("webkit")){if(this._hasTag(a,"DIV")){if(l.has(a,"tempRole"))return;if(this._hasTag(a.previousSibling,"LI")){for(;a.firstChild;)m.place(a.firstChild,a.previousSibling,"last");l.set(a,"tempRole",!0);a=a.previousSibling}}c=!1;l.has(a.firstChild,"bogusDir")&&(c=!0,e=l.get(a.firstChild,"bogusDir"),g.set(a,"direction",e));l.has(a.firstChild,"bogusAlign")&&(c=!0,e=l.get(a.firstChild,"bogusAlign"),
g.set(a,"textAlign",e));if(l.has(a.firstChild,"bogusFormat")){var c=!0,h=l.get(a.firstChild,"bogusFormat");if("DIV"!==h.toUpperCase())for(e=m.create(h,null,a.firstChild,"after");e.nextSibling;)m.place(e.nextSibling,e,"last");else e=a;if(p("safari")&&this._hasTag(a.nextSibling,"DIV")){for(;a.nextSibling.firstChild;)m.place(a.nextSibling.firstChild,e,"last");l.set(a.nextSibling,"tempRole","true")}}c&&a.removeChild(a.firstChild);h&&this._hasTag(a,"LI")&&(a=a.parentNode.parentNode,this._hasTag(a,h)&&
l.set(a,"tempRole","true"))}},this);p("webkit")&&r("*[tempRole]",this.editor.editNode).forEach(function(a,b,d){for(;a.lastChild;)m.place(a.lastChild,a,"after");a.parentNode.removeChild(a)},this)},_rebuildBlock:function(a){for(var b=a.firstChild,c,g,d=!1;b;){if(this._isInlineOrTextElement(b)&&!this._hasTagFrom(b,this._tableContainers))d=!this._hasTagFrom(a,this._lineTextArray),c||(c=b),g=b;else if(this._isBlockElement(b)||this._hasTagFrom(b,this._tableContainers))c&&(this._repackInlineElements(c,g,
a),c=null),d=!0;b=b.nextSibling}d&&c&&this._repackInlineElements(c,g,a)},_repackInlineElements:function(a,b,c){var k=[],d=c.ownerDocument.createElement(this.blockMode),e,h=a.previousSibling&&1==a.previousSibling.nodeType?a.previousSibling.style.cssText:c.style.cssText,f=c===this.editor.editNode;k.push(d);a=c.replaceChild(d,a);m.place(a,d,"after");for(f?g.set(d,"direction",g.get(this.editor.editNode,"direction")):d.style.cssText=h;a;){var l=a.nextSibling;this._isInlineOrTextElement(a)&&(this._hasTag(a,
"BR")&&a!==b&&(e=c.ownerDocument.createElement(this.blockMode),k.push(e),a=c.replaceChild(e,a),m.place(a,e,"after"),f?g.set(e,"direction",g.get(this.editor.editNode,"direction")):e.style.cssText=h),!this._hasTag(a,"BR")&&8!=a.nodeType||d.hasChildNodes()||(d.innerHTML=this.bogusHtmlContent),this._hasTag(a,"BR")&&p("ie")?a.parentNode.removeChild(a):8!=a.nodeType?d.appendChild(a):a.parentNode.removeChild(a),3==a.nodeType&&a.previousSibling&&3==a.previousSibling.nodeType&&(a.previousSibling.nodeValue+=
a.nodeValue,a.parentNode.removeChild(a)),e&&(d=e,e=null));if(a===b)break;a=l}return k},_preFilterNewLines:function(a){a=a.split(/(<\/?pre.*>)/i);for(var b=!1,c=0;c<a.length;c++)0>a[c].search(/<\/?pre/i)&&!b?a[c]=a[c].replace(/\n/g,"").replace(/\t+/g,"\u00a0").replace(/^\s+/,"\u00a0").replace(/\xA0\xA0+$/,""):0<=a[c].search(/<\/?pre/i)&&(b=!b);return a.join("")},_refineAlignment:function(a,b){return b=0<=b.indexOf("left")&&"rtl"==a?"left":0<=b.indexOf("right")&&"ltr"==a?"right":0<=b.indexOf("center")?
"center":""},_refineLIMargins:function(a){var b=g.get(a,"direction"),c=g.get(a.parentNode,"direction"),k=0,d=a.parentNode;for(p("webkit")&&(c=g.get(this.editor.editNode,"direction"));d!==this.editor.editNode;)this._hasTagFrom(d,["OL","UL"])&&k++,d=d.parentNode;g.set(a,"marginRight","");g.set(a,"marginLeft","");d="rtl"==b?"marginRight":"marginLeft";k=this._getMargins(k);b!=c&&g.set(a,d,""+k+"px")},_getMargins:function(a){return 0==a?0:45+40*(a-1)},_recountLIMargins:function(a,b){var c=g.get(a,"direction"),
k=g.get(a.parentNode,"direction"),d="rtl"==c?"marginRight":"marginLeft",e=g.get(a,d);b=(isNaN(parseInt(e))?0:parseInt(e))+(b?b:0);a.firstChild&&1==a.firstChild.nodeType&&(e=g.get(a.firstChild,d),b+=isNaN(parseInt(e))?0:parseInt(e),g.set(a.firstChild,{marginLeft:"",marginRight:""}));c!=k&&(b-=this._getMargins(this._getLILevel(a)));if(e=this._getListMargins(a))for(var h=0;h<e/40;h++){var f=m.create(this._tag(a.parentNode),null,a,"before");m.place(a,f,"last")}c!=k&&(b+=this._getMargins(this._getLILevel(a)));
b&&g.set(a,d,""+b+"px")},_getLILevel:function(a){a=a.parentNode;for(var b=0;this._hasTagFrom(a,["UL","OL"]);)b++,a=a.parentNode;return b},_getLIIndent:function(a){var b=a.parentNode,c=g.get(a,"direction"),k=g.get(b,"direction"),b=this._getIntStyleValue(a,"rtl"===c?"marginRight":"marginLeft");a=c===k?0:this._getMargins(this._getLILevel(a));return b-a},_getListMargins:function(a){a=a.parentNode;for(var b,c=0;this._hasTagFrom(a,["UL","OL"]);)b="rtl"==g.get(a,"direction")?"marginRight":"marginLeft",b=
g.get(a,b),c+=isNaN(parseInt(b))?0:parseInt(b),a=a.parentNode;return c},_tag:function(a){return a&&a.tagName&&a.tagName.toUpperCase()},_hasTag:function(a,b){return a&&b&&a.tagName&&a.tagName.toUpperCase()===b.toUpperCase()},_hasStyledTextLineTag:function(a){return this._hasTagFrom(a,this._lineStyledTextArray)},_hasTagFrom:function(a,b){return a&&b&&a.tagName&&0<=q.indexOf(b,a.tagName.toUpperCase())},_getParentFrom:function(a,b){if(!a||!b||!b.length)return null;for(;a!==this.editor.editNode;){if(this._hasTagFrom(a,
b))return a;a=a.parentNode}return null},_isSimpleInfo:function(a){return!a||2>a.groups.length},_isListTypeChanged:function(a,b){if(!this._hasTag(a,"LI"))return!1;a=a.parentNode;return this._hasTag(a,"UL")&&"insertorderedlist"===b||this._hasTag(a,"OL")&&"insertunorderedlist"===b},_getIntStyleValue:function(a,b){a=parseInt(g.get(a,b));return isNaN(a)?0:a},_mergeLists:function(){var a=t.getSelection(this.editor.window),b=a&&0<a.rangeCount;if(b)var c=a.getRangeAt(0).cloneRange(),g=c.startContainer,d=
c.startOffset,e=c.endContainer,h=c.endOffset;var f=!1;r("ul,ol",this.editor.editNode).forEach(function(a,b,c){if(l.has(a,"tempRole"))a.parentNode.removeChild(a);else for(b=a.nextSibling;this._hasTag(b,this._tag(a));){for(;b.firstChild;)m.place(b.firstChild,a,"last"),f=!0;l.set(b,"tempRole","true");b=b.nextSibling}},this);if(b&&f){a.removeAllRanges();try{c.setStart(g,d),c.setEnd(e,h),a.addRange(c)}catch(v){}}},_cleanLists:function(){p("webkit")&&(r("table",this.editor.editNode).forEach(function(a,
b,c){a=a.nextSibling;this._hasTag(a,"UL")&&"true"===l.get(a,"tempRole")&&a.parentNode.removeChild(a)},this),r("li[tempRole]",this.editor.editNode).forEach(function(a,b,c){1==a.parentNode.childNodes.length?a.parentNode.parentNode.removeChild(a.parentNode):a.parentNode.removeChild(a)}));var a=t.getSelection(this.editor.window),b=a&&0<a.rangeCount;if(b)var c=a.getRangeAt(0).cloneRange(),g=c.startContainer,d=c.startOffset,e=c.endContainer,h=c.endOffset;var f=!1;r("span[bogusDir]",this.editor.editNode).forEach(function(a,
b,c){c=b=a.firstChild;if(1==b.nodeType)for(;b;)c=b.nextSibling,m.place(b,a,"after"),f=!0,b=c;a.parentNode.removeChild(a)},this);if(b&&f){a.removeAllRanges();try{c.setStart(g,d),c.setEnd(e,h),a.addRange(c)}catch(v){}}}});x.registry.bidiSupport=x.registry.bidisupport=function(a){return new z({})};return z});