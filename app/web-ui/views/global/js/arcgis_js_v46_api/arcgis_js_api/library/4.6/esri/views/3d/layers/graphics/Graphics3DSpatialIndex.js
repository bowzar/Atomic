// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports dojo/Deferred ../../../../processors/SpatialIndex ../../../../geometry/SpatialReference ../../../../geometry/support/webMercatorUtils".split(" "),function(m,n,k,l,g,h){return function(){function b(){var a=this;this.spatialIndex=new l;this.spatialIndexNumPendingQueries=this.spatialIndexNumGraphics=0;this.graphicsCore=this.viewSR=this.layer=this.layerView=null;this._readyDfd=new k;var c=function(a){return a.workerClient&&a.workerClient.worker};if(c(this.spatialIndex))this._readyDfd.resolve();
else this.spatialIndex.on("start",function(){c(a.spatialIndex)&&a._readyDfd.resolve()})}b.prototype.initialize=function(a,c,d,e){this.layerView=a;this.layer=c;this.viewSR=d;this.graphicsCore=e};b.prototype.destroy=function(){this.spatialIndex&&(this.spatialIndex.destroy(),this.spatialIndex=null);this.graphicsCore=this.layerView=this.viewSR=null};b.prototype.numNodesUpdating=function(){return 0};b.prototype.isUpdating=function(){return 0<this.spatialIndexNumPendingQueries};b.prototype.hasGraphics=
function(){return 0<this.spatialIndexNumGraphics};b.prototype.intersects=function(a,c,d){var e=this;this.hasGraphics()?(this.spatialIndexNumPendingQueries++,this.spatialIndex.intersects(a,void 0,void 0,!0).then(function(a){e.spatialIndexNumPendingQueries--;d(a.results,a.results.length);e.layerView._evaluateUpdatingState()})):d([],0)};b.prototype.shouldAddToSpatialIndex=function(a,c,d){return d||c.needsElevationUpdates()};b.prototype.addGraphicsToSpatialIndex=function(a){if(this.layerView.loadedGraphics)for(var c=
this.layerView.loadedGraphics.toArray(),d=c.length,e=0;e<d;e++){var b=c[e],f=this.graphicsCore.getGraphics3DGraphicById(b.uid);f&&!f.addedToSpatialIndex&&this.shouldAddToSpatialIndex(b,f,a)&&this.addGraphicToSpatialIndex(b,f)}};b.prototype.addGraphicToSpatialIndex=function(a,b){var d=a.geometry.spatialReference,e=this.viewSR,c={id:a.uid,geometry:null};if(d.equals(e))c.geometry=a.geometry.toJSON();else{var f=void 0;if(d.wkid===g.WGS84.wkid&&e.isWebMercator)f=h.geographicToWebMercator(a.geometry);else if(d.isWebMercator&&
e.wkid===g.WGS84.wkid)f=h.webMercatorToGeographic(a.geometry);else return console.warn("Cannot convert graphic geometry to map spatial reference, elevation and scale updates are disabled"),!1;c.geometry=f.toJSON()}this.spatialIndexNumGraphics++;this.spatialIndex.runProcess([c],this.layer.id);return b.addedToSpatialIndex=!0};b.prototype.whenLoaded=function(){return this._readyDfd.promise};return b}()});