// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports dojo/has ../../../../../core/libs/gl-matrix/mat4 ../../../../webgl/FramebufferObject ../Dispatcher ../GeometryUtils ../MaterialManager ../enums ./WGLTextPainter ./WGLIconPainter ./WGLFillPainter ./WGLLinePainter ./WGLBackgroundPainter ./TileInfoRenderer ./WGLHighlightPainter ./WGLHeatmapPainter ../Utils".split(" "),function(K,L,m,l,y,z,A,B,r,C,D,E,F,G,q,H,I,v){var x=new Uint8Array(4*v.C_HITTEST_SEARCH_SIZE*v.C_HITTEST_SEARCH_SIZE),J=new Uint32Array(x.buffer),t=new z;return function(){function d(){this._textPainter=
new C;this._iconPainter=new D;this._fillPainter=new E;this._linePainter=new F;this._backgroundPainter=new G;this._hlPainter=new H;this._heatmapPainter=new I;this._extrudeMatrix=new Float32Array(16);this._extrudeNoRotationMatrix=new Float32Array(16);this._extrudeRotateVector=new Float32Array([0,0,1]);this._extrudeScaleVector=new Float32Array([1,1,1]);this._state={rotation:0,width:0,height:0};this._cachedRotation=this._cachedHeight=this._cachedWidth=0;this._materialManager=new B}d.prototype.initialize=
function(a){this._materialManager.initialize(a)};d.prototype.update=function(a,b){this._state=a;if(this._state.width!==this._cachedWidth||this._state.height!==this._cachedHeight||this._state.rotation!==this._cachedRotation)this._extrudeScaleVector[0]=2/a.width,this._extrudeScaleVector[1]=-2/a.height,l.identity(this._extrudeMatrix),l.rotate(this._extrudeMatrix,this._extrudeMatrix,-a.rotation*A.C_DEG_TO_RAD,this._extrudeRotateVector),l.scale(this._extrudeMatrix,this._extrudeMatrix,this._extrudeScaleVector),
l.transpose(this._extrudeMatrix,this._extrudeMatrix),l.identity(this._extrudeNoRotationMatrix),l.scale(this._extrudeNoRotationMatrix,this._extrudeNoRotationMatrix,this._extrudeScaleVector),l.transpose(this._extrudeNoRotationMatrix,this._extrudeNoRotationMatrix),this._cachedWidth=this._state.width,this._cachedHeight=this._state.height,this._cachedRotation=this._state.rotation};d.prototype.setHighlightOptions=function(a){this._hlPainter.setHighlightOptions(a)};d.prototype.drawHeatmap=function(a,b,n,
f){var k=this;this._heatmapPainter.bindHeatmapSurface(a,b.displayWidth*f,b.displayHeight*f);this._drawClippingRects(a,b.children);a.setBlendingEnabled(!0);a.setStencilWriteMask(0);a.setBlendFunctionSeparate(1,1,1,0);a.setStencilTestEnabled(!0);b.wglRendererInfo.symbolLevels.forEach(function(c){b.children.forEach(function(g){t.replayList(a,g.displayList,c,k,g,b.textureManager,b.wglRendererInfo,r.WGLDrawPhase.GEOMETRY,n,f,!1)})});a.setStencilTestEnabled(!1);this._heatmapPainter.drawHeatmap(a,b.wglRendererInfo,
.75);if(m("esri-feature-tiles-debug")){this._tileInforenderer||(this._tileInforenderer=new q);for(var h=this._tileInforenderer,c=0,e=b.children;c<e.length;c++){var p=e[c];p.attached&&p.visible&&h.render(a,p)}}};d.prototype.draw=function(a,b,n,f,k){var h=this;this._drawClippingRects(a,b.children);a.setBlendingEnabled(!0);a.setStencilWriteMask(0);a.setBlendFunctionSeparate(1,771,1,771);a.setStencilTestEnabled(!0);b.wglRendererInfo.symbolLevels.forEach(function(c){b.children.forEach(function(e){e.displayList&&
!e.displayList.empty&&t.replayList(a,e.displayList,c,h,e,b.textureManager,b.wglRendererInfo,r.WGLDrawPhase.GEOMETRY,n,f,k)})});a.setStencilTestEnabled(!1);if(m("esri-feature-tiles-debug")){this._tileInforenderer||(this._tileInforenderer=new q);for(var c=this._tileInforenderer,e=0,p=b.children;e<p.length;e++){var d=p[e];d.attached&&d.visible&&c.render(a,d)}}};d.prototype.highlight=function(a,b,n,f){var k=this,h=a.getViewport();this._hlPainter.setup(a,h.width,h.height);this._hlPainter.startMaskDraw(a);
this._drawClippingRects(a,b.children);a.setBlendingEnabled(!0);a.setStencilWriteMask(0);a.setBlendFunctionSeparate(1,771,1,771);a.setStencilTestEnabled(!0);b.wglRendererInfo.symbolLevels.forEach(function(c){b.children.forEach(function(e){e.hlDisplayList&&!e.hlDisplayList.empty&&t.replayList(a,e.hlDisplayList,c,k,e,b.textureManager,b.wglRendererInfo,r.WGLDrawPhase.HIGHLIGHT,n,f,!1)})});this._hlPainter.draw(a)};d.prototype.hitTest=function(a,b,n,f,k){var h=this,c=v.C_HITTEST_SEARCH_SIZE,e=[0,0],d=[0,
0];b=a.state;b.toMap(e,[0,0]);b.toMap(d,[c,c]);var l=f.children.filter(function(a){return!(e[0]>a.bounds[2]||d[0]<a.bounds[0]||e[1]<a.bounds[1]||d[1]>a.bounds[3])});if(0===l.length)return[];var g=a.context;this._hittestFBO||(this._hittestFBO=y.create(g,{colorTarget:0,depthStencilTarget:3,width:c,height:c}));b=g.getViewport();n=g.getBoundFramebufferObject();g.bindFramebuffer(this._hittestFBO);g.setViewport(0,0,c,c);var u=g.gl;g.setClearColor(1,1,1,1);g.clear(u.COLOR_BUFFER_BIT);this._drawClippingRects(g,
l);g.setBlendingEnabled(!1);g.setStencilWriteMask(0);g.setStencilTestEnabled(!0);f.wglRendererInfo.symbolLevels.forEach(function(b){l.forEach(function(c){c.displayList&&!c.displayList.empty&&t.replayList(g,c.displayList,b,h,c,f.textureManager,f.wglRendererInfo,r.WGLDrawPhase.HITTEST,k,a.devicePixelRatio,!1)})});g.setStencilTestEnabled(!1);g.setBlendingEnabled(!0);this._hittestFBO.readPixels(0,0,c,c,6408,5121,x);for(var c=c*c,u=new Set,w=0;w<c;w++){var m=J[w];4294967295!==m&&u.add(m)}g.bindFramebuffer(n);
g.setViewport(b.x,b.y,b.width,b.height);var q=[];u.forEach(function(a){q.push(a)});return q};d.prototype.drawFill=function(a,b,d,f,k,h,c,e,l,m,g){this._fillPainter.draw(a,b,d,k,h,c,e,l,m,g,this._materialManager,f)};d.prototype.drawLine=function(a,b,d,f,k,h,c,e,l,m){this._linePainter.draw(a,b,d,k,h,c,e,l,m,this._materialManager,f,this._extrudeMatrix)};d.prototype.drawIcon=function(a,b,d,f,k,h,c,e){this._iconPainter.draw(a,b,d,k,h,c,e,this._materialManager,f,this._extrudeMatrix,this._extrudeNoRotationMatrix)};
d.prototype.drawText=function(a,b,d,f,k,h,c,e){this._textPainter.draw(a,b,d,k,h,c,e,this._materialManager,f,this._extrudeMatrix,this._extrudeNoRotationMatrix)};d.prototype._drawClippingRects=function(a,b){if(0!==b.length){a.setDepthWriteEnabled(!1);a.setDepthTestEnabled(!1);a.setStencilTestEnabled(!0);a.setBlendingEnabled(!1);a.setColorMask(!1,!1,!1,!1);a.setStencilOp(7680,7680,7681);a.setClearStencil(0);a.clear(a.gl.STENCIL_BUFFER_BIT);a.setStencilWriteMask(255);for(var d=b.length,f,k=d,h=0;h<d;h++)f=
b[h],f.stencilRef=k,a.setStencilFunctionSeparate(1032,519,k,255),k--,this._backgroundPainter.draw(a,f);a.setColorMask(!0,!0,!0,!0)}};return d}()});