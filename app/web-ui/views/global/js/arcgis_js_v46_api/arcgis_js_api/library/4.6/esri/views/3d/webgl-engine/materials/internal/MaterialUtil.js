// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../lib/IdGen ../../lib/gl-matrix ../../lib/ComponentUtils ../../lib/Util ../../parts/Model ../../lib/screenSizePerspectiveUtils ../../../../webgl/Util ../../../support/aaBoundingBox".split(" "),function(fa,g,Z,p,L,F,aa,M,ba,C){function A(a,b,c,d,e,f){if(void 0===e||3!==f)for(e=0;e<f;++e)c[d+e]=a[b+e];else{var m=a[b],k=a[b+1];a=a[b+2];c[d]=e[0]*m+e[4]*k+e[8]*a+e[12];c[d+1]=e[1]*m+e[5]*k+e[9]*a+e[13];c[d+2]=e[2]*m+e[6]*k+e[10]*a+e[14]}return f}function N(a,b,c,d,e,f){for(var m=
a.length,k=0;k<m;++k){for(var r=c*a[k],I=0;I<c;++I)d[e+I]=b[r+I];e+=f}}function O(a,b,c,d,e,f){d=new Uint8Array(d.buffer);e*=4;f*=4;var m=a.length;if(4===c)for(c=0;c<m;++c){var k=4*a[c];d[e]=b[k];d[e+1]=b[k+1];d[e+2]=b[k+2];d[e+3]=b[k+3];e+=f}else if(3===c)for(c=0;c<m;++c)k=3*a[c],d[e]=b[k],d[e+1]=b[k+1],d[e+2]=b[k+2],d[e+3]=255,e+=f}function P(a,b,c,d,e){var f=Q(b,c,R);C.setMin(B,a.getBBMin());C.setMax(B,a.getBBMax());if(K(B,b,f,d)){var f=a.getPrimitiveIndices(),m=a.getIndices(),k=a.getPosition(),
r=f?f.length:m.length/3;if(1E4<r&&(a=a.getChildren(),void 0!==a)){for(f=0;8>f;++f)void 0!==a[f]&&P(a[f],b,c,d,e);return}S(b,c,0,r,m,k,f,e)}}function S(a,b,c,d,e,f,m,k){var r=f.data,I=f.offsetIdx;f=f.strideIdx;var l=a[0],n=a[1];a=a[2];var h=b[0]-l,g=b[1]-n;for(b=b[2]-a;c<d;c++){var q=m?m[c]:c,v=I+f*e[3*q],x=I+f*e[3*q+1],t=I+f*e[3*q+2],u=r[v],w=r[v+1],y=r[v+2],v=r[x]-u,A=r[x+1]-w,x=r[x+2]-y,B=r[t]-u,C=r[t+1]-w,t=r[t+2]-y,z=g*t-C*b,G=b*B-t*h,H=h*C-B*g,D=v*z+A*G+x*H,u=l-u,E=n-w,F=a-y,w=E*x-A*F,y=F*v-
x*u,J=u*A-v*E;if(D>T){z=u*z+E*G+F*H;if(0>z||z>D)continue;G=h*w+g*y+b*J;if(0>G||z+G>D)continue}else if(D<-T){z=u*z+E*G+F*H;if(0<z||z<D)continue;G=h*w+g*y+b*J;if(0<G||z+G<D)continue}else continue;D=(B*w+C*y+t*J)/D;0<=D&&(z=ca,p.vec3d.set3(v,A,x,U),p.vec3d.set3(B,C,t,V),v=p.vec3d.normalize(p.vec3d.cross(U,V,z)),k(D,v,q))}}function Q(a,b,c){return p.vec3d.set3(1/(b[0]-a[0]),1/(b[1]-a[1]),1/(b[2]-a[2]),c)}function K(a,b,c,d){var e=(a[0]-d-b[0])*c[0],f=(a[3]+d-b[0])*c[0],m=Math.min(e,f),e=Math.max(e,f),
f=(a[1]-d-b[1])*c[1],k=(a[4]+d-b[1])*c[1],m=Math.max(m,Math.min(f,k)),e=Math.min(e,Math.max(f,k));if(m>e)return!1;f=(a[2]-d-b[2])*c[2];a=(a[5]+d-b[2])*c[2];m=Math.max(m,Math.min(f,a));e=Math.min(e,Math.max(f,a));return m<=e}function H(a,b,c,d){if(void 0!==a)return c.aquire(a,b,d)}function E(a,b){void 0!==a&&b.release(a)}function W(a,b){b=b?W(b):{};for(var c in a){var d=a[c];d&&d.forEach&&(d=da(d));null==d&&c in b||(b[c]=d)}return b}function da(a){var b=[];a.forEach(function(a){return b.push(a)});
return b}Object.defineProperty(g,"__esModule",{value:!0});var X=p.mat4d.create(),B=C.create(),J=F.VertexAttrConstants;g.__Material_idGen=new Z;g.__GLMaterial_id=0;g.IDENTITY=p.mat4d.identity();g.fill=A;g.fillInterleaved=function(a,b,c,d,e,f,m,k){for(var r=ba.getStride(e)/4,g=0;g<e.length;g++){var l=e[g],n=m+l.offset/4,l=l.name,h=a.vertexAttr[l];if(null!=h&&(null==k||null!=k[l]))switch(l){case "uv0":N(a.indices[l],h.data,h.size,f,n,r);break;case "region":for(var l=a.indices[l],p=h.data,q=h.size,h=
f,v=r,h=new Uint16Array(h.buffer),n=2*n,v=2*v,x=l.length,t=0;t<x;++t){for(var u=q*l[t],w=0;w<q;++w)h[n+w]=p[u+w];n+=v}break;case "color":if(d&&d.color)if(l=a.indices[l],p=h.data,q=d.color,t=h.size,h=f,v=r,h=new Uint8Array(h.buffer),n*=4,v*=4,x=l.length,4===t)for(t=0;t<x;++t)u=4*l[t],h[n]=p[u]*q[0],h[n+1]=p[u+1]*q[1],h[n+2]=p[u+2]*q[2],h[n+3]=p[u+3]*q[3],n+=v;else{if(3===t)for(w=255*q[3],t=0;t<x;++t)u=3*l[t],h[n]=p[u]*q[0],h[n+1]=p[u+1]*q[1],h[n+2]=p[u+2]*q[2],h[n+3]=w,n+=v}else O(a.indices[l],h.data,
h.size,f,n,r);break;case "symbolColor":O(a.indices[l],h.data,h.size,f,n,r);break;default:if(q=l===J.POSITION?b:l===J.NORMAL?c:void 0,void 0!==q&&3===h.size)for(l=a.indices[l],p=h.data,h=f,v=r,x=l.length,t=0;t<x;++t){var y=3*l[t],u=p[y],w=p[y+1],y=p[y+2];h[n]=q[0]*u+q[4]*w+q[8]*y+q[12];h[n+1]=q[1]*u+q[5]*w+q[9]*y+q[13];h[n+2]=q[2]*u+q[6]*w+q[10]*y+q[14];n+=v}else N(a.indices[l],h.data,h.size,f,n,r)}}};g.triangleVertexArrayToWireframeLines=function(a,b,c,d){for(c=Math.floor(c/3)-1;0<=c;c--){var e=b+
3*c*d,f=b+6*c*d+5*d;A(a,e,a,f,null,d);f-=d;A(a,e+d,a,f,null,d);f-=d;A(a,e+d,a,f,null,d);f-=d;A(a,e+2*d,a,f,null,d);f-=d;A(a,e+2*d,a,f,null,d);f-=d;A(a,e,a,f,null,d)}};g.intersectTriangleGeometry=function(a,b,c,d,e,f,m){F.assert("triangle"===a.data.primitiveType);b=b.componentVisibilities;d=d.tolerance;var k=a.getBoundingInfo();if(1<a.getComponentCount()){if(c=Q(e,f,R),C.setMin(B,k.getBBMin()),C.setMax(B,k.getBBMax()),K(B,e,c,d))for(var r=a.data,k=a.getComponentCount(),g=r.getIndices(J.POSITION),l=
r.getAttribute(J.POSITION),r=r.componentOffsets,n=0;n<k;n++)if(L.getVisibility(b,n)){var h=a.getComponentAABB(n,B);K(h,e,c,d)&&S(e,f,r[n]/3,r[n+1]/3,g,l,void 0,m)}}else L.getVisibility(b,0)&&P(k,e,f,d,m)};var R=p.vec3d.create(),T=Math.pow(2,-52),ca=p.vec3d.create(),U=p.vec3d.create(),V=p.vec3d.create();g.transformToWorld=function(a,b,c){return p.vec4d.set4(a[0]-b[0],a[1]-b[1],a[2]-b[2],1,c)};g.transformToView=function(a,b,c,d){p.mat4d.translate(c,b,X);c=X;return p.mat4d.multiplyVec4(c,a,d)};g.transformToProjection=
function(a,b,c,d){d[0]=a[0]+c[0];d[1]=a[1]+c[1];d[2]=a[2]+c[2];d[3]=a[3];return p.mat4d.multiplyVec4(b,d)};g.transformToNDC=function(a,b){return p.vec4d.scale(a,1/Math.abs(a[3]),b)};g.applyScreenSizePerspectiveScale=function(a,b,c,d,e){return M.scale(a,d,c,e)};g.verticalOffsetAtDistance=function(a,b,c,d,e){var f=c.screenLength||0;e&&(f=M.scale(f,d,b,e));return F.clamp(f*Math.tan(.5*a.fovY)/(.5*a.fullHeight)*b,c.minWorldLength||0,null!=c.maxWorldLength?c.maxWorldLength:Infinity)};g.basicMaterialConstructor=
function(a,b){var c=!0,d=!1,e=0,f=g.__Material_idGen.gen(b);a.getId=function(){return f};var m;a.getParentStage=function(){return m};a.addParentStage=function(a){F.assert(void 0===m,"Material can only be added to a single Stage");m=a};a.removeParentStage=function(a){m=void 0};a.setVisible=function(b){c!==b&&(c=b,a.notifyDirty("matChanged"))};a.isVisible=function(){return c};a.setRenderOccluded=function(b){d!==b&&(d=b,a.notifyDirty("matChanged"))};a.isRenderOccluded=function(){return d};a.notifyDirty=
function(b){m&&m.notifyDirty(aa.ContentType.MATERIAL,a,b)};a.setRenderPriority=function(a){e=a;this.notifyDirty("matChanged")};a.getRenderPriority=function(){return e}};g.aquireIfNotUndefined=H;g.releaseIfNotUndefined=E;var Y=p.mat4.create();g.bindView=function(a,b,c){p.mat4d.translate(b,a,Y);c.setUniform3fv("localOrigin",a);c.setUniformMatrix4fv("view",Y)};g.bindCamPos=function(a,b,c){c.setUniform3f("camPos",b[3]-a[0],b[7]-a[1],b[11]-a[2])};g.bindVerticalOffset=function(a,b,c){if(a){var d=b.fovY;
b=b.viewport[3];var e=void 0;void 0===e&&(e=ea);e.screenLength=a.screenLength;e.perDistance=Math.tan(.5*d)/(.5*b);e.minWorldLength=a.minWorldLength;e.maxWorldLength=a.maxWorldLength;a=e;c.setUniform4f("verticalOffset",a.screenLength,a.perDistance,a.minWorldLength,a.maxWorldLength)}};g.bindScreenSizePerspective=function(a,b,c){void 0===c&&(c="screenSizePerspectiveAlignment");if(a){var d=a.parameters;b.setUniform4f(c,d.divisor,d.offset,d.minPixelSize,a.paddingPixelsOverride)}};g.basicGLMaterialConstructor=
function(a,b){var c=g.__GLMaterial_id++;a.getId=function(){return c};a.getMaterialId=function(){return b.getId()};a.isVisible=function(){return b.isVisible()};a.isRenderOccluded=function(){return b.isRenderOccluded()};a.getRenderPriority=function(){return b.getRenderPriority()}};g.singleTextureGLMaterialConstructor=function(a,b,c,d){var e=H(c.textureId,c.initTexture,b,d);a.updateTexture=function(a){c.textureId!==a&&(E(c.textureId,b),c.textureId=a,e=H(c.textureId,c.initTexture,b,d))};a.renderTexture=
function(a){(a=b.getTexture(c.textureId))&&a.dirty&&a.redraw&&a.redraw()};a.bindTexture=function(a,b){void 0!==e&&(b.setUniform1i("tex",0),a.bindTexture(e.getGLTexture()))};a.bindTextureSize=function(a,b){void 0!==e&&(a=e.getGLTexture(),b.setUniform2f("texSize",a.descriptor.width,a.descriptor.height))};a.dispose=function(){E(c.textureId,b)}};g.multiTextureGLMaterialConstructor=function(a,b,c,d){for(var e=d.length,f=Array(e),g=0;g<e;g++)f[g]=H(c[d[g][0]],c[d[g][1]],b);a.updateTextures=function(a){for(var g=
0;g<e;g++){var k=c[d[g][0]],l=a[d[g][0]];k!==l&&(E(k,b),c[d[g][0]]=l,f[g]=H(l,c[d[g][1]],b))}};a.bindTextures=function(a,b){for(var c=0;c<e;c++)void 0!==f[c]&&(b.setUniform1i(d[c][2],c),a.bindTexture(f[c].getGLTexture(),c));a.setActiveTexture(0)};a.bindOneTexture=function(a,b,c){b.setUniform1i(d[c][2],c);a.bindTexture(f[c].getGLTexture(),c);a.setActiveTexture(0)};a.disposeTextures=function(){for(var a=0;a<e;a++)E(c[d[a][0]],b)}};g.copyParameters=W;g.updateParameters=function(a,b){var c=!1,d;for(d in b){var e=
b[d];void 0!==e&&(c=!0,Array.isArray(e)?a[d]=e.slice():a[d]=e)}return c};g.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var ea={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0}});