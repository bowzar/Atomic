// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators dojo/_base/lang ../../../Camera ../../../Viewpoint ../../../core/Accessor ../../../core/Logger ../../../core/HandleRegistry ../../../core/watchUtils ../../../core/Error ../../../core/promiseUtils ../../../geometry/Point ../../../geometry/Extent ../../../geometry/ScreenPoint ../../../geometry/support/webMercatorUtils ../../animation/easing ./controllers/PointToPointAnimationController ../support/PropertiesPool ../support/cameraUtils ../support/viewpointUtils ../camera/intersectionUtils ../camera/constraintUtils ./Frustum ./ConstraintsManager ./controllers/SurfaceCollisionCorrectionController ../lib/glMatrix ../webgl-engine/lib/Camera ./helpers/PickingHelper".split(" "),
function(l,v,F,k,h,G,m,r,H,I,J,p,n,z,K,A,L,M,N,B,O,e,t,C,w,P,Q,D,x,R,S){Object.defineProperty(v,"__esModule",{value:!0});var f=I.getLogger("esri.views.3d.state.ViewStateManager");l=function(l){function b(a){a=l.call(this)||this;a.propertiesPool=new O.default({frustum:P.default},a);a.handles=new J;a.cameraSetByUser=!1;a.internalSetOrder=[];a.immediateGoToPromise=null;a.animatedGoToPromise=null;a.ready=!1;return a}F(b,l);Object.defineProperty(b.prototype,"camera",{get:function(){return this.ready?e.internalToExternal(this.view,
this.view.state.camera):this._get("camera")},set:function(a){this.updatePropertyBeforeReady("camera",a)||this.setStateCamera(e.externalToInternal(this.view,a),{applyConstraints:!1})||f.error("#camera\x3d","Invalid camera",a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"center",{get:function(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")},set:function(a){this.updatePropertyBeforeReady("center",a)||(a?this.isCompatible(a)?this.setStateCamera(this.centerToCamera(a),
{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.forceUpdate():f.error("#center\x3d","Invalid center",a):f.error("#center\x3d","Center has an incompatible spatial reference (center: "+(a.spatialReference?a.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",a):f.error("#center\x3d","Center may not be null or undefined"))},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"extent",{get:function(){return this.ready?e.toExtent(this.view,null,
null,null,E):this._get("extent")},set:function(a){this.updatePropertyBeforeReady("extent",a)||(a?this.isCompatible(a)?this.setStateCamera(this.extentToCamera(a),{applyConstraints:!0})||f.error("#extent\x3d","Invalid extent",a):f.error("#extent\x3d","Extent has an incompatible spatial reference (extent: "+(a.spatialReference?a.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",a):f.error("#extent\x3d","Extent may not be null or undefined"))},enumerable:!0,configurable:!0});
Object.defineProperty(b.prototype,"frustum",{get:function(){var a=this.propertiesPool.get("frustum");a.update(this.view.state.camera);return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"hasInitialView",{get:function(){return!!this.view.get("map.initialViewProperties.viewpoint")},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"scale",{get:function(){if(!this.ready)return this._get("scale");var a=this.view.pointsOfInterest.centerOnContent;return e.distanceToScale(this.view,
a.distance,a.location.latitude)},set:function(a){this.updatePropertyBeforeReady("scale",a)||this.setStateCamera(this.scaleToCamera(a),{applyConstraints:!0})||f.error("#scale\x3d","Invalid scale",a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"padding",{get:function(){if(!this.ready)return this._get("padding");var a=this.view.state.camera.padding;return{top:a[0],right:a[1],bottom:a[2],left:a[3]}},set:function(a){this.updatePropertyBeforeReady("padding",a)||(a?x.vec4d.set4(a.top||
0,a.right||0,a.bottom||0,a.left||0,y):x.vec4d.set4(0,0,0,0,y),this.view.state.updateCamera(function(a){a.padding=y}))},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"screenCenter",{get:function(){var a=this.padding;return new L((this.view.width-(a.left+a.right))/2+a.left,(this.view.height-(a.top+a.bottom))/2+a.top)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"viewpoint",{get:function(){return this.ready?t.fromCamera(this.view,this.camera):this._get("viewpoint")},
set:function(a){if(!this.updatePropertyBeforeReady("viewpoint",a))if(a)if(this.isCompatible(a))this.setStateCamera(this.viewpointToCamera(a),{applyConstraints:!a.camera})||f.error("#viewpoint\x3d","Invalid viewpoint",a);else{var c=a.camera?a.camera.position:a.targetGeometry,c=c&&c.spatialReference;f.error("#viewpoint\x3d","Viewpoint has an incompatible spatial reference (viewpoint: "+(c?c.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",a)}else f.error("#viewpoint\x3d","Viewpoint may not be null or undefined")},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"zoom",{get:function(){return this.ready?e.scaleToZoom(this.view,this.scale):this._get("zoom")},set:function(a){this.updatePropertyBeforeReady("zoom",a)||this.setStateCamera(this.zoomToCamera(a),{applyConstraints:!0})||f.error("#zoom\x3d","Invalid zoom",a)},enumerable:!0,configurable:!0});b.prototype.initialize=function(){var a=this;this.pickingHelper=new S.PickingHelper(this.view);this.handles.add(this.view.watch("state.camera",function(c){return a.cameraChangedSync(c)},
!0),p.on(this.view,"state.events","before-camera-change",function(c){return a.beforeCameraChangeHandle(c.camera)}));this.handles.add(this.view.on("resize",function(c){return a.handleResize(c.width,c.height)}));this.handles.add(this.view.watch("state.cameraController",function(){a.cameraSetByUser=!0;a.handles.remove(u);a.cancelImmediateGoTo()}));this.handles.add(p.on(this.view,"pointsOfInterest.events","camera-parameters-changed",function(){return a.notifyChange("scale")}))};b.prototype.destroy=function(){this.handles&&
(this.handles.destroy(),this.handles=null);this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null)};b.prototype.init=function(){var a=this;this.constraintsManager=new Q.default({view:this.view});this.handleResize(this.view.width,this.view.height);var c=this.getInitialProperties();this.cameraSetByUser=!1;this._set("ready",!0);for(var d=0;d<c.length;d++){var b=c[d];this.set(b.name,b.value)}this.cameraSetByUser||((c=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent)&&
this.isCompatible(c)?this.setInitialView(c):"local"===this.view.state.mode&&this.handles.add(p.whenOnce(this.view.basemapTerrain,"ready",function(){a.handles.remove(u);a.setInitialView(a.view.groundExtent)}),u))};b.prototype.deinit=function(){this.ready&&(this._override("padding",this.padding),this.cancelImmediateGoTo(),this.cancelAnimatedGoTo(),this._set("ready",!1),this._clearOverride("hasInitialView"),this.internalSetOrder.length=0,this.cameraSetByUser=!1,this.handles.remove(u),this.constraintsManager&&
(this.constraintsManager.destroy(),this.constraintsManager=null))};b.prototype.goTo=function(a,c){c=G.mixin({animate:!0},c);return c.animate?this.goToAnimated(a,c):this.goToImmediate(a,c)};b.prototype.debugSetCameraOnContent=function(){this.setStateCamera(C.cameraOnContentAlongViewDirection(this.view),{applyConstraints:!1})};b.prototype.step=function(a){var c=this.view.state,d=c&&this.view.state.cameraController;d&&(c.updateCamera(function(c){d.stepController(a,c)}),d.steppingFinished&&d.finishController())};
b.prototype.cancelImmediateGoTo=function(){var a=this.immediateGoToPromise;a&&(this.immediateGoToPromise=null,a.cancel())};b.prototype.cancelAnimatedGoTo=function(){var a=this.animatedGoToPromise;a&&(this.animatedGoToPromise=null,a.cancel())};b.prototype.getInitialProperties=function(){for(var a=this,c=new Set,d=[],b=0,g=T;b<g.length;b++){var e=g[b],f=e.propertyName,e=e.overrides,h=c.has(f),k=this._isOverridden(f);!h&&k&&d.push({name:f,value:this._get(f)});this._clearOverride(f);(h||k)&&e.forEach(function(a){return c.add(a)})}return d.sort(function(c,
d){c=a.internalSetOrder.indexOf(c.name);d=a.internalSetOrder.indexOf(d.name);return c<d?-1:c>d?1:0})};b.prototype.setInitialView=function(a){if(a&&!this.cameraSetByUser){var c={applyConstraints:!0};a instanceof m?c.applyConstraints=!1:a instanceof r?a.targetGeometry instanceof A?a=e.fromExtent(this.view,a.targetGeometry,0,.5,{noReset:!0}):(a.camera&&(c.applyConstraints=!1),a=t.toCamera(this.view,a)):a=e.fromExtent(this.view,a,0,.5,{noReset:!0});this.setStateCamera(e.externalToInternal(this.view,a),
c)}};b.prototype.updatePropertyBeforeReady=function(a,c){if(this.ready)return!1;this._override(a,c);var d=this.internalSetOrder.indexOf(a);-1!==d&&(this.internalSetOrder=this.internalSetOrder.splice(d,1));c&&(this.internalSetOrder.push(a),-1!==U.indexOf(a)&&this._override("hasInitialView",!0));return!0};b.prototype.isCompatible=function(a){return a?a instanceof r?a.camera?this.isCompatible(a.camera):this.isCompatible(a.targetGeometry):a instanceof m?this.isCompatible(a.position):a.spatialReference&&
M.canProject(a.spatialReference,this.view.spatialReference):!1};b.prototype.getPreservingHeadingTilt=function(a){void 0===a&&(a=V);this.cameraSetByUser?(a.heading=this.camera.heading,a.tilt=this.camera.tilt):(a.heading=0,a.tilt=.5);return a};b.prototype.centerPointAtDistanceToCamera=function(a,c,d){void 0===d&&(d=q);var b=this.getPreservingHeadingTilt();return(a=e.eyeHeadingTiltForCenterPointAtDistance(this.view,b.heading,b.tilt,a,c))?(d.copyFrom(this.view.state.camera),d.eye=a.eye,d.center=a.center,
d.up=a.up,d):null};b.prototype.centerToCamera=function(a){var c=this.view.pointsOfInterest.centerOnContent;c.forceUpdate();return this.centerPointAtDistanceToCamera(a,c.distance)};b.prototype.extentToCamera=function(a){var c=this.getPreservingHeadingTilt();if(a=e.fromExtent(this.view,a,c.heading,c.tilt,E))return e.externalToInternal(this.view,a)};b.prototype.scaleToCamera=function(a){var c=this.view.pointsOfInterest.centerOnContent;c.forceUpdate();var d=c.renderLocation;a=e.scaleToDistance(this.view,
a,c.location.latitude);return this.centerPointAtDistanceToCamera(d,a)};b.prototype.zoomToCamera=function(a){return this.scaleToCamera(e.zoomToScale(this.view,a))};b.prototype.viewpointToCamera=function(a){return(a=t.toCamera(this.view,a))?e.externalToInternal(this.view,a):null};b.prototype.setStateCamera=function(a,c){var d=this;if(!a||!this.view.state.stopActiveCameraController())return!1;this.cameraSetByUser=!0;this.cancelImmediateGoTo();this.view.state.updateCamera(function(b){b.copyFrom(a);c.applyConstraints&&
w.applyAll(d.view,b)});c.applyConstraints||(this.view.state.cameraController=new D.SurfaceCollisionCorrectionController({view:this.view,desiredCamera:a}));return!0};b.prototype.handleResize=function(a,c){var d=this.view.canvas;!d||d.width===a&&d.height===c||(d.width=a,d.height=c);this.view.state&&(d=this.view.state.camera,d.fullWidth!==a||d.fullHeight!==c)&&(q.copyFrom(d),q.fullWidth=a,q.fullHeight=c,this.view.state.camera=q)};b.prototype.beforeCameraChangeHandle=function(a){this.updateCameraAboveGround(a)};
b.prototype.cameraChangedSync=function(a){a&&this.view._stage&&this.view._stage.setCamera(a)};b.prototype.updateCameraAboveGround=function(a){var c=this.view.basemapTerrain,d=this.view.renderCoordsHelper.getAltitude(a.eye),c=c&&c.spatialReference?C.surfaceElevationBelowEye(this.view,a):0;a.aboveGround=d>=c};b.prototype.createGoToCamera=function(a){var c=this;return p.whenOnce(this,"ready",null,!0).then(function(){return t.create(c.view,a)}).then(function(d){var b=!!(a instanceof r&&a.camera||a instanceof
m),g=d.camera;if(!c.isCompatible(g))throw d=(d=g.position)&&d.spatialReference,new n("goto:incompatible-spatialreference","Resulting camera has an incompatible spatial reference (camera: "+(d?d.wkid:"none")+", view: "+c.view.spatialReference.wkid+")",{camera:g});g=e.externalToInternal(c.view,g);if(!g)throw new n("goto:invalid-camera","Resulting camera is invalid");return{viewpoint:d,camera:g,isFullySpecified:b}})};b.prototype.cancellableGoTo=function(a){var c=this,d;return z.create(function(c,b){d=
{resolve:c,reject:b};a.asyncResult=d},function(){c.view.state.cameraController===a&&a.active&&a.asyncResult===d&&a.stopController()})};b.prototype.goToImmediate=function(a,c){var b=this;this.cancelAnimatedGoTo();this.cancelImmediateGoTo();var e=this.createGoToCamera(a).then(function(a){b.immediateGoToPromise===e&&(b.immediateGoToPromise=null);b.setStateCamera(a.camera,{applyConstraints:!a.isFullySpecified})}).catch(function(a){b.immediateGoToPromise===e&&(b.immediateGoToPromise=null);a instanceof
n&&a.message&&f.error("#goTo()","Failed to create camera from target, "+a.message[0].toLowerCase()+a.message.slice(1));throw a;});return this.immediateGoToPromise=e};b.prototype.goToAnimatedBeforeReady=function(a,c){var b=this;this.cancelAnimatedGoTo();var e=p.whenOnce(this.view,"ready").then(function(){if(e===b.animatedGoToPromise)return b.animatedGoToPromise=null,b.goToAnimated(a,c);throw new n("view:goto-cancelled","Cancelled");});return this.animatedGoToPromise=e};b.prototype.goToAnimated=function(a,
c){var b=this;this.cancelAnimatedGoTo();if(!this.ready)return this.goToAnimatedBeforeReady(a,c);var e=this.view.state.cameraController,g;g=e instanceof B.PointToPointAnimationController&&e.active?e:new B.PointToPointAnimationController(this.view.state,this.pickingHelper);this.cancelAnimatedGoTo();var h=g.viewAnimation;a=this.createGoToCamera(a);var k=a.then(function(a){return a.viewpoint});h.update(k);if(g!==e&&!this.view.state.switchCameraController(g))return h.stop(),f.error("#goTo()","Cannot start an animation while interacting"),
z.reject(new n("view:goto-cannot-interrupt","Cannot start an animation while interacting"));var l=h.target,m=function(){return b.view.state.cameraController===g&&g.viewAnimation.target===l&&g.active};a.then(function(a){var d=a.viewpoint,e=a.camera;a=a.isFullySpecified;if(m()){g.viewAnimation.update(d);l=g.viewAnimation.target;var f;a?(f=new D.SurfaceCollisionCorrectionController({view:b.view,desiredCamera:e}),w.applySurfaceCollision(b.view,e,1)):w.applyAll(b.view,e);g.begin(e,b.internalAnimateOptions(c));
return h.when().then(function(){f&&g.viewAnimation.target===l&&(b.view.state.cameraController=f)})}}).otherwise(function(a){a instanceof n&&a.message&&f.error("#goTo()","Failed to create camera from target, "+a.message[0].toLowerCase()+a.message.slice(1));if(m())throw b.view.state.cameraController.stopController(),a;});return this.cancellableGoTo(g)};b.prototype.internalAnimateOptions=function(a){var b={};a&&(null!=a.speedFactor&&(b.speedFactor=a.speedFactor),null!=a.duration&&(b.duration=a.duration/
1E3),null!=a.maxDuration&&(b.maxDuration=a.maxDuration/1E3),null!=a.easing&&(b.easing="string"===typeof a.easing?N.named[a.easing]:a.easing));return b};k([h.property({type:m,dependsOn:["view.state.camera","ready"]})],b.prototype,"camera",null);k([h.property({type:K,dependsOn:["view.pointsOfInterest.centerOnContent.location","ready"]})],b.prototype,"center",null);k([h.property({type:A,dependsOn:["view.state.camera","ready"]})],b.prototype,"extent",null);k([h.property({readOnly:!0,dependsOn:["view.state.camera",
"ready"]})],b.prototype,"frustum",null);k([h.property({readOnly:!0,dependsOn:["view.map.initialViewProperties.viewpoint"]})],b.prototype,"hasInitialView",null);k([h.property({readOnly:!0,type:Boolean})],b.prototype,"ready",void 0);k([h.property({dependsOn:["view.pointsOfInterest.centerOnContent.distance","ready"],type:Number})],b.prototype,"scale",null);k([h.property({dependsOn:["view.state.camera","ready"]})],b.prototype,"padding",null);k([h.property({readOnly:!0,dependsOn:["view.width","view.height",
"padding"]})],b.prototype,"screenCenter",null);k([h.property({constructOnly:!0})],b.prototype,"view",void 0);k([h.property({type:r,dependsOn:["camera","ready"]})],b.prototype,"viewpoint",null);k([h.property({type:Number,dependsOn:["scale"]})],b.prototype,"zoom",null);return b=k([h.subclass("esri.views.3d.state.ViewStateManager")],b)}(h.declared(H));v.ViewStateManager=l;var U="camera viewpoint extent scale center zoom".split(" "),T=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",
overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"center",overrides:[]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],V={heading:0,tilt:0},E=new m,q=new R,y=x.vec4d.create(),u="pending-initial-view";v.default=l});