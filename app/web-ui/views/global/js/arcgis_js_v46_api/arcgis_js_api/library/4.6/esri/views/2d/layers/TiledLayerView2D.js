// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators ../../../core/ObjectPool ../../../core/Error ../../../core/promiseUtils ./LayerView2D ../tiling/TileInfoView ../tiling/TileKey ../tiling/TileQueue ../tiling/TileStrategy ../engine/Bitmap ../engine/BitmapSource ../engine/BitmapContainer ../engine/Canvas2DContainer ../engine/Tiled ../../layers/RefreshableLayerView".split(" "),function(A,B,e,k,f,l,g,m,n,p,q,r,
t,u,v,w,x,y,z){var h=function(d){function b(a){a=d.call(this,a)||this;a.key=new q(0,0,0,0);return a}e(b,d);b.prototype.acquire=function(a){};b.prototype.release=function(){this.key.set(0,0,0,0)};b.pool=new l(b,!0);return b}(y(u));return function(d){function b(){var a=null!==d&&d.apply(this,arguments)||this;a._tileStrategy=null;a._tileInfoView=null;a._fetchQueue=null;a._tileRequests=new Map;a.container=new x;a.layer=null;return a}e(b,d);b.prototype.initialize=function(){var a=this.layer.tileInfo,a=
a&&a.spatialReference,c;a||(c=new g("layerview:tiling-information-missing","The layer doesn't provide tiling information",{layer:this.layer}));a.equals(this.view.spatialReference)||(c=new g("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}));c&&this.addResolvingPromise(m.reject(c))};b.prototype.hitTest=function(a,c){return null};b.prototype.update=function(a){this._fetchQueue.pause();this._fetchQueue.state=
a.state;this._tileStrategy.update(a);this._fetchQueue.resume();this.notifyChange("updating")};b.prototype.attach=function(){var a=this;this._tileContainer=new w;this.container.addChild(this._tileContainer);this._tileInfoView=new p(this.layer.tileInfo,this.layer.fullExtent);this._fetchQueue=new r({tileInfoView:this._tileInfoView,process:function(c){return a.fetchTile(c)}});this._tileStrategy=new t({cachePolicy:"keep",acquireTile:function(c){return a.acquireTile(c)},releaseTile:function(c){return a.releaseTile(c)},
tileInfoView:this._tileInfoView})};b.prototype.detach=function(){this._tileStrategy.destroy();this._fetchQueue.clear();this.container.removeChild(this._tileContainer);this._fetchQueue=this._tileStrategy=this._tileInfoView=this._tileContainer=null};b.prototype.moveStart=function(){this.requestUpdate()};b.prototype.viewChange=function(){this.requestUpdate()};b.prototype.moveEnd=function(){this.requestUpdate()};b.prototype.doRefresh=function(){var a=this;this.updateRequested||this.suspended||(this._fetchQueue.reset(),
this._tileStrategy.tiles.forEach(function(c){return a._enqueueTileFetch(c)}),this.notifyChange("updating"))};b.prototype.isUpdating=function(){var a=!0;this._tileRequests.forEach(function(c){a=a&&c.isFulfilled()});return!a};b.prototype.getTileBounds=function(a,c){return this._tileStrategy.tileInfoView.getTileBounds(a,c)};b.prototype.getTileCoords=function(a,c){return this._tileStrategy.tileInfoView.getTileCoords(a,c)};b.prototype.getTileResolution=function(a){return this._tileStrategy.tileInfoView.getTileResolution(a)};
b.prototype.acquireTile=function(a){var c=h.pool.acquire();c.key.set(a);this._tileInfoView.getTileCoords(c.coords,c.key);c.resolution=this._tileInfoView.getTileResolution(c.key);a=this._tileInfoView.tileInfo.size;c.width=a[0];c.height=a[1];this._enqueueTileFetch(c);this.requestUpdate();return c};b.prototype.releaseTile=function(a){var c=this,b=this._tileRequests.get(a);b&&!b.isFulfilled()&&b.cancel();this._tileRequests.delete(a);this._tileContainer.removeChild(a);a.once("detach",function(){h.pool.release(a);
c.requestUpdate()});this.requestUpdate()};b.prototype.fetchTile=function(a){var c=this,b=this.layer.tilemapCache;if(b){var d=a.level,e=a.row,f=a.col;return b.fetchAvailabilityUpsample(d,e,f,a).then(function(){return c._fetchImage(a)}).otherwise(function(){a.level=d;a.row=e;a.col=f;return c._fetchImage(a)})}return this._fetchImage(a)};b.prototype._enqueueTileFetch=function(a){var c=this;if(!this._fetchQueue.has(a.key)){var b=this._fetchQueue.push(a.key).then(function(b){a.source=b;a.once("attach",
function(){return c.requestUpdate()});c._tileContainer.addChild(a);c.requestUpdate()});this._tileRequests.set(a,b)}};b.prototype._fetchImage=function(a){var c=this;return this.layer.fetchTile(a.level,a.row,a.col,{timestamp:this.refreshTimestamp}).then(function(b){b=v.pool.acquire(b);b.coords=c.getTileCoords(b.coords,a);b.resolution=c.getTileResolution(a);return b})};return b=k([f.subclass("esri.views.2d.layers.TiledLayerView2D")],b)}(f.declared(n,z))});