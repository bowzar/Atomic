// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../libs/gl-matrix/common ../libs/gl-matrix/vec2 ../libs/gl-matrix/mat2d ./webgl/BitBlitRenderer ../../support/screenshotUtils ../../../core/promiseUtils ../../webgl/RenderingContext ../../webgl/FramebufferObject ../../webgl/webgl-utils ../../webgl/Program ../../webgl/VertexArrayObject ../../webgl/BufferObject ./webgl/painter/WGLPainter ./Container ./webgl/shaders/glShaderSnippets".split(" "),function(N,O,B,C,n,v,D,E,F,G,y,H,I,J,z,K,L,A){function w(n){return{budget:n.budget,
state:n.state,devicePixelRatio:n.devicePixelRatio,stationary:n.stationary}}var M={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"};return function(r){function c(){var a=null!==r&&r.apply(this,arguments)||this;a._clipData=new Float32Array(8);a._upperLeft=n.create();a._upperRight=n.create();a._lowerLeft=n.create();a._lowerRight=n.create();a._mat2=v.create();a._clipRendererInitialized=!1;return a}B(c,r);Object.defineProperty(c.prototype,"glPainter",{get:function(){return this._painter},enumerable:!0,
configurable:!0});c.prototype.createElement=function(){var a=document.createElement("canvas");a.setAttribute("class","esri-display-object");return a};c.prototype.setElement=function(a){this.element=a};c.prototype.attach=function(a){if(this.attached)return!0;this._resizeCanvas(a);var b=H.setupWebGL(this.element,{alpha:!0,antialias:!1,depth:!0,stencil:!0});this._renderingContext=new G(b[0]);this.attached=!0;this._cachedRenderParams=w(a);this._painter||(this._painter=new K,this._painter.initialize(this._renderingContext));
return r.prototype.attach.call(this,a)};c.prototype.detach=function(a){r.prototype.detach.call(this,a);this._renderingContext&&(this._renderingContext.dispose(),this._renderingContext=null);this._cachedRenderParams=null};c.prototype.beforeRenderChildren=function(a,b){var k=a.state,d=this._painter;if(d)if(b=this._renderingContext,b.enforceState(),d.update(k,a.devicePixelRatio),k.spatialReference&&(k.spatialReference._isWrappable?k.spatialReference._isWrappable():k.spatialReference.isWrappable)){var e=
k.width,d=k.height,l=k.rotation,e=Math.round(e*a.devicePixelRatio),d=Math.round(d*a.devicePixelRatio),x=C.toRadian(l),m=Math.abs(Math.cos(x)),g=Math.abs(Math.sin(x)),c=Math.round(k.worldScreenWidth);if(Math.round(e*m+d*g)<=c)this._clipFrame=!1;else{this._clipFBO&&this._clipFBO.width===e&&this._clipFBO.height===d||(this._clipFBO=new y(b,{colorTarget:0,depthStencilTarget:3,width:e,height:d}));var r=.5*e,f=.5*d,k=1/e,q=1/d;a=.5*c*a.devicePixelRatio;var u=.5*(e*g+d*m),e=this._upperLeft,m=this._upperRight,
g=this._lowerLeft,c=this._lowerRight;n.set(e,-a,-u);n.set(m,a,-u);n.set(g,-a,u);n.set(c,a,u);v.identity(this._mat2);v.translate(this._mat2,this._mat2,[r,f]);0!==l&&v.rotate(this._mat2,this._mat2,x);n.transformMat2d(e,e,this._mat2);n.transformMat2d(m,m,this._mat2);n.transformMat2d(g,g,this._mat2);n.transformMat2d(c,c,this._mat2);l=this._clipData;l.set([2*g[0]*k-1,2*(d-g[1])*q-1,2*c[0]*k-1,2*(d-c[1])*q-1,2*e[0]*k-1,2*(d-e[1])*q-1,2*m[0]*k-1,2*(d-m[1])*q-1]);this._clipRendererInitialized||this._initializeClipRenderer(b);
this._clipVBO.setData(l);this._boundFBO=b.getBoundFramebufferObject();b.bindFramebuffer(this._clipFBO);b.setDepthWriteEnabled(!0);b.setStencilWriteMask(255);b.setClearColor(0,0,0,0);b.setClearDepth(1);b.setClearStencil(0);b.clear(b.gl.COLOR_BUFFER_BIT|b.gl.DEPTH_BUFFER_BIT|b.gl.STENCIL_BUFFER_BIT);b.setDepthWriteEnabled(!1);this._clipFrame=!0}}else this._clipFrame=!1};c.prototype.afterRenderChildren=function(a,b){this._clipFrame&&this._clipRendererInitialized&&(a=this._renderingContext,a.bindFramebuffer(this._boundFBO),
this._boundFBO=null,a.bindVAO(this._clipVAO),a.bindProgram(this._clipStencilProgram),a.setDepthWriteEnabled(!1),a.setDepthTestEnabled(!1),a.setStencilTestEnabled(!0),a.setBlendingEnabled(!1),a.setColorMask(!1,!1,!1,!1),a.setStencilOp(7680,7680,7681),a.setStencilWriteMask(255),a.setStencilFunction(519,1,255),a.drawElements(4,6,5123,0),a.bindVAO(),a.setColorMask(!0,!0,!0,!0),a.setBlendingEnabled(!0),a.setStencilFunction(514,1,255),this._blitRenderer.render(a,this._clipFBO.colorTexture,9728,1),a.setStencilTestEnabled(!1))};
c.prototype.doRender=function(a){var b=this.element.style;this.visible?(b.display="block",b.opacity=""+this.opacity,this._resizeCanvas(a),r.prototype.doRender.call(this,a),this._cachedRenderParams=w(a)):b.display="none"};c.prototype.takeScreenshot=function(a){void 0===a&&(a={});var b=a.pixelRatio||1;this._cachedRenderParams.devicePixelRatio=b;var k=Math.round(b*this._cachedRenderParams.state.width),d=Math.round(b*this._cachedRenderParams.state.height),e=0,l=0,c=k,m=d,g=k,n=d;if(g=a.area)e=Math.round(b*
g.x),l=Math.round(b*g.y),c=Math.round(b*g.width),m=Math.round(b*g.height);void 0!==a.width&&void 0!==a.height?(g=a.width/a.height,m*g<c?(g*=m,e+=Math.floor((c-g)/2),c=Math.floor(g)):(g=c/g,l+=Math.floor((m-g)/2),m=Math.floor(g)),g=a.width,n=a.height):(g=c,n=m);b=document.createElement("canvas");b.width=g;b.height=n;var r=b.getContext("2d"),f=new Uint8Array(c*m*4),q=this._renderingContext,u=y.create(q,{colorTarget:1,depthStencilTarget:3,width:k,height:d});q.bindFramebuffer(u);q.setViewport(0,0,k,d);
this._cachedRenderParams.budget&&this._cachedRenderParams.budget.reset(Number.MAX_VALUE);var h=this._cachedRenderParams,p=this._renderingContext.gl;this._renderingContext.setClearColor(0,0,0,0);this._renderingContext.setClearDepth(1);this._renderingContext.setClearStencil(0);this._renderingContext.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT|p.STENCIL_BUFFER_BIT);h.context=this._renderingContext;this.beforeRenderChildren(h,h);if(void 0!==a.rotation&&null!==a.rotation){var p=h.state,t=p.clone();t.viewpoint.rotation=
a.rotation;h.state=t;this.renderChildren(h);h.state=p}else this.renderChildren(h);this.afterRenderChildren(h,h);u.readPixels(e,d-(l+m),c,m,6408,5121,f);q.bindFramebuffer();q=r.getImageData(0,0,g,n);if(0!==e||0!==l||c!==k||m!==d||g!==k||n!==d)E.resampleHermite(f,c,m,q.data,g,n,!0);else{l=m-1;m=0;u=4*c;for(t=p=e=d=k=c=h=void 0;m<l;){p=m*u;t=l*u;for(h=0;h<u;h+=4)c=f[p+h],k=f[p+h+1],d=f[p+h+2],e=f[p+h+3],f[p+h]=f[t+h],f[p+h+1]=f[t+h+1],f[p+h+2]=f[t+h+2],f[p+h+3]=f[t+h+3],f[t+h]=c,f[t+h+1]=k,f[t+h+2]=
d,f[t+h+3]=e;m++;l--}c=q.data;k=f.length;for(l=0;l<k;l++)c[l]=f[l]}f=q.data;m=f.length;for(l=0;l<m;l+=4)e=f[l+3],0<e&&(d=e/255,c=Math.floor(f[l+0]/d),k=Math.floor(f[l+1]/d),d=Math.floor(f[l+2]/d),f[l+0]=255>=c?c:255,f[l+1]=255>=k?k:255,f[l+2]=255>=d?d:255);r.putImageData(q,0,0);r=M[a.format?a.format.toLowerCase():"png"];f=1;void 0!==a.quality&&(f=a.quality/100);a=b.toDataURL(r,f);return F.resolve({dataURL:a,x:0,y:0,width:g,height:n})};c.prototype.prepareChildrenRenderParameters=function(a){if(!this.attached||
!this._renderingContext)return null;a=w(a);var b=this._renderingContext,c=b.gl;b.setDepthWriteEnabled(!0);b.setStencilWriteMask(255);b.setClearColor(0,0,0,0);b.setClearDepth(1);b.setClearStencil(0);b.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT|c.STENCIL_BUFFER_BIT);b.setViewport(0,0,this.element.width,this.element.height);b.setDepthWriteEnabled(!1);a.context=b;return a};c.prototype.attachChild=function(a,b){return a.attach(b)};c.prototype.detachChild=function(a,b){return a.detach(b)};c.prototype.renderChild=
function(a,b){return a.processRender(b)};c.prototype._resizeCanvas=function(a){var b=this.element,c=b.style,d=a.state,e=a.devicePixelRatio;a=Math.round(d.width*e);e=Math.round(d.height*e);if(b.width!==a||b.height!==e)b.width=a,b.height=e;c.width=d.width+"px";c.height=d.height+"px"};c.prototype._initializeClipRenderer=function(a){if(this._clipRendererInitialized)return!0;this._blitRenderer=new D;var b={a_pos:0},c=new I(a,A.stencilVS,A.stencilFS,b);if(!c)return!1;var d=z.createVertex(a,35040,32),e=
new Uint16Array([0,1,2,2,1,3]),e=z.createIndex(a,35044,e);a=new J(a,b,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:d},e);this._clipStencilProgram=c;this._clipVBO=d;this._clipVAO=a;return this._clipRendererInitialized=!0};return c}(L)});