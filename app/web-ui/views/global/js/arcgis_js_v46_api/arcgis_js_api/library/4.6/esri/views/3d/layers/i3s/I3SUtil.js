// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../../../request ../../../../core/promiseUtils ../../../../core/Error ../../../../core/urlUtils ../../../../geometry/SpatialReference ../../../../geometry/support/webMercatorUtils ../../../../tasks/QueryTask ../../../../tasks/support/Query ../../support/projectionUtils ../../lib/glMatrix ../../webgl-engine/lib/Util ./I3SBinaryReader".split(" "),function(Y,h,I,l,m,J,z,K,L,M,w,u,N,O){function x(a){return a&&parseInt(a.substring(a.lastIndexOf("/")+1,a.length),10)}function A(a,
b,c,d,f,g){if(null!=c){var e=P;w.mbsToMbs(c.mbs,d,e,b);if(0!==B(a,e)){g.push(c);for(var e=null!=c.children?c.children.length:0,q=0;q<e;q++)A(a,b,f[c.children[q].id],d,f,g)}}}function B(a,b){var c=b[0],d=b[1],f=b[2];b=b[3];var g=0;if(c<a[0])var e=a[0]-c,g=g+e*e;d<a[1]&&(e=a[1]-d,g+=e*e);f<a[2]&&(e=a[2]-f,g+=e*e);c>a[3]&&(e=c-a[3],g+=e*e);d>a[4]&&(e=d-a[4],g+=e*e);f>a[5]&&(e=f-a[5],g+=e*e);if(g>b*b)return 0;if(0<g)return 1;g=Infinity;c-a[0]<g&&(g=c-a[0]);d-a[1]<g&&(g=d-a[1]);f-a[2]<g&&(g=f-a[2]);a[3]-
c<g&&(g=a[3]-c);a[4]-d<g&&(g=a[4]-d);a[5]-f<g&&(g=a[5]-f);return g>b?2:1}function y(a,b,c){var d=[],f=c&&c.missingFields;c=c&&c.originalFields;for(var g=0;g<a.length;g++){for(var e=a[g],q=e.toLowerCase(),h=!1,r=0,p=b;r<p.length;r++){var k=p[r];if(q===k.name.toLowerCase()){d.push(k.name);h=!0;c&&c.push(e);break}}!h&&f&&f.push(e)}return d}function Q(a,b){return a.filter(function(a){return a.toLowerCase()!==b.toLowerCase()}).concat([b])}function R(a,b,c,d){b.sort(function(a,b){return a.attributes[c]-
b.attributes[c]});var f=b.map(function(a){return a.attributes[c]}),g=[],e=y(d,a.fields,{originalFields:g});return C(a,f,e).then(function(a){for(var c=0;c<b.length;c++){var f=b[c],d=a[c];f.attributes={};for(var k=0;k<g.length;k++)f.attributes[g[k]]=d[e[k]]}return b})}function S(a,b){for(var c=[],d=0;d<a.length;d++){var f=a[d];f in b.attributes||c.push(f)}return c}function C(a,b,c){if(null!=a.maxRecordCount&&b.length>a.maxRecordCount){var d=T(b,a.maxRecordCount);return l.all(d.map(function(b){return C(a,
b,c)})).then(U)}d=new M({objectIds:b,outFields:c,orderByFields:[a.objectIdField]});return(new L(a.parsedUrl.path)).execute(d).then(function(a){return a&&a.features&&a.features.length===b.length?a.features.map(function(a){return a.attributes}):l.reject(new m("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer"))})}function V(a,b,c,d,f){for(var g=[],e=0;e<b.attributeData.length;e++){var h=b.attributeData[e],n=a[e];n&&-1!==d.indexOf(n.name)&&(h=J.makeAbsolute(h.href,
b.baseUrl),g.push({url:h,storageInfo:n}))}return l.eachAlways(g.map(function(a){return I(a.url,{responseType:"array-buffer"}).then(function(b){return O.readBinaryAttribute(a.storageInfo,b.data)})})).then(function(a){var b=[];if(!f.ignoreUnavailableFields&&a.some(function(a){return null==a.value})){for(var b=[],d=0;d<a.length;d++)null==a[d].value&&b.push({name:g[d].storageInfo.name,error:a[d].error});return l.reject(new m("scenelayer:attribute-request-failed","Request for scene layer attributes failed",
{failedAttributes:b}))}for(var e=0;e<c.length;e++){for(var h=c[e],q={},d=0;d<a.length;d++)null!=a[d].value&&(q[g[d].storageInfo.name]=E(a[d].value,h));b.push(q)}return b})}function E(a,b){b=a[b];return a instanceof Int16Array?b===W?null:b:a instanceof Int32Array?b===X?null:b:b!==b?null:b}function T(a,b){var c=a.length;b=Math.ceil(c/b);for(var d=[],f=0;f<b;f++)d.push(a.slice(Math.floor(c*f/b),Math.floor(c*(f+1)/b)));return d}function U(a){for(var b=[],c=0;c<a.length;c++)b=b.concat(a[c]);return b}function F(a){var b=
new z(x(a.store.indexCRS||a.store.geographicCRS));return b.equals(a.spatialReference)?a.spatialReference:b}function G(a){var b=new z(x(a.store.vertexCRS||a.store.projectedCRS));return b.equals(a.spatialReference)?a.spatialReference:b}function v(a,b,c){if(!K.canProject(a,b))throw new m("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===c&&a.isGeographic)throw new m("layerview:local-gcs-not-supported",
"Geographic coordinate systems are not supported in local scenes",{});}function H(a,b,c){var d=F(a);a=G(a);v(d,b,c);v(a,b,c)}Object.defineProperty(h,"__esModule",{value:!0});h.DDS_ENCODING_STRING="image/vnd-ms.dds";h.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"];h.extractWkid=x;h.processNormals=function(a,b,c){switch(b){case "none":var d=a.normals,f=a.positions;b=a.normalInd;c=a.positionInd;N.assert(a.normalInd.length===a.positionInd.length);a=u.vec3d.create();for(var g=u.vec3d.create(),
e=f.data,h=f.offsetIdx,f=f.strideIdx,n=d.data,m=d.offsetIdx,d=d.strideIdx,p=0;p<c.length;p+=3){var k=c[p],k=h+f*k,t=e[k],l=e[k+1],D=e[k+2],k=c[p+1],k=h+f*k;a[0]=e[k]-t;a[1]=e[k+1]-l;a[2]=e[k+2]-D;k=c[p+2];k=h+f*k;g[0]=e[k]-t;g[1]=e[k+1]-l;g[2]=e[k+2]-D;u.vec3d.cross(a,g,a);u.vec3d.normalize(a);for(t=0;3>t;t++)l=m+d*b[p+t],n[l]=a[0],n[l+1]=a[1],n[l+2]=a[2]}break;case "east-north-up":break;case "earth-centered":c(a.normals,w.SphericalECEFSpatialReference);break;case "vertex-reference-frame":break;default:throw Error("Received unexpected normalReferenceFrame: "+
b);}};h.getAppropriateTextureEncoding=function(a,b){if(Array.isArray(a)){if(b&&(b=a.indexOf(h.DDS_ENCODING_STRING),-1<b))return b;for(b=0;b<a.length;b++)if(-1<h.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(a[b]))return b;throw Error("Could not find appropriate texture encoding (among "+a.toString()+")");}return-1};h.findIntersectingNodes=A;var P=u.vec4d.create();h.intersectBoundingBoxWithMbs=B;h.findFieldsCaseInsensitive=y;h.whenGraphicAttributes=function(a,b,c,d,f,g){var e=!0===(g&&g.populateObjectId),
h=g.ignoreUnavailableFields?void 0:[],n=1===d.length&&"*"===d[0];!n&&e&&(d=Q(d,c));d=n?d:y(d,a.fields,{missingFields:h});if(h&&0!==h.length)return l.reject(new m("scenelayer:unknown-fields","This scene layer does not have the requested fields",{unknownFields:h}));if(0===b.length)return l.resolve(b);var e=a.associatedLayer,h=a.attributeStorageInfo,r=n?a.fields.map(function(a){return a.name}):d;if(e)return R(e,b,c,r);a=S(r,b[0]);return 0===a.length?l.resolve(b):h?(f=f(),null==f?l.reject(new m("scenelayer:feature-not-loaded",
"Tried to query attributes for unloaded features")):V(h,f.node,f.indices,a,g).then(function(a){for(var c=0;c<b.length;c++){for(var d=0,e=r;d<e.length;d++){var f=e[d];f in a[c]||(a[c][f]=b[c].attributes[f])}b[c].attributes=a[c]}return b})):l.reject(new m("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))};var W=-Math.pow(2,15),X=-Math.pow(2,31);h.getCachedAttributeValue=E;h.convertFlatRangesToOffsets=function(a,b,c){void 0===c&&(c=2);b=null!=b?b:a.length/
c;for(var d=new Uint32Array(b+1),f=0;f<b;f++){var g=a[f*c];d[f]=3*g;var e=(f-1)*c+1;if(0<=e&&g-1!==a[e])throw new m("Face ranges are not continuous");}d[d.length-1]=3*(a[(b-1)*c+1]+1);return d};h.getIndexCrs=F;h.getVertexCrs=G;h.getCacheKeySuffix=function(a,b){return b===w.SphericalECEFSpatialReference?"@ECEF":a.equals(b)?"":null!=b.wkid?"@"+b.wkid:null};h.checkSpatialReference=v;h.checkSpatialReferences=H;h.checkSceneLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||
(a=a.store.defaultGeometrySchema,b=!!(null!=a.geometryType&&"triangles"!==a.geometryType||null!=a.topology&&"PerAttributeArray"!==a.topology||null==a.vertexAttributes||null==a.vertexAttributes.position));if(b)throw new m("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{});};h.checkSceneLayerCompatibleWithView=function(a,b){H(a,b.spatialReference,b.viewingMode)};h.checkPointCloudLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||
(a=a.store.defaultGeometrySchema,b=!!(null==a.geometryType||"points"!==a.geometryType||null!=a.topology&&"PerAttributeArray"!==a.topology||null!=a.encoding&&""!==a.encoding&&"lepcc-xyz"!==a.encoding||null==a.vertexAttributes||null==a.vertexAttributes.position));if(b)throw new m("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});};h.checkPointCloudLayerCompatibleWithView=function(a,b){v(a.spatialReference,b.spatialReference,b.viewingMode)};
h.encodeSymbolColor=function(a,b,c){null==a||"ignore"===b?(c[0]=255,c[1]=255,c[2]=255,c[3]=255):(c[0]=Math.floor(255*a[0]),c[1]=Math.floor(255*a[1]),c[2]=Math.floor(255*a[2]),a=Math.floor(85*a[3]),c[3]=0===a?0:"tint"===b?a:"replace"===b?a+85:a+170)};h.rendererNeedsTextures=function(a){if(null==a||"simple"!==a.type&&"class-breaks"!==a.type&&"unique-value"!==a.type||("unique-value"===a.type||"class-breaks"===a.type)&&null==a.defaultSymbol)return!0;a=a.getSymbols();if(0===a.length)return!0;for(var b=
0;b<a.length;b++){var c=a[b];if("mesh-3d"!==c.type||0===c.symbolLayers.length)return!0;for(var d=0,c=c.symbolLayers.items;d<c.length;d++){var f=c[d];if("fill"!==f.type||null==f.material||"replace"!==f.material.colorMixMode)return!0}}return!1}});