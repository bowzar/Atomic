// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/assignHelper ../../core/Collection ../../core/Error ../../core/HandleRegistry ../../core/promiseUtils ../../core/watchUtils ../../geometry/geometryEngine ../../geometry/support/webMercatorUtils ../../support/Action ../support/AnchorElementViewModel ../../core/accessorSupport/decorators".split(" "),function(e,x,n,d,y,m,k,p,l,g,q,r,h,t,c){function u(c,b){return b.allLayerViews.find(function(a){return a.layer===
c})}e=new h({id:"zoom-to"});var v=new (m.ofType(h))([e]);return function(e){function b(a){a=e.call(this)||this;a._handles=new p;a._originalActions=null;a.actions=v;a.goToOptions=null;a.autoCloseEnabled=!1;a.content=null;a.highlightEnabled=!0;a.title=null;a.updateLocationEnabled=!0;a.view=null;a.visible=!1;a.zoomFactor=4;return a}n(b,e);b.prototype.initialize=function(){this._handles.add([this.on("view-change",this._autoClose),g.watch(this,["highlightEnabled","selectedFeature","visible","view"],this._highlightFeature),
g.watch(this,"selectedFeature.popupTemplate.actions",this._getSelectedFeatureActions),g.watch(this,"selectedFeature.popupTemplate.overwriteActions",this._getSelectedFeatureActions)])};b.prototype.destroy=function(){this._handles.destroy();this.view=this._handles=null};Object.defineProperty(b.prototype,"featureCount",{get:function(){return this.features.length},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"features",{get:function(){return this._get("features")||[]},set:function(a){a=
a||[];this._set("features",a);var b=this.pendingPromisesCount,f=this.selectedFeatureIndex,c=this.promiseCount&&a.length;c&&b&&-1===f?this.selectedFeatureIndex=0:c&&-1!==f||(this.selectedFeatureIndex=a.length?0:-1)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"location",{get:function(){return this._get("location")||null},set:function(a){var b=this.get("location"),f=this.get("view.spatialReference.isWebMercator");a&&a.get("spatialReference.isWGS84")&&f&&(a=r.geographicToWebMercator(a));
this._set("location",a);a!==b&&this._centerAtLocation()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"pendingPromisesCount",{get:function(){return this.promises.filter(function(a){return a&&!a.isFulfilled()}).length},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"waitingForResult",{get:function(){return 0<this.pendingPromisesCount&&0===this.featureCount},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"promiseCount",{get:function(){return this.promises.length},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"promises",{get:function(){return this._get("promises")||[]},set:function(a){var b=this;this._get("promises").forEach(function(a){a.cancel()});this.features=[];this._set("promises",a);a.length&&(a=a.slice(0),a.forEach(function(a){a.always(function(w){b.notifyChange("pendingPromisesCount");b._updateFeatures(a,w)})}),l.eachAlways(a).then(function(){b.featureCount||(b.visible=!1)}))},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"selectedFeature",{get:function(){var a=this.selectedFeatureIndex;if(-1===a)return null;a=this.features[a];if(!a)return null;this.updateLocationEnabled&&(this.location=this._getPointFromGeometry(a.geometry));return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"selectedFeatureIndex",{get:function(){var a=this._get("selectedFeatureIndex");return"number"===typeof a?a:-1},set:function(a){var b=this.featureCount;a=isNaN(a)||-1>a||!b?-1:(a+b)%b;this._set("selectedFeatureIndex",a)},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"state",{get:function(){return this.get("view.ready")?"ready":"disabled"},enumerable:!0,configurable:!0});b.prototype.centerAtLocation=function(){var a=this.location,b=this.view;return a&&b?b.goTo({target:a,scale:b.scale},this.goToOptions):l.reject(new k(this.declaredClass+"::Cannot center at location without a location and view."))};b.prototype.clear=function(){this.set({promises:[],features:[],content:null,title:null,location:null})};
b.prototype.triggerAction=function(a){(a=this.actions.getItemAt(a))&&this.emit("trigger-action",{action:a})};b.prototype.next=function(){this.selectedFeatureIndex+=1;return this};b.prototype.previous=function(){--this.selectedFeatureIndex;return this};b.prototype.zoomToLocation=function(){var a=this,b=this.location,f=this.selectedFeature,c=this.view,d=this.zoomFactor;if(!b||!c)return l.reject(new k(this.declaredClass+"::Cannot zoom to location without a location and view."));var d=c.scale/d,e=this.get("selectedFeature.geometry"),
g=f&&"3d"===c.type,b=(g=e||g)?f:b,h=g&&e&&"point"===e.type&&this._isScreenSize(f);return c.goTo({target:b,scale:h?d:void 0},this.goToOptions).then(function(){h&&"point"===e.type&&(a.location=e)})};b.prototype._autoClose=function(){this.autoCloseEnabled&&(this.visible=!1)};b.prototype._isScreenSize=function(a){var b=this.view;return"3d"!==b.type||"esri.Graphic"!==a.declaredClass?!0:(b=b.getViewForGraphic(a))&&b.whenGraphicBounds?b.whenGraphicBounds(a).then(function(a){return!a||a[0]===a[3]&&a[1]===
a[4]&&a[2]===a[5]}):!0};b.prototype._getSelectedFeatureActions=function(){this._originalActions&&(this.actions=this._originalActions,this._originalActions=null);var a=this.actions.filter(function(a){return!a.temporary}),b=this.get("selectedFeature.popupTemplate");b&&b.overwriteActions&&(this._originalActions=a);this.actions=this._getNewActions(b,a)};b.prototype._getNewActions=function(a,b){if(!a||!a.actions)return b;var c=a.actions;c.forEach(function(a){a.temporary=!0});return a.overwriteActions?
c:b.concat(c)};b.prototype._getPointFromGeometry=function(a){return a?"point"===a.type?a:"extent"===a.type?a.center:"polygon"===a.type?a.centroid:"multipoint"===a.type||"polyline"===a.type?a.extent.center:null:null};b.prototype._centerAtLocation=function(){var a=this.location,b=this.updateLocationEnabled,c=this.get("view.extent");b&&c&&a&&!q.contains(c,a)&&this.centerAtLocation()};b.prototype._highlightFeature=function(){this._handles.remove("highlight");var a=this.selectedFeature,b=this.highlightEnabled,
c=this.view,d=this.visible;a&&c&&b&&d&&(b=a.layer)&&(c=u(b,c))&&"function"===typeof c.highlight&&(b=b.objectIdField,d=a.attributes,a=c.highlight(d&&d[b]||a,{}),this._handles.add(a,"highlight"))};b.prototype._updateFeatures=function(a,b){var c=this.features;a&&b&&b.length&&!(!this._validatePromise(a)||b instanceof k||b instanceof Error)&&(c.length?(a=b.filter(function(a){return-1===c.indexOf(a)}),this.features=c.concat(a)):this.features=b)};b.prototype._validatePromise=function(a){return!a.isCanceled()&&
-1<this.promises.indexOf(a)};d([c.property({type:m.ofType(h)})],b.prototype,"actions",void 0);d([c.property()],b.prototype,"goToOptions",void 0);d([c.property()],b.prototype,"autoCloseEnabled",void 0);d([c.property()],b.prototype,"content",void 0);d([c.property({readOnly:!0,dependsOn:["features"]})],b.prototype,"featureCount",null);d([c.property()],b.prototype,"features",null);d([c.property()],b.prototype,"highlightEnabled",void 0);d([c.property()],b.prototype,"location",null);d([c.property({readOnly:!0,
dependsOn:["promises"]})],b.prototype,"pendingPromisesCount",null);d([c.property({readOnly:!0,dependsOn:["featureCount","pendingPromisesCount"]})],b.prototype,"waitingForResult",null);d([c.property({readOnly:!0,dependsOn:["promises"]})],b.prototype,"promiseCount",null);d([c.property()],b.prototype,"promises",null);d([c.property({value:null,readOnly:!0,dependsOn:["features","selectedFeatureIndex","updateLocationEnabled"]})],b.prototype,"selectedFeature",null);d([c.property({value:-1})],b.prototype,
"selectedFeatureIndex",null);d([c.property({readOnly:!0,dependsOn:["view.ready"]})],b.prototype,"state",null);d([c.property()],b.prototype,"title",void 0);d([c.property()],b.prototype,"updateLocationEnabled",void 0);d([c.property()],b.prototype,"view",void 0);d([c.property()],b.prototype,"visible",void 0);d([c.property()],b.prototype,"zoomFactor",void 0);d([c.property()],b.prototype,"centerAtLocation",null);d([c.property()],b.prototype,"clear",null);d([c.property()],b.prototype,"triggerAction",null);
d([c.property()],b.prototype,"next",null);d([c.property()],b.prototype,"previous",null);d([c.property()],b.prototype,"zoomToLocation",null);return b=d([c.subclass("esri.widgets.Popup.PopupViewModel")],b)}(c.declared(t))});